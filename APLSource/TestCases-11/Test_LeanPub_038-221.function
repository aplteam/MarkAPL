 R←Test_LeanPub_038(stopFlag batchFlag);⎕TRAP;ns;md;parms;expected
⍝ Test the leanpub extension "highlight lines of code" when the code block contains `</span>`
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')
 R←∆Failed

 md←''
 md,←⊂'A para'
 md,←⊂''
 md,←⊂'~~~'
 md,←⊂''
 md,←⊂'leanpub-start-insert  '
 md,←⊂'{(+⌿⍵)÷≢⍵}'
 md,←⊂'</span>'
 md,←⊂'leanpub-end-insert  '
 md,←⊂'~~~'
 md,←⊂''
 md,←⊂'Another para'

 parms←##.MarkAPL.CreateParms
 parms.leanpubExtensions←1
 parms.createFullHtmlPage←1
 parms.screenCSS←'Dark_Screen.css'
 parms.printCSS←'Dark_Print.css'

 ns←##.MarkAPL.Init parms md
 ns←##.MarkAPL.Process ns

 expected←'<p>A para</p>' '<pre><code>' '<span class="leanpub_code">{(+⌿⍵)÷≢⍵}' '&lt;/span&gt;' '</span></code></pre>' '<p>Another para</p>'
 →PassesIf expected≡ns.html

 R←∆OK
