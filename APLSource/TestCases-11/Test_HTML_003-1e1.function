 R←Test_HTML_003(stopFlag batchFlag);⎕TRAP;md;ns
⍝ Test <? ?> tags.
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')
 R←∆Failed

⍝ Not an HTML block: trailing blank line missing:
 md←'This is a para.' '' '<?This?>' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf∨/'<p>&lt;?This?&gt; Another para</p>'⍷∊ns.html

⍝ Not an HTML block: leading blank line missing:
 md←'This is a para.' '<?' 'This' 'That' '?>' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(⊂'<p>This is a para. &lt;? This That ?&gt;</p>')∊ns.html

⍝ Not an HTML block: no blank lines at all
 md←'This is a para.' '<?' 'This' 'That' '?> This will be ignored' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(,⊂'<p>This is a para. &lt;? This That ?&gt; This will be ignored Another para</p>')≡ns.html

 md←'This is a para.' '' '<?' 'This' 'That' 'Third and final comment ?>' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(,⊂'<p>&lt;? This That Third and final comment ?&gt; Another para</p>')∊ns.html

⍝ From now on there are actually HTML blocks

 md←'This is a para.' '' '<?This?>' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<?'{⍺≡(⍴⍺)↑⍵}1⊃ns.html
 →PassesIf∨/'?>'⍷1⊃ns.html
 →PassesIf'<p>Another para</p>'{⍺≡(-⍴⍺)↑⍵}↑¯1↑ns.html

 md←'This is a para.' '' '<?' 'This' 'That' '?>' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<?'≡1⊃ns.html
 →PassesIf'?>'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html

 md←'This is a para.' '' '<?' 'This' 'That' '?> This will be ignored' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<?'≡1⊃ns.html
 →PassesIf'?>'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html

 md←'This is a para.' '' '<?' 'This' 'That' 'Third and final comment ?>' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<?'≡1⊃ns.html
 →PassesIf'Third and final comment ?>'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html

 R←∆OK
