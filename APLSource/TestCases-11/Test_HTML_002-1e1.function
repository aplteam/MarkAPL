 R←Test_HTML_002(stopFlag batchFlag);⎕TRAP;md;ns
⍝ Test <!-- tags in all flavours.
 ⎕TRAP←(999 'C' '. ⍝ Deliberate error')(0 'N')
 R←∆Failed

⍝ Not an HTML block (trailing empty line missing)
 md←'This is a para.' '' '<!--comment-->' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(,⊂'<p>&lt;!–comment–&gt; Another para</p>')∊ns.html
 →PassesIf(⊂'<p>This is a para.</p>')∊ns.html
 →PassesIf 2=⍴ns.html

⍝ Not an HTML block (leading empty line missing)
 md←'This is a para.' '<!--comment-->' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(⊂'<p>This is a para. &lt;!–comment–&gt;</p>')∊ns.html

⍝ Not an HTML block (both empty lines are missing)
 md←'This is a para.' '<!--comment-->' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf(,⊂'<p>This is a para. &lt;!–comment–&gt; Another para</p>')≡ns.html

⍝ From here we have real HTML blocks
 md←'This is a para.' '' '<!--comment-->' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<!--'{⍺≡(⍴⍺)↑⍵}1⊃ns.html
 →PassesIf∨/'-->'⍷1⊃ns.html
 →PassesIf'<p>Another para</p>'{⍺≡(-⍴⍺)↑⍵}↑¯1↑ns.html

 md←'This is a para.' '' '<!--comment-->' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<!--'{⍺≡(⍴⍺)↑⍵}1⊃ns.html
 →PassesIf∨/'-->'⍷1⊃ns.html
 →PassesIf'<p>Another para</p>'{⍺≡(-⍴⍺)↑⍵}↑¯1↑ns.html

 md←'This is a para.' '' '<!--' 'comment 1' 'comment 2' '-->' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<!--'≡1⊃ns.html
 →PassesIf'-->'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html

 md←'This is a para.' '' '<!--' 'comment 1' 'comment 2' '--> This will be ignored' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<!--'≡1⊃ns.html
 →PassesIf'-->'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html
 →PassesIf~∨/'This will be ignored'⍷∊ns.html

 md←'This is a para.' '' '<!--' 'comment 1' 'comment 2' 'Third and final comment -->' '' 'Another para'
 ns←##.MarkAPL.Init''md
 ns←##.MarkAPL.Process ns
 →PassesIf'<!--'≡1⊃ns.html
 →PassesIf'Third and final comment -->'≡4⊃ns.html
 →PassesIf'<p>Another para</p>'≡↑¯1↑ns.html

 R←∆OK
