<!DOCTYPE html>
<html lang="en">
<head>
<title>Coverage</title>
<meta charset="utf-8"/>
<style>
@media screen{
    html {background-color: #FFFFF0;}
body {
    font-size: 16px;
    font-family : Verdana, "Bitstream Vera Sans", "DejaVu Sans", Tahoma, Geneva, Arial, Sans-serif;
    margin: 1em;
}
th, td {padding: 5px 10px;}
th {text-align: left;}
h1, h2, h3, h4, h5, h6 {color: #424242;}
h1 {font-size: 22px;}
h2 {font-size: 18px; margin-top: 2em; margin-bottom:0.3em;}
tbody tr:nth-child(even) {background-color: #F0F0F0;}
tbody tr:nth-child(odd) {background-color: #FAFAFA;}
th {background-color: #E6E6E6;color: #424242;}
table {border: silver 1px solid; font-size: 14px;font-family: APLFont, monospace;}
code , code a {font-size: 14px; font-family: APLFont, monospace;}
code.header {
    font-size: 16px; 
    font-family: APLFont, monospace; 
    margin: 1.5em 0.5em 0 0.5em; 
    padding:0;
    display: block;
}
div.code-block {
    border: 1px silver dashed;
    background-color: #F2F2F2;
    display: block;
    margin: 0.5em 0.5em 0.5em 0.5em;
    padding: 0.5em;
}
div.code-block.missing {
    background-color: #fa605254;
}
div.code-block code {display: block; white-space: pre-wrap; margin:0; padding:0; word-wrap: break-word;}
.emphasize { font-weight: 800;}
ul li, ol li {margin: 0.7em 0.2em;}
.float-right {float:right;}
.no-underline {    text-decoration :none;}
.top-links {font-size:20px; padding-left: 0.6em;}
.align-right {text-align: right;}
#footer hr {margin-top:1.5em;}
#footer p {margin-top:5px; padding-top:0; font-size: 9px;}
@font-face {
        font-family: "APLFont";
    src:
        local("APL385 Unicode"),
        url("https://misc.aplteam.com/apl385.ttf") format("truetype");
}
.info {border: 1px silver dashed; background-color: #F2F2F2;margin: 0.5em; padding: 0.5em;}
}
@media print{@page {size: portrait}
@page {
    margin: 1cm 1cm 1cm 1.75cm;
    @bottom-right {
        content: counter(page) " / " counter(pages);
  }
}
body {
    font: 12pt "Times New Roman", Times, serif;
    line-height: 1.2;
     /* CSS3 filter, at the moment Webkit only. Prefix it for future implementations */
    -webkit-filter: grayscale(100%);
    filter: grayscale(100%); /* future-proof */
}
h1 {font-size: 18pt;}
h2 {font-size: 16pt; margin-top: 10pt; margin-bottom: 3pt;}
th, td {padding: 2pt 3pt;}
th {text-align: left;background-color: #DBDBDB;}
tbody tr:nth-child(odd) {background-color: #EDEDED;}
table {
    color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    font-size: 8pt;
    font-family: APLFont, monospace;
}
div.keep-together {break-inside: avoid; break-before:auto;}
table {border: silver 1pt solid;}
code , code a {font-size: 8pt; font-family: APLFont, monospace;}
code.header {
    font-size: 8pt;
    font-family: APLFont, monospace;
    margin: 7pt 3pt 0 10pt;
    padding:0;
    display: block;
}
div.code-block {
    border: 1pt silver dashed;
    background-color: #F2F2F2;
    display: block;
    margin: 4pt 4pt 4pt 4pt;
    padding: 4pt;
}
div.code-block code {display: block; white-space: pre-wrap; margin:0; padding:0; word-wrap: break-word;}
.emphasize { font-weight: 800;}
a {text-decoration: none;color: black;}
ul li, ol li {margin: 8pt 3pt;}
.no-print {display:none;}
.align-right {text-align: right;}
#footer hr {margin-top:1.5em;}
#footer p {margin-top:5pt; padding-top:0; font-size: 6pt;}
@font-face {
        font-family: "APLFont";
    src:
        local("APL385 Unicode"),
        url("https://misc.aplteam.com/apl385.ttf") format("truetype");
}
.info {border: 1px silver dashed; background-color: #F2F2F2;margin: 8px; padding: 8px;}
}
</style>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.11.2/b-2.0.0/b-print-2.0.0/fh-3.1.9/r-2.2.9/datatables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.11.2/b-2.0.0/b-print-2.0.0/fh-3.1.9/r-2.2.9/datatables.min.js"></script>
</head>
<body>
<h1 id="top">Coverage Report</h1>
<p>Watched: 240 fns/opr within <code>#.MarkAPL.MarkAPL</code></p>
<p>The test suite was executed once:</p>
<table>
<thead>
<tr><th>Executed at</th><th>APLVersion</th><th>Memory (MB)</th></tr>
</thead>
<tbody>
<tr><td>2023-12-04 10:23:37</td><td>Windows-64 ⋄ 18.2.47418.0 ⋄ W ⋄ Development ⋄ Unicode</td><td>50</td></tr>
</tbody>
</table>
<p>Overall 91% of the testable code is covered.</p>
<p>(Comment lines, empty lines, all <code>:End</code>* lines etc. are ignored)</p>
<p>189 of the fns/opr are 100% covered.</p>
<div id="partly-covered" class="keep-together">
<table id="percent">
<thead>
<tr><th style="text-align:left;">Function/Operator</th><th style="text-align:left;">Lines not executed</th><th style="text-align:left;">Coverage</th><th style="text-align:right;">≢</th></tr>
</thead>
<tbody>
<tr class="uncovered"><td><a href="#listing_1" title="Link to listing">#.MarkAPL.MarkAPL.DeleteTrailingWhiteSpace</a></td><td>4←≢3-6</td><td>0</td><td>4</td></tr>
<tr class="uncovered"><td><a href="#listing_2" title="Link to listing">#.MarkAPL.MarkAPL.EscapeSpecialCharsOutsideCode</a></td><td>3, 4</td><td>0</td><td>2</td></tr>
<tr class="uncovered"><td><a href="#listing_3" title="Link to listing">#.MarkAPL.MarkAPL.GetCurrentDir</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_4" title="Link to listing">#.MarkAPL.MarkAPL.GetJavaScriptForTogglingTOC</a></td><td>19←≢1-19</td><td>0</td><td>19</td></tr>
<tr class="uncovered"><td><a href="#listing_5" title="Link to listing">#.MarkAPL.MarkAPL.HtmlTagsAllowedInPara</a></td><td>54←≢3-56</td><td>0</td><td>54</td></tr>
<tr class="uncovered"><td><a href="#listing_6" title="Link to listing">#.MarkAPL.MarkAPL.IdentifyBulletedList</a></td><td>2, 3, 4</td><td>0</td><td>3</td></tr>
<tr class="uncovered"><td><a href="#listing_7" title="Link to listing">#.MarkAPL.MarkAPL.IdentifyList__</a></td><td>9←≢1-9</td><td>0</td><td>9</td></tr>
<tr class="uncovered"><td><a href="#listing_8" title="Link to listing">#.MarkAPL.MarkAPL.IdentifyOrderedList</a></td><td>1, 2, 3</td><td>0</td><td>3</td></tr>
<tr class="uncovered"><td><a href="#listing_9" title="Link to listing">#.MarkAPL.MarkAPL.IsGlued</a></td><td>3, 4</td><td>0</td><td>2</td></tr>
<tr class="uncovered"><td><a href="#listing_10" title="Link to listing">#.MarkAPL.MarkAPL.IsStyleBlockStart</a></td><td>5←≢1-5</td><td>0</td><td>5</td></tr>
<tr class="uncovered"><td><a href="#listing_11" title="Link to listing">#.MarkAPL.MarkAPL.ProcessMarkAPLExtensions_</a></td><td>27←≢1-17,19-26,28,32</td><td>0</td><td>27</td></tr>
<tr class="uncovered"><td><a href="#listing_12" title="Link to listing">#.MarkAPL.MarkAPL.Public</a></td><td>16←≢1-16</td><td>0</td><td>16</td></tr>
<tr class="uncovered"><td><a href="#listing_13" title="Link to listing">#.MarkAPL.MarkAPL.ReplacePointyBracketsAndAmpersandByHtmlEntities</a></td><td>17←≢1,3-17,20</td><td>0</td><td>17</td></tr>
<tr class="uncovered"><td><a href="#listing_14" title="Link to listing">#.MarkAPL.MarkAPL.API.CreateHelpParms</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_15" title="Link to listing">#.MarkAPL.MarkAPL.API.CreateParms</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_16" title="Link to listing">#.MarkAPL.MarkAPL.API.Version</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_17" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.CreateHelpParms</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_18" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.CreateParms</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr class="uncovered"><td><a href="#listing_19" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Version</a></td><td>1</td><td>0</td><td>1</td></tr>
<tr><td><a href="#listing_20" title="Link to listing">#.MarkAPL.MarkAPL.InsertTocCaption</a></td><td>5←≢6-10</td><td>38</td><td>8</td></tr>
<tr><td><a href="#listing_21" title="Link to listing">#.MarkAPL.MarkAPL.EstablishDefaultHomeFolder</a></td><td>3, 4, 5</td><td>40</td><td>5</td></tr>
<tr><td><a href="#listing_22" title="Link to listing">#.MarkAPL.MarkAPL.SetTitle</a></td><td>3, 4, 5</td><td>40</td><td>5</td></tr>
<tr><td><a href="#listing_23" title="Link to listing">#.MarkAPL.MarkAPL.RemoveLeanpubEncoding</a></td><td>2</td><td>50</td><td>2</td></tr>
<tr><td><a href="#listing_24" title="Link to listing">#.MarkAPL.MarkAPL.ReplaceQTC_byBlank</a></td><td>3, 4</td><td>50</td><td>4</td></tr>
<tr><td><a href="#listing_25" title="Link to listing">#.MarkAPL.MarkAPL.LookForEmbeddedParm</a></td><td>5←≢7-11</td><td>55</td><td>11</td></tr>
<tr><td><a href="#listing_26" title="Link to listing">#.MarkAPL.MarkAPL.ShowHtml</a></td><td>5←≢2,6,13-14,16</td><td>55</td><td>11</td></tr>
<tr><td><a href="#listing_27" title="Link to listing">#.MarkAPL.MarkAPL.MaskFunctionCall</a></td><td>5, 6, 7</td><td>57</td><td>7</td></tr>
<tr><td><a href="#listing_28" title="Link to listing">#.MarkAPL.MarkAPL.AddBookmarkClassName</a></td><td>3</td><td>67</td><td>3</td></tr>
<tr><td><a href="#listing_29" title="Link to listing">#.MarkAPL.MarkAPL.CompileHelp</a></td><td>7←≢12,16-17,20,24,27,34</td><td>71</td><td>24</td></tr>
<tr><td><a href="#listing_30" title="Link to listing">#.MarkAPL.MarkAPL.Help</a></td><td>10, 17</td><td>78</td><td>9</td></tr>
<tr><td><a href="#listing_31" title="Link to listing">#.MarkAPL.MarkAPL.ExecExternalFns</a></td><td>5←≢8,20,30-31,34</td><td>79</td><td>24</td></tr>
<tr><td><a href="#listing_32" title="Link to listing">#.MarkAPL.MarkAPL.ProcessEmeddedHTML</a></td><td>12, 13</td><td>80</td><td>10</td></tr>
<tr><td><a href="#listing_33" title="Link to listing">#.MarkAPL.MarkAPL.ScanForBlockQuotes</a></td><td>14, 15, 16</td><td>80</td><td>15</td></tr>
<tr><td><a href="#listing_34" title="Link to listing">#.MarkAPL.MarkAPL.BuildColumnHeader</a></td><td>6</td><td>83</td><td>6</td></tr>
<tr><td><a href="#listing_35" title="Link to listing">#.MarkAPL.MarkAPL.CopyTo</a></td><td>4</td><td>86</td><td>7</td></tr>
<tr><td><a href="#listing_36" title="Link to listing">#.MarkAPL.MarkAPL.ProcessParagraph_</a></td><td>8</td><td>89</td><td>9</td></tr>
<tr><td><a href="#listing_37" title="Link to listing">#.MarkAPL.MarkAPL.GetBookMarkNameFromCaption</a></td><td>29, 30</td><td>90</td><td>20</td></tr>
<tr><td><a href="#listing_38" title="Link to listing">#.MarkAPL.MarkAPL.Reference</a></td><td>11</td><td>90</td><td>10</td></tr>
<tr><td><a href="#listing_39" title="Link to listing">#.MarkAPL.MarkAPL.Markdown2HTML</a></td><td>15</td><td>92</td><td>13</td></tr>
<tr><td><a href="#listing_40" title="Link to listing">#.MarkAPL.MarkAPL.ProcessMarkAPLExtensions</a></td><td>5←≢47-51</td><td>92</td><td>59</td></tr>
<tr><td><a href="#listing_41" title="Link to listing">#.MarkAPL.MarkAPL.InjectCssIntoHtml</a></td><td>9</td><td>94</td><td>17</td></tr>
<tr><td><a href="#listing_42" title="Link to listing">#.MarkAPL.MarkAPL.HandleAbbreviations</a></td><td>9</td><td>95</td><td>19</td></tr>
<tr><td><a href="#listing_43" title="Link to listing">#.MarkAPL.MarkAPL.Init</a></td><td>14</td><td>95</td><td>20</td></tr>
<tr><td><a href="#listing_44" title="Link to listing">#.MarkAPL.MarkAPL.Process</a></td><td>25</td><td>95</td><td>20</td></tr>
<tr><td><a href="#listing_45" title="Link to listing">#.MarkAPL.MarkAPL.ProcessEmbeddedParms_</a></td><td>20</td><td>95</td><td>20</td></tr>
<tr><td><a href="#listing_46" title="Link to listing">#.MarkAPL.MarkAPL.ProcessTable_</a></td><td>30, 67, 68</td><td>95</td><td>55</td></tr>
<tr><td><a href="#listing_47" title="Link to listing">#.MarkAPL.MarkAPL.ProcessTableWithoutColTitles</a></td><td>10</td><td>96</td><td>25</td></tr>
<tr><td><a href="#listing_48" title="Link to listing">#.MarkAPL.MarkAPL.EscapeSpecialChars</a></td><td>44</td><td>97</td><td>34</td></tr>
<tr><td><a href="#listing_49" title="Link to listing">#.MarkAPL.MarkAPL.ProcessList</a></td><td>4←≢10,81,85,184</td><td>97</td><td>144</td></tr>
<tr><td><a href="#listing_50" title="Link to listing">#.MarkAPL.MarkAPL.CreateParms</a></td><td>27</td><td>98</td><td>52</td></tr>
<tr><td><a href="#listing_51" title="Link to listing">#.MarkAPL.MarkAPL.MakeHTML_Doc</a></td><td>63</td><td>98</td><td>45</td></tr>
<tr class="fullyCovered"><td><a href="#listing_52" title="Link to listing">#.MarkAPL.MarkAPL.A</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_53" title="Link to listing">#.MarkAPL.MarkAPL.AddAlignStyle</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_54" title="Link to listing">#.MarkAPL.MarkAPL.AddAppropriateExtension</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_55" title="Link to listing">#.MarkAPL.MarkAPL.AddBookmarkLink</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_56" title="Link to listing">#.MarkAPL.MarkAPL.AllAllowedCharsInTag</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_57" title="Link to listing">#.MarkAPL.MarkAPL.AllWhiteSpaceChars</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_58" title="Link to listing">#.MarkAPL.MarkAPL.AppendFootnoteDefinitions</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_59" title="Link to listing">#.MarkAPL.MarkAPL.Between</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_60" title="Link to listing">#.MarkAPL.MarkAPL.BringBackSpecialHtmlEntities</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_61" title="Link to listing">#.MarkAPL.MarkAPL.CalculateHeaderNumbers</a></td><td></td><td>100</td><td>16</td></tr>
<tr class="fullyCovered"><td><a href="#listing_62" title="Link to listing">#.MarkAPL.MarkAPL.CheckForHtmlBlock</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_63" title="Link to listing">#.MarkAPL.MarkAPL.CheckForInvalidFootnotes1</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_64" title="Link to listing">#.MarkAPL.MarkAPL.CheckForInvalidFootnotes2</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_65" title="Link to listing">#.MarkAPL.MarkAPL.CheckHeaders</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_66" title="Link to listing">#.MarkAPL.MarkAPL.CheckInternalLinks</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_67" title="Link to listing">#.MarkAPL.MarkAPL.CheckOddNumberOfDoubleQuotes</a></td><td></td><td>100</td><td>26</td></tr>
<tr class="fullyCovered"><td><a href="#listing_68" title="Link to listing">#.MarkAPL.MarkAPL.CollectItem</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_69" title="Link to listing">#.MarkAPL.MarkAPL.CollectItemPara</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_70" title="Link to listing">#.MarkAPL.MarkAPL.CollectToc</a></td><td></td><td>100</td><td>12</td></tr>
<tr class="fullyCovered"><td><a href="#listing_71" title="Link to listing">#.MarkAPL.MarkAPL.CompileAttribute</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_72" title="Link to listing">#.MarkAPL.MarkAPL.CompileAttributes</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_73" title="Link to listing">#.MarkAPL.MarkAPL.CompileBookMarkName</a></td><td></td><td>100</td><td>19</td></tr>
<tr class="fullyCovered"><td><a href="#listing_74" title="Link to listing">#.MarkAPL.MarkAPL.CompileClassNames</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_75" title="Link to listing">#.MarkAPL.MarkAPL.CompileID_Names</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_76" title="Link to listing">#.MarkAPL.MarkAPL.CompilePara</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_77" title="Link to listing">#.MarkAPL.MarkAPL.CompileParms</a></td><td></td><td>100</td><td>11</td></tr>
<tr class="fullyCovered"><td><a href="#listing_78" title="Link to listing">#.MarkAPL.MarkAPL.CompressCSS</a></td><td></td><td>100</td><td>18</td></tr>
<tr class="fullyCovered"><td><a href="#listing_79" title="Link to listing">#.MarkAPL.MarkAPL.ConvertEscapedAmpersand</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_80" title="Link to listing">#.MarkAPL.MarkAPL.ConvertH1AndH2HeadersToH3</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_81" title="Link to listing">#.MarkAPL.MarkAPL.ConvertMarkdown2HTML</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_82" title="Link to listing">#.MarkAPL.MarkAPL.ConvertMarkdownFile</a></td><td></td><td>100</td><td>14</td></tr>
<tr class="fullyCovered"><td><a href="#listing_83" title="Link to listing">#.MarkAPL.MarkAPL.CorrectSlash</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_84" title="Link to listing">#.MarkAPL.MarkAPL.CreateHelpParms</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_85" title="Link to listing">#.MarkAPL.MarkAPL.CreateMarkdownFromUrlAndLinkText</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_86" title="Link to listing">#.MarkAPL.MarkAPL.CreateTOC</a></td><td></td><td>100</td><td>31</td></tr>
<tr class="fullyCovered"><td><a href="#listing_87" title="Link to listing">#.MarkAPL.MarkAPL.Create_NS</a></td><td></td><td>100</td><td>20</td></tr>
<tr class="fullyCovered"><td><a href="#listing_88" title="Link to listing">#.MarkAPL.MarkAPL.DetectClosingTag</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_89" title="Link to listing">#.MarkAPL.MarkAPL.DetectClosingTagBeforeEmptyLine</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_90" title="Link to listing">#.MarkAPL.MarkAPL.DetectOpeningTag</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_91" title="Link to listing">#.MarkAPL.MarkAPL.Drop</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_92" title="Link to listing">#.MarkAPL.MarkAPL.DropSpecialAttributes</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_93" title="Link to listing">#.MarkAPL.MarkAPL.DropSpecialImageAttributes</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_94" title="Link to listing">#.MarkAPL.MarkAPL.DropTailAfterClosingTag</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_95" title="Link to listing">#.MarkAPL.MarkAPL.EscapePipeSymbolInCell</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_96" title="Link to listing">#.MarkAPL.MarkAPL.Execute</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_97" title="Link to listing">#.MarkAPL.MarkAPL.FindFenceEnd</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_98" title="Link to listing">#.MarkAPL.MarkAPL.FlattenHTML</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_99" title="Link to listing">#.MarkAPL.MarkAPL.FlattenNestedItem</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_100" title="Link to listing">#.MarkAPL.MarkAPL.GatherFootNoteReferences</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_101" title="Link to listing">#.MarkAPL.MarkAPL.GetAllLinkRefs</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_102" title="Link to listing">#.MarkAPL.MarkAPL.GetBookmarkAnchors</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_103" title="Link to listing">#.MarkAPL.MarkAPL.GetBookmarkLinks</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_104" title="Link to listing">#.MarkAPL.MarkAPL.GetCodeBlockFrom</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_105" title="Link to listing">#.MarkAPL.MarkAPL.GetCommandLineParms</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_106" title="Link to listing">#.MarkAPL.MarkAPL.GetCopyCodeJavaScript</a></td><td></td><td>100</td><td>40</td></tr>
<tr class="fullyCovered"><td><a href="#listing_107" title="Link to listing">#.MarkAPL.MarkAPL.GetEmptyLines</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_108" title="Link to listing">#.MarkAPL.MarkAPL.GetFooter</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_109" title="Link to listing">#.MarkAPL.MarkAPL.GetIdFromSpecialAttributes</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_110" title="Link to listing">#.MarkAPL.MarkAPL.GetInfoString</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_111" title="Link to listing">#.MarkAPL.MarkAPL.GetJavaScriptForPrintingCollapsibles</a></td><td></td><td>100</td><td>21</td></tr>
<tr class="fullyCovered"><td><a href="#listing_112" title="Link to listing">#.MarkAPL.MarkAPL.GetLengthOfLeadingWhitespacePlusListMarker</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_113" title="Link to listing">#.MarkAPL.MarkAPL.GetLinkRef</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_114" title="Link to listing">#.MarkAPL.MarkAPL.GetListBlock</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_115" title="Link to listing">#.MarkAPL.MarkAPL.GetMarkdown</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_116" title="Link to listing">#.MarkAPL.MarkAPL.GetMaskForCode</a></td><td></td><td>100</td><td>25</td></tr>
<tr class="fullyCovered"><td><a href="#listing_117" title="Link to listing">#.MarkAPL.MarkAPL.GetMaskForCodeTags</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_118" title="Link to listing">#.MarkAPL.MarkAPL.GetRegExPatternForSubToc</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_119" title="Link to listing">#.MarkAPL.MarkAPL.GetSpecialAttributes</a></td><td></td><td>100</td><td>21</td></tr>
<tr class="fullyCovered"><td><a href="#listing_120" title="Link to listing">#.MarkAPL.MarkAPL.GetUrlAndTitleFromLink</a></td><td></td><td>100</td><td>20</td></tr>
<tr class="fullyCovered"><td><a href="#listing_121" title="Link to listing">#.MarkAPL.MarkAPL.HandleEscapedNewLines</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_122" title="Link to listing">#.MarkAPL.MarkAPL.HtmlBlockTags</a></td><td></td><td>100</td><td>31</td></tr>
<tr class="fullyCovered"><td><a href="#listing_123" title="Link to listing">#.MarkAPL.MarkAPL.HtmlTags</a></td><td></td><td>100</td><td>114</td></tr>
<tr class="fullyCovered"><td><a href="#listing_124" title="Link to listing">#.MarkAPL.MarkAPL.IdentifyListItems</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_125" title="Link to listing">#.MarkAPL.MarkAPL.InjectBR</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_126" title="Link to listing">#.MarkAPL.MarkAPL.InjectCssFilenamesIntoHtml</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_127" title="Link to listing">#.MarkAPL.MarkAPL.InjectFootNotes</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_128" title="Link to listing">#.MarkAPL.MarkAPL.InjectLinkTextIntoReportLink</a></td><td></td><td>100</td><td>11</td></tr>
<tr class="fullyCovered"><td><a href="#listing_129" title="Link to listing">#.MarkAPL.MarkAPL.InjectNumberedHeaders</a></td><td></td><td>100</td><td>14</td></tr>
<tr class="fullyCovered"><td><a href="#listing_130" title="Link to listing">#.MarkAPL.MarkAPL.InjectPointyBrackets</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_131" title="Link to listing">#.MarkAPL.MarkAPL.InjectSubTOCs</a></td><td></td><td>100</td><td>31</td></tr>
<tr class="fullyCovered"><td><a href="#listing_132" title="Link to listing">#.MarkAPL.MarkAPL.InjectTOC</a></td><td></td><td>100</td><td>18</td></tr>
<tr class="fullyCovered"><td><a href="#listing_133" title="Link to listing">#.MarkAPL.MarkAPL.IotaSetextHeader</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_134" title="Link to listing">#.MarkAPL.MarkAPL.IsBulletedHtmlList</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_135" title="Link to listing">#.MarkAPL.MarkAPL.IsFence</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_136" title="Link to listing">#.MarkAPL.MarkAPL.IsFenceStart</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_137" title="Link to listing">#.MarkAPL.MarkAPL.IsHtmlList</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_138" title="Link to listing">#.MarkAPL.MarkAPL.IsLeanPubEncodingLine</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_139" title="Link to listing">#.MarkAPL.MarkAPL.IsOrderedHtmlList</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_140" title="Link to listing">#.MarkAPL.MarkAPL.IsSelfDefinedHtmlTag</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_141" title="Link to listing">#.MarkAPL.MarkAPL.IsTableRow</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_142" title="Link to listing">#.MarkAPL.MarkAPL.IsUnicodeCharacter</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_143" title="Link to listing">#.MarkAPL.MarkAPL.IsolateLink</a></td><td></td><td>100</td><td>7</td></tr>
<tr class="fullyCovered"><td><a href="#listing_144" title="Link to listing">#.MarkAPL.MarkAPL.LeanPubAltTextFor</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_145" title="Link to listing">#.MarkAPL.MarkAPL.LeanPubImageFor</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_146" title="Link to listing">#.MarkAPL.MarkAPL.MakeLiteralForRegex</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_147" title="Link to listing">#.MarkAPL.MarkAPL.MarkUpAsCode</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_148" title="Link to listing">#.MarkAPL.MarkAPL.MarkUpInlineCode</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_149" title="Link to listing">#.MarkAPL.MarkAPL.MarkUpInlineCode_</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_150" title="Link to listing">#.MarkAPL.MarkAPL.MaskTagAttrs</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_151" title="Link to listing">#.MarkAPL.MarkAPL.MassageCodeBlock</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_152" title="Link to listing">#.MarkAPL.MarkAPL.MassageFilename</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_153" title="Link to listing">#.MarkAPL.MarkAPL.Matrix2MarkdownList</a></td><td></td><td>100</td><td>12</td></tr>
<tr class="fullyCovered"><td><a href="#listing_154" title="Link to listing">#.MarkAPL.MarkAPL.Matrix2MarkdownTable</a></td><td></td><td>100</td><td>16</td></tr>
<tr class="fullyCovered"><td><a href="#listing_155" title="Link to listing">#.MarkAPL.MarkAPL.NotWithinWord</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_156" title="Link to listing">#.MarkAPL.MarkAPL.NumberHeaders</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_157" title="Link to listing">#.MarkAPL.MarkAPL.PolishWarnings</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_158" title="Link to listing">#.MarkAPL.MarkAPL.ProcessATX_Header</a></td><td></td><td>100</td><td>27</td></tr>
<tr class="fullyCovered"><td><a href="#listing_159" title="Link to listing">#.MarkAPL.MarkAPL.ProcessAbbreviationDefs</a></td><td></td><td>100</td><td>9</td></tr>
<tr class="fullyCovered"><td><a href="#listing_160" title="Link to listing">#.MarkAPL.MarkAPL.ProcessAsterisks</a></td><td></td><td>100</td><td>17</td></tr>
<tr class="fullyCovered"><td><a href="#listing_161" title="Link to listing">#.MarkAPL.MarkAPL.ProcessAutomaticLinks</a></td><td></td><td>100</td><td>18</td></tr>
<tr class="fullyCovered"><td><a href="#listing_162" title="Link to listing">#.MarkAPL.MarkAPL.ProcessBlockQuotes</a></td><td></td><td>100</td><td>23</td></tr>
<tr class="fullyCovered"><td><a href="#listing_163" title="Link to listing">#.MarkAPL.MarkAPL.ProcessCheckBoxes</a></td><td></td><td>100</td><td>18</td></tr>
<tr class="fullyCovered"><td><a href="#listing_164" title="Link to listing">#.MarkAPL.MarkAPL.ProcessCodeBlock</a></td><td></td><td>100</td><td>27</td></tr>
<tr class="fullyCovered"><td><a href="#listing_165" title="Link to listing">#.MarkAPL.MarkAPL.ProcessDataDefs</a></td><td></td><td>100</td><td>20</td></tr>
<tr class="fullyCovered"><td><a href="#listing_166" title="Link to listing">#.MarkAPL.MarkAPL.ProcessDefinitionLists</a></td><td></td><td>100</td><td>46</td></tr>
<tr class="fullyCovered"><td><a href="#listing_167" title="Link to listing">#.MarkAPL.MarkAPL.ProcessDoubleAsterisks</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_168" title="Link to listing">#.MarkAPL.MarkAPL.ProcessDoubleTildes</a></td><td></td><td>100</td><td>17</td></tr>
<tr class="fullyCovered"><td><a href="#listing_169" title="Link to listing">#.MarkAPL.MarkAPL.ProcessDoubleUnderscores</a></td><td></td><td>100</td><td>16</td></tr>
<tr class="fullyCovered"><td><a href="#listing_170" title="Link to listing">#.MarkAPL.MarkAPL.ProcessEmbeddedParms</a></td><td></td><td>100</td><td>23</td></tr>
<tr class="fullyCovered"><td><a href="#listing_171" title="Link to listing">#.MarkAPL.MarkAPL.ProcessFootnoteDefs</a></td><td></td><td>100</td><td>18</td></tr>
<tr class="fullyCovered"><td><a href="#listing_172" title="Link to listing">#.MarkAPL.MarkAPL.ProcessFunctionCalls</a></td><td></td><td>100</td><td>27</td></tr>
<tr class="fullyCovered"><td><a href="#listing_173" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHeaders</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_174" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHorizontalRulers</a></td><td></td><td>100</td><td>11</td></tr>
<tr class="fullyCovered"><td><a href="#listing_175" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHtmlBlockType_CDATA</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_176" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHtmlBlockType_Tags</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_177" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHtmlBlock_HtmlComments</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_178" title="Link to listing">#.MarkAPL.MarkAPL.ProcessHtmlBlock_ScriptStylePre</a></td><td></td><td>100</td><td>17</td></tr>
<tr class="fullyCovered"><td><a href="#listing_179" title="Link to listing">#.MarkAPL.MarkAPL.ProcessImageUrl</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_180" title="Link to listing">#.MarkAPL.MarkAPL.ProcessImages</a></td><td></td><td>100</td><td>24</td></tr>
<tr class="fullyCovered"><td><a href="#listing_181" title="Link to listing">#.MarkAPL.MarkAPL.ProcessInlineMarkUp</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_182" title="Link to listing">#.MarkAPL.MarkAPL.ProcessInlineMarkUp_</a></td><td></td><td>100</td><td>17</td></tr>
<tr class="fullyCovered"><td><a href="#listing_183" title="Link to listing">#.MarkAPL.MarkAPL.ProcessInlineMarkupInLinkText</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_184" title="Link to listing">#.MarkAPL.MarkAPL.ProcessLeanPubCodeEmphasizing</a></td><td></td><td>100</td><td>11</td></tr>
<tr class="fullyCovered"><td><a href="#listing_185" title="Link to listing">#.MarkAPL.MarkAPL.ProcessLeanPubExtensions</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_186" title="Link to listing">#.MarkAPL.MarkAPL.ProcessLeanPubExtensions_</a></td><td></td><td>100</td><td>28</td></tr>
<tr class="fullyCovered"><td><a href="#listing_187" title="Link to listing">#.MarkAPL.MarkAPL.ProcessLinks</a></td><td></td><td>100</td><td>33</td></tr>
<tr class="fullyCovered"><td><a href="#listing_188" title="Link to listing">#.MarkAPL.MarkAPL.ProcessLists</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_189" title="Link to listing">#.MarkAPL.MarkAPL.ProcessParagraph</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_190" title="Link to listing">#.MarkAPL.MarkAPL.ProcessReferenceLinks</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_191" title="Link to listing">#.MarkAPL.MarkAPL.ProcessSetextHeader</a></td><td></td><td>100</td><td>27</td></tr>
<tr class="fullyCovered"><td><a href="#listing_192" title="Link to listing">#.MarkAPL.MarkAPL.ProcessSpecialHTML_Chars</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_193" title="Link to listing">#.MarkAPL.MarkAPL.ProcessSubTOC</a></td><td></td><td>100</td><td>17</td></tr>
<tr class="fullyCovered"><td><a href="#listing_194" title="Link to listing">#.MarkAPL.MarkAPL.ProcessTable</a></td><td></td><td>100</td><td>8</td></tr>
<tr class="fullyCovered"><td><a href="#listing_195" title="Link to listing">#.MarkAPL.MarkAPL.ProcessUnderscores</a></td><td></td><td>100</td><td>21</td></tr>
<tr class="fullyCovered"><td><a href="#listing_196" title="Link to listing">#.MarkAPL.MarkAPL.Process_BR</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_197" title="Link to listing">#.MarkAPL.MarkAPL.Process_PRE</a></td><td></td><td>100</td><td>22</td></tr>
<tr class="fullyCovered"><td><a href="#listing_198" title="Link to listing">#.MarkAPL.MarkAPL.RemoveAllComments</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_199" title="Link to listing">#.MarkAPL.MarkAPL.RemoveDoubleSlashes</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_200" title="Link to listing">#.MarkAPL.MarkAPL.RemoveEscapeChars</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_201" title="Link to listing">#.MarkAPL.MarkAPL.RemoveHTML</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_202" title="Link to listing">#.MarkAPL.MarkAPL.RemoveIdFromSpecialAttributes</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_203" title="Link to listing">#.MarkAPL.MarkAPL.RemoveLampLines</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_204" title="Link to listing">#.MarkAPL.MarkAPL.ReplaceDoubleSmartQuotes</a></td><td></td><td>100</td><td>5</td></tr>
<tr class="fullyCovered"><td><a href="#listing_205" title="Link to listing">#.MarkAPL.MarkAPL.ReplaceFootnoteReferences</a></td><td></td><td>100</td><td>6</td></tr>
<tr class="fullyCovered"><td><a href="#listing_206" title="Link to listing">#.MarkAPL.MarkAPL.ReplaceLinkID</a></td><td></td><td>100</td><td>12</td></tr>
<tr class="fullyCovered"><td><a href="#listing_207" title="Link to listing">#.MarkAPL.MarkAPL.ReplaceLinkIDs</a></td><td></td><td>100</td><td>4</td></tr>
<tr class="fullyCovered"><td><a href="#listing_208" title="Link to listing">#.MarkAPL.MarkAPL.ReportLinks</a></td><td></td><td>100</td><td>19</td></tr>
<tr class="fullyCovered"><td><a href="#listing_209" title="Link to listing">#.MarkAPL.MarkAPL.ScanForPara</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_210" title="Link to listing">#.MarkAPL.MarkAPL.ScanMarkdown</a></td><td></td><td>100</td><td>42</td></tr>
<tr class="fullyCovered"><td><a href="#listing_211" title="Link to listing">#.MarkAPL.MarkAPL.SmartQuotes</a></td><td></td><td>100</td><td>15</td></tr>
<tr class="fullyCovered"><td><a href="#listing_212" title="Link to listing">#.MarkAPL.MarkAPL.SmartStuff</a></td><td></td><td>100</td><td>3</td></tr>
<tr class="fullyCovered"><td><a href="#listing_213" title="Link to listing">#.MarkAPL.MarkAPL.SmartTypography</a></td><td></td><td>100</td><td>12</td></tr>
<tr class="fullyCovered"><td><a href="#listing_214" title="Link to listing">#.MarkAPL.MarkAPL.SplitTableRowButMaskCode</a></td><td></td><td>100</td><td>10</td></tr>
<tr class="fullyCovered"><td><a href="#listing_215" title="Link to listing">#.MarkAPL.MarkAPL.Tag</a></td><td></td><td>100</td><td>2</td></tr>
<tr class="fullyCovered"><td><a href="#listing_216" title="Link to listing">#.MarkAPL.MarkAPL.TagMustStartWith</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_217" title="Link to listing">#.MarkAPL.MarkAPL.Version</a></td><td></td><td>100</td><td>1</td></tr>
<tr class="fullyCovered"><td><a href="#listing_218" title="Link to listing">#.MarkAPL.MarkAPL.WhereAreCodeBlocks</a></td><td></td><td>100</td><td>11</td></tr>
<tr class="fullyCovered"><td><a href="#listing_219" title="Link to listing">#.MarkAPL.MarkAPL.API.CompressCSS</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_220" title="Link to listing">#.MarkAPL.MarkAPL.API.ConvertMarkdownFile</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_221" title="Link to listing">#.MarkAPL.MarkAPL.API.Execute</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_222" title="Link to listing">#.MarkAPL.MarkAPL.API.Help</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_223" title="Link to listing">#.MarkAPL.MarkAPL.API.Init</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_224" title="Link to listing">#.MarkAPL.MarkAPL.API.MakeHTML_Doc</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_225" title="Link to listing">#.MarkAPL.MarkAPL.API.Markdown2HTML</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_226" title="Link to listing">#.MarkAPL.MarkAPL.API.Matrix2MarkdownList</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_227" title="Link to listing">#.MarkAPL.MarkAPL.API.Matrix2MarkdownTable</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_228" title="Link to listing">#.MarkAPL.MarkAPL.API.Process</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_229" title="Link to listing">#.MarkAPL.MarkAPL.API.Reference</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_230" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.CompressCSS</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_231" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.ConvertMarkdownFile</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_232" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Execute</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_233" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Help</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_234" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Init</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_235" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.MakeHTML_Doc</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_236" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Markdown2HTML</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_237" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Matrix2MarkdownList</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_238" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Matrix2MarkdownTable</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_239" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Process</a></td><td></td><td>100</td><td>0</td></tr>
<tr class="fullyCovered"><td><a href="#listing_240" title="Link to listing">#.MarkAPL.MarkAPL.MarkAPL.Reference</a></td><td></td><td>100</td><td>0</td></tr>
</tbody>
</table>
</div>
<script>
$(document).ready(function() {
    var oTable;
    oTable = $("#percent").DataTable( {
        paging:   false,
        ordering: true,
        info:     true,
        fixedHeader: true,
        order: [2,"asc"],
        dom: "Bft",
        drawCallback: function( settings ) {
             var api = this.api();
             $('.header[id^="listing_"]').next().addBack().css("display","none");
             api.rows( {page:"current"} ).data().each(function(data){
              id = data[0];
              id = id.match(/"(\#.*?)"/);
              if (id){$(id[1]).next().addBack().css("display","block");}
             })
        },      
        buttons: [
        {
            text: "Partly covered (32)",
            titleAttr: "50%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "^(?!(0%|100%)).*";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "Uncovered (19)",
            titleAttr: "0%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "^0%";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "Fully covered (189)",
            titleAttr: "100%",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = "100%";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
        {
            text: "All (240)",
            titleAttr: "all",
            className: "active",
            action: function ( e, dt, node, config ) {
                var text = this.text();
                var search = ".";
                oTable.column(2)
                    .search(search,true,false,false)
                    .draw();
                $(".dt-buttons button").removeClass("active");
                this.active( true );
            }
        },
    ],
 
        columnDefs: [
            {className: "align-right", targets: [2,3]
            },
            {
                render: function ( data, type, row, meta ) {
                            return data+"%" ;        
                        },
                targets: 2
            }
        ]             
    } );
    oTable.button(0).trigger();

} );    
</script>
<h2>Listings</h2>
<code class="header" id="listing_1">#.MarkAPL.MarkAPL.DeleteTrailingWhiteSpace &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> DeleteTrailingWhiteSpace←{</code>
<code> [1] ⍝ Blanks, Tabs, you name it.</code>
<code> [2] ⍝ See https://www.wikiwand.com/en/Whitespace_character for details.</code>
<code class="emphasize">→[3]      ⎕IO←1 ⋄ ⎕ML←1</code>
<code class="emphasize">→[4]      (2=|≡⍵):∇¨⍵</code>
<code class="emphasize">→[5]      ws←⎕UCS 9 10 11 12 13 32 133 160</code>
<code class="emphasize">→[6]      (1=⍴⍴⍵):⌽{(+/∧\⍵∊ws)↓⍵}⌽⍵</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_2">#.MarkAPL.MarkAPL.EscapeSpecialCharsOutsideCode &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> EscapeSpecialCharsOutsideCode←{</code>
<code> [1] ⍝ ⍵ is typically a line of a Markdown document.</code>
<code> [2] ⍝ Code is masked here. If you don't want this see `EscapeSpecialChars`</code>
<code class="emphasize">→[3]      0=≢⍵:⍵</code>
<code class="emphasize">→[4]      ((⊂'`.*?`'),,¨'&lt;&gt;&amp;')⎕R'\0' '\&amp;lt;' '\&amp;gt;' '&amp;amp;'⊢⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_3">#.MarkAPL.MarkAPL.GetCurrentDir &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←GetCurrentDir</code>
<code class="emphasize">→[1]  r←¯1↓⊃1 ⎕NPARTS''</code>
</div>
<code class="header" id="listing_4">#.MarkAPL.MarkAPL.GetJavaScriptForTogglingTOC &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←GetJavaScriptForTogglingTOC</code>
<code class="emphasize">→[1]   r←''</code>
<code class="emphasize">→[2]   r,←⊂''</code>
<code class="emphasize">→[3]   r,←⊂'&lt;script&gt;'</code>
<code class="emphasize">→[4]   r,←⊂'// Toggle the visibility of the TOC when the "Hide/Show" button is clicked'</code>
<code class="emphasize">→[5]   r,←⊂'const button = document.querySelector("#toc-toggle");'</code>
<code class="emphasize">→[6]   r,←⊂'const content = document.querySelector("#toc-list");'</code>
<code class="emphasize">→[7]   r,←⊂'button.addEventListener("click", toggleTableOfContents);'</code>
<code class="emphasize">→[8]   r,←⊂'function toggleTableOfContents() {'</code>
<code class="emphasize">→[9]   r,←⊂'  content.classList.toggle("no_display");'</code>
<code class="emphasize">→[10]  r,←⊂'  if (button.innerText === "Hide") {'</code>
<code class="emphasize">→[11]  r,←⊂'    button.innerText = "Show";'</code>
<code class="emphasize">→[12]  r,←⊂'    button.setAttribute("aria-expanded", false);'</code>
<code class="emphasize">→[13]  r,←⊂'  } else {'</code>
<code class="emphasize">→[14]  r,←⊂'    button.innerText = "Hide";'</code>
<code class="emphasize">→[15]  r,←⊂'    button.setAttribute("aria-expanded", true);'</code>
<code class="emphasize">→[16]  r,←⊂'  }'</code>
<code class="emphasize">→[17]  r,←⊂'}'</code>
<code class="emphasize">→[18]  r,←⊂'&lt;/script&gt;'</code>
<code class="emphasize">→[19]  r,←⊂''</code>
</div>
<code class="header" id="listing_5">#.MarkAPL.MarkAPL.HtmlTagsAllowedInPara &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←HtmlTagsAllowedInPara</code>
<code> [1]  ⍝ Returns a list with all tags a &lt;p&gt; might contain.</code>
<code> [2]  ⍝ Does not list tags that might be inside a tag returned by this function etc.</code>
<code class="emphasize">→[3]   r←''</code>
<code class="emphasize">→[4]   r,←⊂'a'</code>
<code class="emphasize">→[5]   r,←⊂'abbr'</code>
<code class="emphasize">→[6]   r,←⊂'area'</code>
<code class="emphasize">→[7]   r,←⊂'audio'</code>
<code class="emphasize">→[8]   r,←⊂'b'</code>
<code class="emphasize">→[9]   r,←⊂'bdi'</code>
<code class="emphasize">→[10]  r,←⊂'bdo'</code>
<code class="emphasize">→[11]  r,←⊂'br'</code>
<code class="emphasize">→[12]  r,←⊂'button'</code>
<code class="emphasize">→[13]  r,←⊂'canvas'</code>
<code class="emphasize">→[14]  r,←⊂'cite'</code>
<code class="emphasize">→[15]  r,←⊂'code'</code>
<code class="emphasize">→[16]  r,←⊂'command'</code>
<code class="emphasize">→[17]  r,←⊂'datalist'</code>
<code class="emphasize">→[18]  r,←⊂'del'</code>
<code class="emphasize">→[19]  r,←⊂'dfn'</code>
<code class="emphasize">→[20]  r,←⊂'em'</code>
<code class="emphasize">→[21]  r,←⊂'embed'</code>
<code class="emphasize">→[22]  r,←⊂'i'</code>
<code class="emphasize">→[23]  r,←⊂'iframe'</code>
<code class="emphasize">→[24]  r,←⊂'img'</code>
<code class="emphasize">→[25]  r,←⊂'input'</code>
<code class="emphasize">→[26]  r,←⊂'ins'</code>
<code class="emphasize">→[27]  r,←⊂'kbd'</code>
<code class="emphasize">→[28]  r,←⊂'keygen'</code>
<code class="emphasize">→[29]  r,←⊂'label'</code>
<code class="emphasize">→[30]  r,←⊂'map'</code>
<code class="emphasize">→[31]  r,←⊂'mark'</code>
<code class="emphasize">→[32]  r,←⊂'math'</code>
<code class="emphasize">→[33]  r,←⊂'meter'</code>
<code class="emphasize">→[34]  r,←⊂'noscript'</code>
<code class="emphasize">→[35]  r,←⊂'object'</code>
<code class="emphasize">→[36]  r,←⊂'output'</code>
<code class="emphasize">→[37]  r,←⊂'progress'</code>
<code class="emphasize">→[38]  r,←⊂'q'</code>
<code class="emphasize">→[39]  r,←⊂'ruby'</code>
<code class="emphasize">→[40]  r,←⊂'s'</code>
<code class="emphasize">→[41]  r,←⊂'samp'</code>
<code class="emphasize">→[42]  r,←⊂'script'</code>
<code class="emphasize">→[43]  r,←⊂'select'</code>
<code class="emphasize">→[44]  r,←⊂'small'</code>
<code class="emphasize">→[45]  r,←⊂'span'</code>
<code class="emphasize">→[46]  r,←⊂'strong'</code>
<code class="emphasize">→[47]  r,←⊂'sub'</code>
<code class="emphasize">→[48]  r,←⊂'sup'</code>
<code class="emphasize">→[49]  r,←⊂'svg'</code>
<code class="emphasize">→[50]  r,←⊂'textarea'</code>
<code class="emphasize">→[51]  r,←⊂'time'</code>
<code class="emphasize">→[52]  r,←⊂'u'</code>
<code class="emphasize">→[53]  r,←⊂'var'</code>
<code class="emphasize">→[54]  r,←⊂'video'</code>
<code class="emphasize">→[55]  r,←⊂'wbr'</code>
<code class="emphasize">→[56]  r,←⊂'text'</code>
</div>
<code class="header" id="listing_6">#.MarkAPL.MarkAPL.IdentifyBulletedList &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IdentifyBulletedList←{</code>
<code> [1] ⍝ This uses ns.leadingChars, meaning that it ignores indentation</code>
<code class="emphasize">→[2]      ns←⍵</code>
<code class="emphasize">→[3]      max←⍺</code>
<code class="emphasize">→[4]      IdentifyList__ ns max'*'</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_7">#.MarkAPL.MarkAPL.IdentifyList__ &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  IdentifyList__←{</code>
<code class="emphasize">→[1]       (ns max type)←⍵</code>
<code class="emphasize">→[2]       nl←0,¯1↓'\'=⊃¨¯1↑¨max↑ns.markdown                                 ⍝ nl flags all lines that...</code>
<code class="emphasize">→[3]       nl∨←0,¯1↓(~max↑ns.emptyLines)∧'  '∘≡¨¯2↑¨max↑ns.markdown          ⍝ ... belong to the predecessor...</code>
<code class="emphasize">→[4]       nl∨←0,¯1↓'&lt;&lt;br&gt;&gt;'{⍺∘≡¨(-≢⍺)↑¨⍵}max↑ns.markdown                    ⍝ ... due to line breaks.</code>
<code class="emphasize">→[5]       markers←(1+'*'=type)⊃'0123456789 ' '+-* '                         ⍝ "markers" depends on list type.</code>
<code class="emphasize">→[6]       max←+/∧\nl∨(⊃¨max↑ns.leadingChars)∊markers                        ⍝</code>
<code class="emphasize">→[7]       '*'≡type:+/∧\{(' '=⍵)∨~⊃∘IsOrderedHtmlList¨⍵}⊃¨max↑ns.markdown    ⍝ No mistake: we check for the ...</code>
<code class="emphasize">→[8]       '1'≡type:+/∧\{(' '=⍵)∨~⊃∘IsBulletedHtmlList¨⍵}⊃¨max↑ns.leadingChars  ⍝ OTHER list type here!</code>
<code class="emphasize">→[9]       .                                                                 ⍝ Huuh?!</code>
<code> [10]  }</code>
</div>
<code class="header" id="listing_8">#.MarkAPL.MarkAPL.IdentifyOrderedList &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IdentifyOrderedList←{</code>
<code class="emphasize">→[1]      ns←⍵</code>
<code class="emphasize">→[2]      max←⍺</code>
<code class="emphasize">→[3]      IdentifyList__ ns max'1'</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_9">#.MarkAPL.MarkAPL.IsGlued &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsGlued←{</code>
<code> [1] ⍝ Takes a vector of vectors and returns a 1 for those lines</code>
<code> [2] ⍝ that end either with \ of with &lt;&lt;br&gt;&gt;</code>
<code class="emphasize">→[3]      b←'\'=⊃¨¯1↑¨⍵</code>
<code class="emphasize">→[4]      0,¯1↓b∨'&lt;&lt;br&gt;&gt;'∘{⍺≡(-≢⍺)↑⍵}¨⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_10">#.MarkAPL.MarkAPL.IsStyleBlockStart &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsStyleBlockStart←{</code>
<code class="emphasize">→[1]      start←⍵</code>
<code class="emphasize">→[2]      '&lt;style'{⍺≢(≢⍺)↑⍵}start:0</code>
<code class="emphasize">→[3]      later←(≢'&lt;style')↓start</code>
<code class="emphasize">→[4]      '&gt;'=⊃later:1</code>
<code class="emphasize">→[5]      0=≢later:1</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_11">#.MarkAPL.MarkAPL.ProcessMarkAPLExtensions_ &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←parms ProcessMarkAPLExtensions_ ns</code>
<code class="emphasize">→[1]   ∘∘∘</code>
<code class="emphasize">→[2]   isNotCodeBlock←~WhereAreCodeBlocks ns.markdown</code>
<code class="emphasize">→[3]   :If 0&lt;+/bool←isNotCodeBlock\(3↑¨isNotCodeBlock/ns.markdown)≡¨⊂'^&gt; '</code>
<code class="emphasize">→[4]   :AndIf 0≠≢start←⍸0 1⍷bool</code>
<code class="emphasize">→[5]       lengths←,+/¨bool{⎕ML←3 ⋄ ⍺⊂⍵}bool</code>
<code class="emphasize">→[6]       :For i :In ⍳≢start</code>
<code class="emphasize">→[7]           ind←i⊃start</code>
<code class="emphasize">→[8]           :If 0=≢ind⊃ns.markdown            ⍝ The line before must be empty</code>
<code class="emphasize">→[9]               noOf←i⊃lengths</code>
<code class="emphasize">→[10]              after←1+ind+noOf</code>
<code class="emphasize">→[11]              :If 0=≢after⊃ns.markdown      ⍝ The line after must be empty</code>
<code class="emphasize">→[12]                  openDiv←⊂'&lt;div class="leanpub',((extension≡'A')/'_A'),'"&gt;'</code>
<code class="emphasize">→[13]                  body←3↓¨ns.markdown[ind+⍳lengths[i]]</code>
<code class="emphasize">→[14]                  (html report)←ConvertMarkdown2HTML body</code>
<code class="emphasize">→[15]                  :If extension≠'A'</code>
<code class="emphasize">→[16]                      img←'&lt;img src="',(parms LeanPubImageFor extension),'" alt="',(LeanPubAltTextFor extension),'"&gt;'</code>
<code class="emphasize">→[17]                      html←img'&lt;div&gt;',html,⊂'&lt;/div&gt;'</code>
<code> [18]                  :EndIf</code>
<code class="emphasize">→[19]                  html←{0=+/b←0=≢¨⍵:⍵ ⋄ w←⍵ ⋄ (b/w)←⊂'&amp;nbsp;' ⋄ w}html  ⍝ Important: only this way "html" is later recognized as a single HTML block.</code>
<code class="emphasize">→[20]                  html←openDiv,html,⊂'&lt;/div&gt;'</code>
<code class="emphasize">→[21]                  ns.markdown←(ind↑ns.markdown),html,(ind+noOf)↓ns.markdown</code>
<code class="emphasize">→[22]                  ns.lineNumbers←(ind↑ns.lineNumbers),((≢html)⍴⊂(1+ind),ind+noOf),(ind+noOf)↓ns.lineNumbers</code>
<code class="emphasize">→[23]                  :If 0≠≢report</code>
<code class="emphasize">→[24]                      :For this :In report</code>
<code class="emphasize">→[25]                          :If ∨/'(line'⍷this</code>
<code class="emphasize">→[26]                              ns.report,←((ind+1)⊃ns.lineNumbers)∘{i←-(⌽⍵)⍳' ' ⋄ (i↓⍵),' ',({1=≢⍵:⍕⍵ ⋄ ⊃{⍺,'-',⍵}/⍕¨⍵}⍺),')'}¨report</code>
<code> [27]                          :Else</code>
<code class="emphasize">→[28]                              ns.report,←((ind+1)⊃ns.lineNumbers)∘{i←-(⌽⍵)⍳' ' ⋄ ⍵,' (lines ',({1=≢⍵:⍕⍵ ⋄ ⊃{⍺,'-',⍵}/⍕¨⍵}⍺),')'}¨report</code>
<code> [29]                          :EndIf</code>
<code> [30]                      :EndFor</code>
<code> [31]                  :EndIf</code>
<code class="emphasize">→[32]                  (i↓start)←(i↓start)+(≢html)-noOf</code>
<code> [33]              :EndIf</code>
<code> [34]          :EndIf</code>
<code> [35]      :EndFor</code>
<code> [36]  :EndIf</code>
</div>
<code class="header" id="listing_12">#.MarkAPL.MarkAPL.Public &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←Public</code>
<code class="emphasize">→[1]   r←''</code>
<code class="emphasize">→[2]   r,←⊂'CompressCSS'</code>
<code class="emphasize">→[3]   r,←⊂'ConvertMarkdownFile'</code>
<code class="emphasize">→[4]   r,←⊂'CreateHelpParms'</code>
<code class="emphasize">→[5]   r,←⊂'CreateParms'</code>
<code class="emphasize">→[6]   r,←⊂'Execute'</code>
<code class="emphasize">→[7]   r,←⊂'Help'</code>
<code class="emphasize">→[8]   r,←⊂'History'</code>
<code class="emphasize">→[9]   r,←⊂'Init'</code>
<code class="emphasize">→[10]  r,←⊂'MakeHTML_Doc'</code>
<code class="emphasize">→[11]  r,←⊂'Markdown2HTML'</code>
<code class="emphasize">→[12]  r,←⊂'Matrix2MarkdownList'</code>
<code class="emphasize">→[13]  r,←⊂'Matrix2MarkdownTable'</code>
<code class="emphasize">→[14]  r,←⊂'Process'</code>
<code class="emphasize">→[15]  r,←⊂'Reference'</code>
<code class="emphasize">→[16]  r,←⊂'Version'</code>
</div>
<code class="header" id="listing_13">#.MarkAPL.MarkAPL.ReplacePointyBracketsAndAmpersandByHtmlEntities &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  tx←ReplacePointyBracketsAndAmpersandByHtmlEntities tx</code>
<code class="emphasize">→[1]   :If ∨/b←'&lt;code'⍷tx</code>
<code> [2]   ⍝ This will rarely be the case, so performance is not a great concern here.</code>
<code class="emphasize">→[3]       buff←(~b)⊆tx</code>
<code class="emphasize">→[4]       :For i :In ⍳≢buff</code>
<code class="emphasize">→[5]           item←i⊃buff</code>
<code class="emphasize">→[6]           :If 'code'{⍺≡(≢⍺)↑⍵}item</code>
<code class="emphasize">→[7]               start←'&lt;',item↑⍨item⍳'&gt;'</code>
<code class="emphasize">→[8]               item←(¯1+≢start)↓item</code>
<code class="emphasize">→[9]               end←(¯1+⍸'&lt;/code&gt;'⍷item)↓item</code>
<code class="emphasize">→[10]              item←(-≢end)↓item</code>
<code class="emphasize">→[11]              b1←item='&lt;'</code>
<code class="emphasize">→[12]              b2←item='&gt;'</code>
<code class="emphasize">→[13]              b3←item='&amp;'</code>
<code class="emphasize">→[14]              (b1/item)←⊂'&amp;lt;'</code>
<code class="emphasize">→[15]              (b2/item)←⊂'&amp;gt;'</code>
<code class="emphasize">→[16]              (b3/item)←⊂'&amp;amp;'</code>
<code class="emphasize">→[17]              (i⊃buff)←start,item,end</code>
<code> [18]          :EndIf</code>
<code> [19]      :EndFor</code>
<code class="emphasize">→[20]      tx←∊buff</code>
<code> [21]  :EndIf</code>
</div>
<code class="header" id="listing_14">#.MarkAPL.MarkAPL.API.CreateHelpParms &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> parms←CreateHelpParms</code>
<code class="emphasize">→[1]  parms←##.CreateHelpParms</code>
</div>
<code class="header" id="listing_15">#.MarkAPL.MarkAPL.API.CreateParms &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←CreateParms</code>
<code class="emphasize">→[1]  r←##.CreateParms</code>
</div>
<code class="header" id="listing_16">#.MarkAPL.MarkAPL.API.Version &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←Version</code>
<code class="emphasize">→[1]  r←##.Version</code>
</div>
<code class="header" id="listing_17">#.MarkAPL.MarkAPL.MarkAPL.CreateHelpParms &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> parms←CreateHelpParms</code>
<code class="emphasize">→[1]  parms←##.CreateHelpParms</code>
</div>
<code class="header" id="listing_18">#.MarkAPL.MarkAPL.MarkAPL.CreateParms &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←CreateParms</code>
<code class="emphasize">→[1]  r←##.CreateParms</code>
</div>
<code class="header" id="listing_19">#.MarkAPL.MarkAPL.MarkAPL.Version &mdash; 0%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←Version</code>
<code class="emphasize">→[1]  r←##.Version</code>
</div>
<code class="header" id="listing_20">#.MarkAPL.MarkAPL.InsertTocCaption &mdash; 38%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  InsertTocCaption←{</code>
<code> [1]  ⍝ Replace "&lt;&lt;tocCaption&gt;&gt;" in the css against "parms.tocCaption"</code>
<code> [2]  ⍝ ⍺ is 1 for print CSS and 2 for screen CSS.</code>
<code> [3]       (parms css)←⍵</code>
<code> [4]       lines←⍸∨/¨bool←'&lt;&lt;tocCaption&gt;&gt;'∘⍷¨css</code>
<code> [5]       0=≢lines:css</code>
<code class="emphasize">→[6]       bool←bool[lines]</code>
<code class="emphasize">→[7]       (tpd tpu)←⎕UCS 9660 9650   ⍝ Triangle Point Down, Triangle Pointing Up</code>
<code class="emphasize">→[8]       (1=⍺)∨1=≢lines:css</code>
<code class="emphasize">→[9]       css[lines[2]]←⊂'content: ''',(parms.tocCaption,' ',tpu,''''),';'</code>
<code class="emphasize">→[10]      css</code>
<code> [11]  }</code>
</div>
<code class="header" id="listing_21">#.MarkAPL.MarkAPL.EstablishDefaultHomeFolder &mdash; 40%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> EstablishDefaultHomeFolder←{</code>
<code> [1]      p←⍵</code>
<code> [2]      ⎕NULL≢p.homeFolder:p</code>
<code class="emphasize">→[3]      this←⍕⎕THIS</code>
<code class="emphasize">→[4]      p.homeFolder←Get_Home</code>
<code class="emphasize">→[5]      p</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_22">#.MarkAPL.MarkAPL.SetTitle &mdash; 40%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> SetTitle←{</code>
<code> [1]      ns←⍵</code>
<code> [2]      ¯1≢ns.parms.title:ns</code>
<code class="emphasize">→[3]      1≠ns.headers[;1]+.=1:ns⊣ns.parms.title←'MarkAPL'</code>
<code class="emphasize">→[4]      ns.parms.title←{⊃⍵[⍵[;1]⍳1;3]}ns.headers</code>
<code class="emphasize">→[5]      ns</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_23">#.MarkAPL.MarkAPL.RemoveLeanpubEncoding &mdash; 50%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> RemoveLeanpubEncoding←{</code>
<code> [1]      0=≢'^ *{:: encoding=".*$'⎕S 0⊣⊃⍵:⍵</code>
<code class="emphasize">→[2]      1↓⍵</code>
<code> [3]  }</code>
</div>
<code class="header" id="listing_24">#.MarkAPL.MarkAPL.ReplaceQTC_byBlank &mdash; 50%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ReplaceQTC_byBlank←{</code>
<code> [1]      tx←⍵</code>
<code> [2]      0=+/b←tx∊⎕TC:tx</code>
<code class="emphasize">→[3]      (b/tx)←' '</code>
<code class="emphasize">→[4]      tx</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_25">#.MarkAPL.MarkAPL.LookForEmbeddedParm &mdash; 55%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  LookForEmbeddedParm←{</code>
<code> [1]       markdown←⍵</code>
<code> [2]       valueName←⍺</code>
<code> [3]       searchFor←'[parm]:'</code>
<code> [4]       0=+/bool←searchFor∘≡¨(≢searchFor)↑¨markdown:''</code>
<code> [5]       buff←(≢searchFor)↓¨bool/markdown</code>
<code> [6]       0=+/bool←valueName∘≡¨(≢valueName)↑¨buff:''</code>
<code class="emphasize">→[7]       buff←(≢searchFor)↓(bool⍳1)⊃markdown</code>
<code class="emphasize">→[8]       valueName≢(≢valueName)↑buff:''</code>
<code class="emphasize">→[9]       value←(1+≢valueName)↓buff</code>
<code class="emphasize">→[10]      ''''=1⍴value:1↓¯1↓value</code>
<code class="emphasize">→[11]      ⊃(//)⎕VFI value</code>
<code> [12]  }</code>
</div>
<code class="header" id="listing_26">#.MarkAPL.MarkAPL.ShowHtml &mdash; 55%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←ns ShowHtml name</code>
<code> [1]   :If './'≡2⍴name</code>
<code class="emphasize">→[2]       name←(⊃1 ⎕NPARTS''),2↓name</code>
<code> [3]   :EndIf</code>
<code> [4]   :If '/'≠1⍴name</code>
<code> [5]   :AndIf ~':'∊name</code>
<code class="emphasize">→[6]       filename←FilesAndDirs.EnforceSlash parms.homeFolder,'/Docs/',name,'.html'</code>
<code> [7]   :Else</code>
<code> [8]       filename←name</code>
<code> [9]   :EndIf</code>
<code> [10]  :If ⍬≢ns</code>
<code> [11]      A.GoToWebPage'file:///',filename</code>
<code> [12]  :Else</code>
<code class="emphasize">→[13]      :If FilesAndDirs.IsFile filename</code>
<code class="emphasize">→[14]          A.GoToWebPage'file:///',filename</code>
<code> [15]      :Else</code>
<code class="emphasize">→[16]          6 ⎕SIGNAL⍨'File not found: "',name,'"'</code>
<code> [17]      :EndIf</code>
<code> [18]  :EndIf</code>
</div>
<code class="header" id="listing_27">#.MarkAPL.MarkAPL.MaskFunctionCall &mdash; 57%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MaskFunctionCall←{</code>
<code> [1]      txt←,⍵</code>
<code> [2]      b←(≢txt)⍴0</code>
<code> [3]      mask←~GetMaskForCodeTags txt</code>
<code> [4]      0=≢ind←'[^⍎]⍎⍎[^⍎]'⎕S 0⊣' ',(mask/txt),' ':b</code>
<code class="emphasize">→[5]      ind←{↑,/{⍵[1]+⍳⍵[2]-⍵[1]}¨↓(((≢⍵)÷2),2)⍴⍵}ind</code>
<code class="emphasize">→[6]      b[ind]←1</code>
<code class="emphasize">→[7]      b</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_28">#.MarkAPL.MarkAPL.AddBookmarkClassName &mdash; 67%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> AddBookmarkClassName←{</code>
<code> [1]      sa←⍵  ⍝ Special attributes - they MAY contain a user-defined class name</code>
<code> [2]      0=+/'class="'⍷sa:sa,' class="bookmark_link"'</code>
<code class="emphasize">→[3]      'class="'⎕R'&amp;bookmark_link '⊣sa</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_29">#.MarkAPL.MarkAPL.CompileHelp &mdash; 71%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←CompileHelp(filename recompileFlag parms)</code>
<code> [1]  ⍝ Called by `Help` and `Reference`.</code>
<code> [2]   ns←⍬</code>
<code> [3]   parms←EstablishDefaultHomeFolder parms</code>
<code> [4]   :If ⎕NULL≡parms.cssURL</code>
<code> [5]   :AndIf {0=≢⍵:0 ⋄ (~':'∊⍵)∧'/'≠1⍴⍵}parms.screenCSS</code>
<code> [6]   :AndIf {0=≢⍵:0 ⋄ (~':'∊⍵)∧'/'≠1⍴⍵}parms.printCSS</code>
<code> [7]       parms.cssURL←parms.homeFolder,'/Files'</code>
<code> [8]   :EndIf</code>
<code> [9]   :If (':'∊filename)∨'/'=1⍴filename</code>
<code> [10]      fn←CorrectSlash filename</code>
<code> [11]  :Else</code>
<code class="emphasize">→[12]      fn←CorrectSlash FilesAndDirs.PWD,'/',filename</code>
<code> [13]  :EndIf</code>
<code> [14]  parms.inputFilename←filename</code>
<code> [15]  :If 0=≢parms.inputFilename</code>
<code class="emphasize">→[16]  :AndIf 0=FilesAndDirs.IsFile parms.inputFilename←(⊃,/2↑⎕NPARTS fn),(1+recompileFlag)⊃'.html' '.md'</code>
<code class="emphasize">→[17]      ('Could not find "',parms.inputFilename,'"')⎕SIGNAL 6</code>
<code> [18]  :EndIf</code>
<code> [19]  :If 0=≢parms.outputFilename</code>
<code class="emphasize">→[20]      parms.outputFilename←(⊃,/2↑⎕NPARTS fn),'.html'</code>
<code> [21]  :EndIf</code>
<code> [22]  :If |recompileFlag</code>
<code> [23]      :If 0=FilesAndDirs.Exists parms.inputFilename</code>
<code class="emphasize">→[24]          6 ⎕SIGNAL⍨'File "',parms.inputFilename,'" not found; set "homeFolder"'</code>
<code> [25]      :EndIf</code>
<code> [26]      :If 0=≢parms.outputFilename</code>
<code class="emphasize">→[27]          parms.outputFilename←fn</code>
<code> [28]      :Else</code>
<code> [29]          fn←parms.outputFilename</code>
<code> [30]      :EndIf</code>
<code> [31]      ns←2⊃parms Markdown2HTML''</code>
<code> [32]  :EndIf</code>
<code> [33]  :If 0=parms.⎕NC'viewInBrowser'</code>
<code class="emphasize">→[34]      parms.viewInBrowser←1</code>
<code> [35]  :EndIf</code>
</div>
<code class="header" id="listing_30">#.MarkAPL.MarkAPL.Help &mdash; 78%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {ns}←{parms}Help recompileFlag</code>
<code> [1]  ⍝ Displays the file MarkAPL_CheatSheet.html with your default browser.\\</code>
<code> [2]  ⍝ `recompileFlag`:</code>
<code> [3]  ⍝ * 0 shows the file as it stands.</code>
<code> [4]  ⍝ * 1 lets MarkAPL recompile it from MarkAPL_CheatSheet.md first.</code>
<code> [5]  ⍝ Returns either `⍬` or the `ns` namespace created by `Init` and modified by `Process`.</code>
<code> [6]  ⍝ However, if the markdown file does not exist then `recompileFlag` has no effect (is always 0).</code>
<code> [7]   :Access Public Shared</code>
<code> [8]   parms←{0&lt;⎕NC ⍵:⍎⍵ ⋄ CreateHelpParms}'parms'</code>
<code> [9]   :If ~⎕NEXISTS parms.homeFolder,'/Files/MarkAPL_CheatSheet.md'</code>
<code class="emphasize">→[10]      recompileFlag←0</code>
<code> [11]  :EndIf</code>
<code> [12]  filename←parms.homeFolder,'/Files/MarkAPL_CheatSheet'</code>
<code> [13]  filename←recompileFlag AddAppropriateExtension filename</code>
<code> [14]  ns←CompileHelp filename recompileFlag parms</code>
<code> [15]  :If ¯1≠×recompileFlag  ⍝ This syntax is used only by `Make` and test cases, therefore it is not documented.</code>
<code> [16]  :AndIf parms.viewInBrowser</code>
<code class="emphasize">→[17]      ns ShowHtml(⊃,/2↑⎕NPARTS filename),'.html'</code>
<code> [18]  :EndIf</code>
<code> [19] ⍝Done</code>
</div>
<code class="header" id="listing_31">#.MarkAPL.MarkAPL.ExecExternalFns &mdash; 79%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  result←ns ExecExternalFns y</code>
<code> [1]   result←''</code>
<code> [2]   (fns __arg)←{∨/' '''∊⍵:(¯1+⌊/⍵⍳' '''){(⍺↑⍵)(A.DLB ⍺↓⍵)}⍵ ⋄ ⍵ ⍬}y</code>
<code> [3]   nc←⎕NC⊂fns</code>
<code> [4]   :If 3≠⌊|nc</code>
<code> [5]       ns.report,←⊂'Unknown external function: &lt;',fns,'&gt;'</code>
<code> [6]   :Else</code>
<code> [7]       :If (1=×nc)∧0=2⊃1 ⎕AT fns</code>
<code class="emphasize">→[8]           ns.report,←⊂'External function &lt;',fns,'&gt; is niladic but must not!'  ⍝ We cannot perform this check on class methods!</code>
<code> [9]       :Else</code>
<code> [10]          :Trap 0</code>
<code> [11]              ⍎'result←',fns,' ns'</code>
<code> [12]              :If ¯1=×≡result</code>
<code> [13]                  ns.report,←⊂'External function &lt;',fns,'&gt; is niladic but must not!'  ⍝ Only thiss can explain a negative result</code>
<code> [14]                  result←''</code>
<code> [15]              :EndIf</code>
<code> [16]          :Case 2</code>
<code> [17]              :Trap 0</code>
<code> [18]                  ⍎'result←__arg ',fns,' ns'</code>
<code> [19]              :Else</code>
<code class="emphasize">→[20]                  ns.report,←⊂'External function &lt;',fns,'&gt; did crash'</code>
<code> [21]              :EndTrap</code>
<code> [22]          :Else</code>
<code> [23]              dmx←⎕DMX</code>
<code> [24]                   ⍝ At this stage it might be a dfn that requires a left argument, meaning that we have a VALUE ERROR on `⍺`!</code>
<code> [25]              :If 6=dmx.EN</code>
<code> [26]              :AndIf {'⍺'∊⍵/⍨{~⍵∨≠\⍵}⍵=''''}2⊃dmx.DM</code>
<code> [27]                  :Trap 0</code>
<code> [28]                      ⍎'result←__arg ',fns,' ns'</code>
<code> [29]                  :Else</code>
<code class="emphasize">→[30]                      result←''</code>
<code class="emphasize">→[31]                      ns.report,←⊂'External function &lt;',fns,'&gt; did crash'</code>
<code> [32]                  :EndTrap</code>
<code> [33]              :Else</code>
<code class="emphasize">→[34]                  ns.report,←⊂'External function &lt;',fns,'&gt; did crash'</code>
<code> [35]              :EndIf</code>
<code> [36]          :EndTrap</code>
<code> [37]      :EndIf</code>
<code> [38]  :EndIf</code>
</div>
<code class="header" id="listing_32">#.MarkAPL.MarkAPL.ProcessEmeddedHTML &mdash; 80%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessEmeddedHTML ns</code>
<code> [1]  ⍝ Figures out whether the current line begins an HTML block.\\</code>
<code> [2]  ⍝ For details regarding HTML block see &lt;http://spec.commonmark.org/0.24/#html-blocks&gt;.\\</code>
<code> [3]  ⍝ There's more to it than meets the eye at first glance.</code>
<code> [4]   r←1</code>
<code> [5]   :If CheckForHtmlBlock ns.(markdown emptyLines topOfDocument)</code>
<code> [6]       :If r←ProcessHtmlBlock_ScriptStylePre ns</code>
<code> [7]       :AndIf r←ProcessHtmlBlock_HtmlComments ns</code>
<code> [8]       :AndIf r←ProcessHtmlBlockType_CDATA ns</code>
<code> [9]       :AndIf r←ProcessHtmlBlockType_Tags ns</code>
<code> [10]          {⍵:.}ns.noOf=0                         ⍝ That must not happen at this stage!</code>
<code> [11]      :AndIf ⊃ns.emptyLines</code>
<code class="emphasize">→[12]          ns.noOf←1</code>
<code class="emphasize">→[13]          ns←Drop ns</code>
<code> [14]      :EndIf</code>
<code> [15]  :EndIf</code>
</div>
<code class="header" id="listing_33">#.MarkAPL.MarkAPL.ScanForBlockQuotes &mdash; 80%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ScanForBlockQuotes ns</code>
<code> [1]   r←0</code>
<code> [2]   ns2←⎕NS''</code>
<code> [3]   lc←↑2↑¨ns.leadingChars        ⍝ Leading two chars</code>
<code> [4]   max←¯1+ns.emptyLines⍳1        ⍝ An empty line marks the end</code>
<code> [5]   ns2.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)←max↑¨ns.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)</code>
<code> [6]   lc←max↑lc                     ⍝ Leading chars</code>
<code> [7]   :While 0&lt;ns2.noOf←1 ScanForPara ns2</code>
<code> [8]       lc←ns2.noOf↓lc            ⍝ Leading chars</code>
<code> [9]       :If 0=≢lc                 ⍝ No blockquotes...</code>
<code> [10]      :OrIf '&gt; '≢lc[1;]         ⍝ any more?</code>
<code> [11]          r+←ns2.noOf</code>
<code> [12]          :Leave                ⍝ No - we are done</code>
<code> [13]      :EndIf</code>
<code class="emphasize">→[14]      ns2.noOf+←+/∧\lc∧.='&gt; '   ⍝ Add them</code>
<code class="emphasize">→[15]      r+←ns2.noOf</code>
<code class="emphasize">→[16]      ns2←Drop ns2</code>
<code> [17]  :EndWhile</code>
</div>
<code class="header" id="listing_34">#.MarkAPL.MarkAPL.BuildColumnHeader &mdash; 83%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> BuildColumnHeader←{</code>
<code> [1]      ⍺←0 ⍝ Default data type is 0 (Char)</code>
<code> [2]      dt←⍺</code>
<code> [3]      ~':'∊(1↑⍵),¯1↑⍵:⍵((-dt)⌽':','-')</code>
<code> [4]      '::'≡2↑¯1⌽⍵:(1↓¯1↓⍵)':-:'</code>
<code> [5]      ':'=⊃¯1⌽⍵:(¯1↓⍵)'-:'</code>
<code class="emphasize">→[6]      ':'=⊃⍵:(1↓⍵)'-:'</code>
<code> [7]      ':-'</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_35">#.MarkAPL.MarkAPL.CopyTo &mdash; 86%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  to←from CopyTo to</code>
<code> [1]  ⍝ ⍺ is typically something like embedded parms while ⍵ are THE parms</code>
<code> [2]   :For id :In ' '~¨⍨↓from.⎕NL 2</code>
<code> [3]       :If flag←0=to.⎕NC id</code>
<code class="emphasize">→[4]           value←from.⍎id</code>
<code> [5]       :Else</code>
<code> [6]           :If flag←¯1≢value←to.⍎id</code>
<code> [7]               flag←~0=≢value</code>
<code> [8]           :EndIf</code>
<code> [9]       :EndIf</code>
<code> [10]      :If flag</code>
<code> [11]          id to.{⍎⍺,'←⍵'}value</code>
<code> [12]      :EndIf</code>
<code> [13]  :EndFor</code>
</div>
<code class="header" id="listing_36">#.MarkAPL.MarkAPL.ProcessParagraph_ &mdash; 89%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←ns ProcessParagraph_ para</code>
<code> [1]   r←⍬</code>
<code> [2]   para←ns CheckOddNumberOfDoubleQuotes para'paragraph'</code>
<code> [3]   sa←GetSpecialAttributes para</code>
<code> [4]   para←sa DropSpecialAttributes⍣(0&lt;⊃⍴sa)⊣para</code>
<code> [5]   (para isHtmlBlock)←ns ProcessInlineMarkUp para</code>
<code> [6]   :If 0≠≢para</code>
<code> [7]       :If isHtmlBlock</code>
<code class="emphasize">→[8]           ns.html,←para</code>
<code> [9]       :Else</code>
<code> [10]          ns.html,←,⊆sa{2=≡⍵:⍺∘∇¨⍵ ⋄ '&lt;p',({0=≢⍵:'&gt;' ⋄ ⍵,'&gt;'}⍺),⍵,'&lt;/p&gt;'}para</code>
<code> [11]      :EndIf</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_37">#.MarkAPL.MarkAPL.GetBookMarkNameFromCaption &mdash; 90%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  name←{ns}GetBookMarkNameFromCaption(txt specialAttrs)</code>
<code> [1]  ⍝ Remove all formatting, links, etc.</code>
<code> [2]  ⍝ Remove everything between &lt;&gt;, () and [].</code>
<code> [3]  ⍝ Remove all punctuation except underscores, hyphens, and periods.</code>
<code> [4]  ⍝ Remove all HTML &amp;{word}: entities</code>
<code> [5]  ⍝ Remove all code.</code>
<code> [6]  ⍝ Remove HTML.</code>
<code> [7]  ⍝ Remove leading and trailing spaces.</code>
<code> [8]  ⍝ Replace all remaining spaces with hyphens.</code>
<code> [9]  ⍝ Convert all alphabetic characters to lowercase.</code>
<code> [10] ⍝ Remove everything up to the first letter or `∆⍙`.</code>
<code> [11] ⍝ If nothing is left after this, use `section` as identifier.</code>
<code> [12]  ns←{</code>
<code> [13]      0&lt;⎕NC ⍵:⍎⍵</code>
<code> [14]      r←⎕NS''</code>
<code> [15]      r.headerLineNos←⍬</code>
<code> [16]      r.headers←0 3⍴''</code>
<code> [17]      r.lineNumbers←0</code>
<code> [18]      r.report←''</code>
<code> [19]      r.parms←⎕NS''</code>
<code> [20]      r.parms.bookmarkMayStartWithDigit←1</code>
<code> [21]      r.parms.lineNumberOffset←0</code>
<code> [22]      r</code>
<code> [23]  }'ns'</code>
<code> [24]  :If 0={0=⍵.⎕NC'parms.bookmarkLink':1 ⋄ ⍵.parms.bookmarkLink}ns</code>
<code> [25]      name←''</code>
<code> [26]  :Else</code>
<code> [27]      name←ns.parms.bookmarkMayStartWithDigit CompileBookMarkName txt specialAttrs</code>
<code> [28]      :If 0=≢name                              ⍝ Nothing left?</code>
<code class="emphasize">→[29]          name←'section'                       ⍝ Go for the name section</code>
<code class="emphasize">→[30]          ns.report,←⊂'Warning: header on line ',(⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers),': no bookmark name left; name assigned'</code>
<code> [31]      :EndIf</code>
<code> [32]      :If (⊂LowercaseID name)∊ns.headers[;2]   ⍝ Does this bookmark already exist?</code>
<code> [33]          name←1{n←⍵,'-',⍕⍺ ⋄ ~(⊂n)∊ns.headers[;2]:n ⋄ (1+⍺)∇ ⍵ ⋄ }LowercaseID name  ⍝ Append a number to `name`</code>
<code> [34]          ns.report,←⊂'Warning: header on line ',(⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers),': ambiguous name; number added'</code>
<code> [35]      :EndIf</code>
<code> [36]  :EndIf</code>
</div>
<code class="header" id="listing_38">#.MarkAPL.MarkAPL.Reference &mdash; 90%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {ns}←{parms}Reference recompileFlag</code>
<code> [1]  ⍝ Displays the file MarkAPL.html with your default browser.\\</code>
<code> [2]  ⍝ `recompileFlag`:</code>
<code> [3]  ⍝ * A zero shows the file as it stands.</code>
<code> [4]  ⍝ * A 1 lets MarkAPL recompile it from MarkAPL.md first.</code>
<code> [5]  ⍝ However, if the markdown file does not exist then `recompileFlag` has no effect (is always 0).</code>
<code> [6]  ⍝ Returns either `⍬` or the `ns` namespace created by `Init` and modified by `Process`.</code>
<code> [7]   :Access Public Shared</code>
<code> [8]   parms←{0&lt;⎕NC ⍵:⍎⍵ ⋄ CreateHelpParms}'parms'</code>
<code> [9]   parms←EstablishDefaultHomeFolder parms</code>
<code> [10]  :If ~⎕NEXISTS parms.homeFolder,'/Files/MarkAPL.md'</code>
<code class="emphasize">→[11]      recompileFlag←0</code>
<code> [12]  :EndIf</code>
<code> [13]  filename←parms.homeFolder,'/Files/MarkAPL'</code>
<code> [14]  filename←recompileFlag AddAppropriateExtension filename</code>
<code> [15]  ns←CompileHelp filename recompileFlag parms</code>
<code> [16]  :If ¯1≠×recompileFlag  ⍝ This syntax is used only by the `Make` workspace and test cases, therefore it is not documented.</code>
<code> [17]  :AndIf parms.viewInBrowser</code>
<code> [18]      ns ShowHtml(⊃,/2↑⎕NPARTS filename),'.html'</code>
<code> [19]  :EndIf</code>
<code> [20] ⍝Done</code>
</div>
<code class="header" id="listing_39">#.MarkAPL.MarkAPL.Markdown2HTML &mdash; 92%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {(html ns)}←{parms}Markdown2HTML markdown</code>
<code> [1]  ⍝ `⍵` is one of:</code>
<code> [2]  ⍝   * Vector of character vectors representing a Markdown document.</code>
<code> [3]  ⍝   * Empty vector. In this case the parameter "inputFilename" must be specified.</code>
<code> [4]  ⍝ `⍺` Is a namespace with parameters, typically create by calling `CreateParms`.\\</code>
<code> [5]  ⍝ `←` Is a two-element vector starting from version 1.7.0:</code>
<code> [6]  ⍝ 1. Is always the HTML created. As a side effect this HTML will also be written</code>
<code> [7]  ⍝    to the file specified by `outputFilename` - if that is not empty that is.</code>
<code> [8]  ⍝ 2. The `ns` namespace created by `Init` and needed / processed by `Process. This contains `ns.report`,</code>
<code> [9]  ⍝    something you might want to check.</code>
<code> [10] ⍝ In case `outputFilename` is not empty the HTML is also written to file.</code>
<code> [11]  :Access Public Shared</code>
<code> [12]  parms←{0&lt;⎕NC ⍵:⍎⍵ ⋄ CreateParms}'parms'</code>
<code> [13]  :If 0=≢markdown</code>
<code> [14]      :If 0=≢parms.inputFilename</code>
<code class="emphasize">→[15]          'Neither "markdown" nor "inputFilename" defined'⎕SIGNAL 6</code>
<code> [16]      :Else</code>
<code> [17]          markdown←⊃⎕NGET parms.inputFilename 1</code>
<code> [18]      :EndIf</code>
<code> [19]  :EndIf</code>
<code> [20]  ns←Init parms markdown</code>
<code> [21]  ns←Process ns</code>
<code> [22]  html←ns.html</code>
<code> [23]  :If (0≠≢ns.parms.outputFilename)∧0≠ns.parms.createFullHtmlPage</code>
<code> [24]  :OrIf 1=ns.parms.createFullHtmlPage</code>
<code> [25]      html←ns.parms MakeHTML_Doc html</code>
<code> [26]  :EndIf</code>
<code> [27]  :If 0&lt;≢ns.parms.outputFilename</code>
<code> [28]      (⊂html)⎕NPUT ns.parms.outputFilename 1</code>
<code> [29]  :EndIf</code>
<code> [30] ⍝Done</code>
</div>
<code class="header" id="listing_40">#.MarkAPL.MarkAPL.ProcessMarkAPLExtensions &mdash; 92%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessMarkAPLExtensions ns</code>
<code> [1]  ⍝ Converts `!&gt; ` and `=&gt;` to &lt;details&gt; and &lt;summary&gt;</code>
<code> [2]   r←0</code>
<code> [3]   noOfLines←+/∧\~ns.emptyLines</code>
<code> [4]   list←noOfLines↑ns.markdown</code>
<code> [5]   (b1 b2)←{b1←'!&gt; '∘≡¨⍵ ⋄ b2←'=&gt; '∘≡¨⍵ ⋄ b1 b2}3↑¨list</code>
<code> [6]   :If 1≤+/b2</code>
<code> [7]       :If 1=+/b1</code>
<code> [8]           ⍝ It's a single collapsible</code>
<code> [9]           b←b1∨b2</code>
<code> [10]          list2←3↓¨b/list</code>
<code> [11]          html←⊂'&lt;div class="collapsible"&gt;'</code>
<code> [12]          html,←⊂'&lt;details&gt;'</code>
<code> [13]          html,←⊂'&lt;summary&gt;'</code>
<code> [14]          summary←1⊃list2</code>
<code> [15]          list2←1↓list2</code>
<code> [16]          header←{⍵↓⍨3⌊+/∧\' '=⍵}summary         ⍝ Remove up to three spaces</code>
<code> [17]          :If 0&lt;noOfHashes←+/∧\'#'=header        ⍝ Any leading "#" at all?</code>
<code> [18]          :AndIf 7&gt;noOfHashes                    ⍝ But not more than 6</code>
<code> [19]          :AndIf ' '=1⍴noOfHashes↓header         ⍝ The first char after the last leading # must be a space</code>
<code> [20]          :AndIf 0&lt;≢(noOfHashes+1)↓header        ⍝ There must be something left which is the text of the header</code>
<code> [21]              header←noOfHashes{h←⍕⍺ ⋄ '&lt;h',h,'&gt;',⍵,'&lt;/h',h,'&gt;'}(1+noOfHashes)↓header</code>
<code> [22]              html,←1⍴ConvertH1AndH2HeadersToH3⊂header</code>
<code> [23]          :Else</code>
<code> [24]              html,←1⍴ConvertH1AndH2HeadersToH3⊂summary</code>
<code> [25]          :EndIf</code>
<code> [26]          html,←⊂'&lt;/summary&gt;'</code>
<code> [27]          html,←⊂'&lt;div class="collapsible-content"&gt;'</code>
<code> [28]          html,←⊂'&lt;hr&gt;'</code>
<code> [29]          html,←1⊃ConvertMarkdown2HTML list2</code>
<code> [30]          html,←⊂'&lt;/div&gt;'</code>
<code> [31]          html,←⊂'&lt;/details&gt;'</code>
<code> [32]          html,←⊂'&lt;/div&gt;'</code>
<code> [33]          ns.html,←html</code>
<code> [34]      :Else</code>
<code> [35]          ⍝ It's multiple collapsibles and therefore an accordian</code>
<code> [36]          html←⊂'&lt;div class="accordion"&gt;'</code>
<code> [37]          :For ind :In ⍸b1</code>
<code> [38]              b←1,∧\ind↓b2</code>
<code> [39]              list2←3↓¨b/(ind-1)↓list</code>
<code> [40]              html,←⊂'&lt;div&gt;'</code>
<code> [41]              html,←⊂'&lt;details&gt;'</code>
<code> [42]              html,←⊂'&lt;summary&gt;'</code>
<code> [43]              summary←1⊃list2</code>
<code> [44]              list2←1↓list2</code>
<code> [45]              header←{⍵↓⍨3⌊+/∧\' '=⍵}summary         ⍝ Remove up to three spaces</code>
<code> [46]              :If 0&lt;noOfHashes←+/∧\'#'=header        ⍝ Any leading "#" at all?</code>
<code class="emphasize">→[47]              :AndIf 7&gt;noOfHashes                    ⍝ But not more than 6</code>
<code class="emphasize">→[48]              :AndIf ' '=1⍴noOfHashes↓header         ⍝ The first char after the last leading # must be a space</code>
<code class="emphasize">→[49]              :AndIf 0&lt;≢(noOfHashes+1)↓header        ⍝ There must be something left which is the text of the header</code>
<code class="emphasize">→[50]                  header←noOfHashes{h←⍕⍺ ⋄ '&lt;h',h,'&gt;',⍵,'&lt;/h',h,'&gt;'}(1+noOfHashes)↓header</code>
<code class="emphasize">→[51]                  html,←1⍴ConvertH1AndH2HeadersToH3⊂header</code>
<code> [52]              :Else</code>
<code> [53]                  html,←1⍴ConvertH1AndH2HeadersToH3⊂summary</code>
<code> [54]              :EndIf</code>
<code> [55]              html,←⊂'&lt;/summary&gt;'</code>
<code> [56]              html,←⊂'&lt;div class="accordion-content"&gt;'</code>
<code> [57]              html,←⊂'&lt;hr&gt;'</code>
<code> [58]              html,←1⊃ConvertMarkdown2HTML list2</code>
<code> [59]              html,←⊂'&lt;/div&gt;'</code>
<code> [60]              html,←⊂'&lt;/details&gt;'</code>
<code> [61]              html,←⊂'&lt;/div&gt;'</code>
<code> [62]          :EndFor</code>
<code> [63]          html,←⊂'&lt;/div&gt;'</code>
<code> [64]          ns.html,←html</code>
<code> [65]      :EndIf</code>
<code> [66]      ns.noOf←noOfLines</code>
<code> [67]      ns←Drop ns</code>
<code> [68]      ∆LastLineWasEmpty←1</code>
<code> [69]      r←1</code>
<code> [70]  :EndIf</code>
<code> [71] ⍝Done</code>
</div>
<code class="header" id="listing_41">#.MarkAPL.MarkAPL.InjectCssIntoHtml &mdash; 94%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←type InjectCssIntoHtml parms</code>
<code> [1]  ⍝ Inject zero, one or many CSS files and embrace them with a &lt;style&gt; tag.</code>
<code> [2]  ⍝ The CSS is converted into a single line if `compressCSS` is 1.</code>
<code> [3]  ⍝ The parameter `tocCaption` is honoured.</code>
<code> [4]   'Invalid CSS media type'⎕SIGNAL 11/⍨0=+/(⊂type)∊'screen' 'print'</code>
<code> [5]   cssFiles←','A.Split parms.⍎type,'CSS'</code>
<code> [6]   html←''</code>
<code> [7]   :For cssFile :In cssFiles</code>
<code> [8]       :If 0=≢parms.cssURL</code>
<code class="emphasize">→[9]           cssFile_←cssFile</code>
<code> [10]      :Else</code>
<code> [11]          cssFile_←parms.cssURL,'/',cssFile</code>
<code> [12]      :EndIf</code>
<code> [13]      css←⊃⎕NGET(MassageFilename cssFile_)1</code>
<code> [14]      :If type≡'screen'</code>
<code> [15]      :AndIf 0≠≢blockNo←'&lt;&lt;maxwidth&gt;&gt;'⎕S 2⊣css</code>
<code> [16]          blockNo+←1</code>
<code> [17]          (blockNo⊃css)←'max-width:',({' '=1↑0⍴⍵:⍵,(0=≢⍵~⎕D)/'px' ⋄ (⍕⍵),'px'}parms.width),';'</code>
<code> [18]      :EndIf</code>
<code> [19]      css←2 InsertTocCaption parms css</code>
<code> [20]      css←{CompressCSS 2↓⊃,/(⎕UCS 13 10)∘,¨⍵}⍣parms.compressCSS⊣css</code>
<code> [21]      html,←,⊆css</code>
<code> [22]  :EndFor</code>
<code> [23]  :If 0≠≢html</code>
<code> [24]      html←(⊂'&lt;style media="',type,'"&gt;'),html,(⊂'&lt;/style&gt;')</code>
<code> [25]  :EndIf</code>
<code> [26] ⍝Done</code>
</div>
<code class="header" id="listing_42">#.MarkAPL.MarkAPL.HandleAbbreviations &mdash; 95%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←HandleAbbreviations ns</code>
<code> [1]   :If 0≠≢ns.abbreviations</code>
<code> [2]       html←ns.html</code>
<code> [3]       :For abbr comment :In ↓ns.abbreviations</code>
<code> [4]           comment←2 EscapeSpecialChars comment</code>
<code> [5]           :If ns.parms.syntaxSugar</code>
<code> [6]               comment←ns.parms SmartStuff comment</code>
<code> [7]               comment_←'&amp;'⎕R'\\&amp;'⊣comment         ⍝ &amp; is a reserved character (Dyalog, not PCRE!)</code>
<code> [8]           :Else</code>
<code class="emphasize">→[9]               comment_←{b←'&amp;'=w←⍵ ⋄ (b/w)←⊂'\&amp;' ⋄ ⊃,/w}comment_      ⍝ Escape "&amp;"</code>
<code> [10]          :EndIf</code>
<code> [11]          tag1←'&lt;abbr title="',comment_,'"&gt;\&amp;ldquo;',abbr,'\&amp;rdquo;&lt;/abbr&gt;'   ⍝ &amp;ldquo;=left double quote and &amp;rdquo;=right double quote</code>
<code> [12]          tag2←'&lt;abbr title="',comment_,'"&gt;',abbr,'&lt;/abbr&gt;'</code>
<code> [13]          match2←{0=+/b←'&amp;'=w←⍵:w ⋄ (b/w)←⊂'&amp;amp;' ⋄ ⊃,/w}abbr</code>
<code> [14]          match1←'"',match2,'"'</code>
<code> [15]          match2←'\b',match2,'\b'</code>
<code> [16]          ignore←'&lt;img.*&gt;' '&lt;a .*&gt;.*&lt;/a&gt;' '&lt;code&gt;.*&lt;/code&gt;' '&lt;code .*&gt;.*&lt;/code&gt;'</code>
<code> [17]          ignore,←⊂'&lt;abbr .*&gt;[^&lt;]*&lt;/abbr&gt;'       ⍝ Abbreviations themselves should be left alone</code>
<code> [18]          ignore,←⊂'&lt;dt&gt;.*&lt;/dt&gt;'                 ⍝ The keyword of a definition should not become an &lt;abbr&gt; tag.</code>
<code> [19]          ignore,←⊂'&lt;dt .*&gt;.*&lt;/dt&gt;'              ⍝ Same in case of special attributes</code>
<code> [20]          html←(ignore,match1 match2)⎕R((,¨(≢ignore)⍴'&amp;'),tag1 tag2)⍠('Mode' 'D')('DotAll' 1)('Greedy' 0)⊣html</code>
<code> [21]      :EndFor</code>
<code> [22]      ns.html←html</code>
<code> [23]  :EndIf</code>
</div>
<code class="header" id="listing_43">#.MarkAPL.MarkAPL.Init &mdash; 95%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←Init(parms markdown)</code>
<code> [1]  ⍝ Creates a namespace "ns" that contains important stuff needed to process `markdown`.</code>
<code> [2]  ⍝ See "MarkAPL.html" for details.</code>
<code> [3]   :Access Public Shared</code>
<code> [4]   parms←CompileParms parms</code>
<code> [5]   markdown←GetMarkdown markdown</code>
<code> [6]   ns←Create_NS ⍬</code>
<code> [7]   ns.markdown←A.DTB(,⊆markdown),⊂''</code>
<code> [8]   ns.lineNumbers←⍳≢ns.markdown                ⍝ Useful for reporting problems</code>
<code> [9]   ns.parms←parms</code>
<code> [10]  ns←parms.ignoreEmbeddedParms ProcessEmbeddedParms ns</code>
<code> [11]  ns←RemoveAllComments ns</code>
<code> [12]  ns←parms ProcessLeanPubExtensions ns</code>
<code> [13]  :If IsLeanPubEncodingLine⊃ns.markdown</code>
<code class="emphasize">→[14]      ns.markdown[1]←⊂''</code>
<code> [15]  :EndIf</code>
<code> [16]  ns.markdownLC←⎕C ns.markdown                ⍝ We need this often, so we do this ONCE</code>
<code> [17]  buffer←A.DLB ns.markdown</code>
<code> [18]  ns.emptyLines←GetEmptyLines buffer</code>
<code> [19]  ns.leadingChars←(16⌊≢¨ns.markdown)↑¨buffer</code>
<code> [20]  ns.withoutBlanks←ns.markdown~¨' '</code>
<code> [21]  :If (,0)≢,ns.parms.toc</code>
<code> [22]      ns.parms.bookmarkLink⌈←⌈/ns.parms.toc</code>
<code> [23]  :EndIf</code>
<code> [24]  ns.parms.head←,⊆ns.parms.head</code>
<code> [25]  LowercaseID←(1≡parms.lowercaseID)∘{(⎕C⍣⍺)⍵} ⍝ Lowercase ⍵ in case parms.lowercaseID is 1</code>
<code> [26] ⍝Done</code>
</div>
<code class="header" id="listing_44">#.MarkAPL.MarkAPL.Process &mdash; 95%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←Process ns</code>
<code> [1]  ⍝ Takes a namespace, typically created by calling `Init`, and then processes `ns.markdown`,</code>
<code> [2]  ⍝ creating ns.html along the way.</code>
<code> [3]  ⍝</code>
<code> [4]  ⍝ The result is all MarkDown converted to HTML but not a fully-fledged HTML document. In order to</code>
<code> [5]  ⍝ achieve that call `MakeHTML_Doc` in the next step.</code>
<code> [6]   :Access Public Shared</code>
<code> [7]   ns.noOf←1               ⍝ Minimum number of lines to be removed from ns.(markdown leadingChars emptyLines) per cycle.</code>
<code> [8]   ns←CheckForInvalidFootnotes1 ns</code>
<code> [9]   ns←ScanMarkdown ns</code>
<code> [10]  ns←NumberHeaders ns</code>
<code> [11]  ns.toc←CollectToc ns</code>
<code> [12]  ns←SetTitle ns</code>
<code> [13]  ns←InjectTOC ns</code>
<code> [14]  ns←InjectSubTOCs ns</code>
<code> [15]  ns←ReplaceLinkIDs ns</code>
<code> [16]  ns←ReportLinks ns</code>
<code> [17]  ns←InjectFootNotes ns</code>
<code> [18]  ns←HandleAbbreviations ns</code>
<code> [19]  ns←CheckInternalLinks ns</code>
<code> [20]  ns←CheckForInvalidFootnotes2 ns</code>
<code> [21]  ns←PolishWarnings ns</code>
<code> [22]  :If A.IsDevelopment</code>
<code> [23]  :AndIf ns.parms.verbose</code>
<code> [24]  :AndIf 0≠≢ns.report</code>
<code class="emphasize">→[25]      ⎕←⍪ns.report</code>
<code> [26]  :EndIf</code>
<code> [27]  ns.html←{1=≡⍵:⍵ ⋄ ⊃,/⊃⍵}¨ns.html</code>
<code> [28] ⍝Done</code>
</div>
<code class="header" id="listing_45">#.MarkAPL.MarkAPL.ProcessEmbeddedParms_ &mdash; 95%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←i ProcessEmbeddedParms_ def</code>
<code> [1]  ⍝ `def` is a single definition (like `[parm]:name=value`) or a blank or comment line or a LeanPub directive.</code>
<code> [2]  ⍝ Returns the number of succesdsfully established key/value pairs.</code>
<code> [3]  ⍝ Is called by `ProcessEmbeddedParms` and requiresd access to `ns`/</code>
<code> [4]   r←0</code>
<code> [5]   allowed←CreateParms.∆List[;1]                                     ⍝ List of allowed parameter names</code>
<code> [6]   :If '='∊def                                                       ⍝ A definition MUST contain this</code>
<code> [7]       (key value)←¯1 0↓¨((≢'[parm]:'),0)↓¨{i←⍵⍳'=' ⋄ (i↑⍵)(i↓⍵)}def ⍝ Split into name and value</code>
<code> [8]       key~←' '</code>
<code> [9]       :If 0=≢value←A.DLB A.DTB value                                    ⍝ Empty values do not make sense</code>
<code> [10]          ns.report,←⊂'Parameter definition on line ',(⍕i),' is invalid'</code>
<code> [11]      :Else</code>
<code> [12]          :If ''''∊value</code>
<code> [13]              :If ''''''≡2⍴¯1⌽value</code>
<code> [14]                  value←¯1↓1↓value</code>
<code> [15]              :Else</code>
<code> [16]                  value←''</code>
<code> [17]                  ns.report,←⊂'Parameter value definition for line ',(⍕⊃i),' is invalid'</code>
<code> [18]              :EndIf</code>
<code> [19]          :ElseIf '⎕null'{⍺≡⎕C(≢⍺)↑⍵}value</code>
<code class="emphasize">→[20]              value←⎕NULL</code>
<code> [21]          :Else</code>
<code> [22]              (b v)←⎕VFI value</code>
<code> [23]              :If ∧/b</code>
<code> [24]                  value←{1=≢⍵:⍬⍴⍵ ⋄ ⍵}v</code>
<code> [25]              :EndIf</code>
<code> [26]          :EndIf</code>
<code> [27]      :EndIf</code>
<code> [28]      ns.embeddedParms⍪←key value</code>
<code> [29]      ⍎'ns.parms.',key,'←value'</code>
<code> [30]  :Else</code>
<code> [31]      ns.report,←⊂'Parameter definition on line ',(⍕i),' is invalid'</code>
<code> [32]  :EndIf</code>
</div>
<code class="header" id="listing_46">#.MarkAPL.MarkAPL.ProcessTable_ &mdash; 95%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessTable_ ns</code>
<code> [1]   :Trap (~ns.parms.debug)/0</code>
<code> [2]       specialAttrs←GetSpecialAttributes⊃ns.markdown</code>
<code> [3]       ns.html,←⊂{0=≢⍵:'&lt;table&gt;' ⋄ '&lt;table',⍵,'&gt;'}specialAttrs</code>
<code> [4]       :If {∧/'-'='|: '~⍨⍵}2⊃ns.markdown</code>
<code> [5]           ns.html,←⊂'&lt;thead&gt;'</code>
<code> [6]           ns.html,←⊂'&lt;tr&gt;'</code>
<code> [7]           ind←{~':'∊⍵:1 ⋄ '::'≡2⍴¯1⌽⍵:3 ⋄ ':'=1⍴⍵:2 ⋄ 4}¨' '~¨⍨SplitTableRowButMaskCode 2⊃ns.markdown</code>
<code> [8]           align←↑¨ind⌷¨⊂'?' 'left' 'center' 'right'</code>
<code> [9]           head←SplitTableRowButMaskCode specialAttrs DropSpecialAttributes 1⊃ns.markdown</code>
<code> [10]          head←ns{⍺ CheckOddNumberOfDoubleQuotes ⍵'header'}¨head</code>
<code> [11]          head←⊃¨ns ProcessInlineMarkUp¨head</code>
<code> [12]          :If ns.parms.syntaxSugar</code>
<code> [13]              head←ns.parms.lang∘SmartQuotes¨head</code>
<code> [14]          :EndIf</code>
<code> [15]          drop←2</code>
<code> [16]      :Else</code>
<code> [17]          ind←{~':'∊⍵:1 ⋄ '::'≡2⍴¯1⌽⍵:3 ⋄ ':'=1⍴⍵:2 ⋄ 4}¨' '~¨⍨SplitTableRowButMaskCode 1⊃ns.markdown</code>
<code> [18]          align←↑¨ind⌷¨⊂'?' 'left' 'center' 'right'</code>
<code> [19]          drop←1</code>
<code> [20]      :EndIf</code>
<code> [21]      :If 0≠≢cells←drop↓ns.noOf↑ns.markdown</code>
<code> [22]          cells←SplitTableRowButMaskCode¨cells</code>
<code> [23]          cells←{A.DLB∘A.DTB ⍵}¨¨cells</code>
<code> [24]          cells←ns{⍺ CheckOddNumberOfDoubleQuotes ⍵'header'}¨¨cells</code>
<code> [25]          cells←⊃¨¨ns ProcessInlineMarkUp¨¨cells</code>
<code> [26]          :If ∨/b←∨/¨'?'=align</code>
<code> [27]              noOfCols←⌈/(≢align),≢¨cells</code>
<code> [28]              b←noOfCols↑b</code>
<code> [29]              :If (≢align)&gt;noOfCols</code>
<code class="emphasize">→[30]                  cells←cells,¨((≢align)-noOfCols)⍴(⊃⌈/≢¨cells)⍴⊂,' '</code>
<code> [31]              :ElseIf (≢align)&lt;noOfCols</code>
<code> [32]                  align←noOfCols↑align,noOfCols⍴⊂'left'</code>
<code> [33]              :EndIf</code>
<code> [34]              :If noOfCols∨.≠≢¨cells</code>
<code> [35]                  cells←noOfCols↑¨cells,¨noOfCols⍴¨⊂,' '</code>
<code> [36]              :EndIf</code>
<code> [37]              buff←⍉↑b∘/¨cells</code>
<code> [38]              buff[;⍸∧⌿buff∧.=¨'=']←'0'</code>
<code> [39]              (b/align)←('left' 'right')[{{0=≢⍵~' ':1 ⋄ 1+⊃∧/⊃⎕VFI ⍵}⊃,/' ',¨⍵}¨↓buff]</code>
<code> [40]          :EndIf</code>
<code> [41]      :Else</code>
<code> [42]          :If ∨/b←∨/¨'?'=align</code>
<code> [43]              (b/align)←⊂'left'</code>
<code> [44]          :EndIf</code>
<code> [45]      :EndIf</code>
<code> [46] </code>
<code> [47]      :If 2=drop</code>
<code> [48]          buff←('th'∘{⍺,⍵}¨1 AddAlignStyle¨align)Tag¨(≢align)↑head,(≢align)⍴⊂''</code>
<code> [49]          ns.html,←buff</code>
<code> [50]          ns.html,←⊂'&lt;/tr&gt;'</code>
<code> [51]          ns.html,←⊂'&lt;/thead&gt;'</code>
<code> [52]      :EndIf</code>
<code> [53]      (footer cells)←ns.parms.markdownStrict GetFooter cells</code>
<code> [54]      ns.html,←⊂'&lt;tbody&gt;'</code>
<code> [55]      rows←{('td'∘{⍺,⍵}¨2 AddAlignStyle¨align)Tag¨⍵}¨(≢align)↑¨cells</code>
<code> [56]      ns.html,←⊃,/{(⊂'&lt;tr&gt;'),⍵,⊂'&lt;/tr&gt;'}¨rows</code>
<code> [57]      ns.html,←⊂'&lt;/tbody&gt;'</code>
<code> [58]      :If 0≠≢footer</code>
<code> [59]          ns.html,←⊂'&lt;tfoot&gt;'</code>
<code> [60]          ns.html,←⊃,/{(⊂'&lt;tr&gt;'),⍵,⊂'&lt;/tr&gt;'}¨{('td'∘{⍺,⍵}¨2 AddAlignStyle¨align)Tag¨⍵}¨(≢align)↑¨footer</code>
<code> [61]          ns.html,←⊂'&lt;/tfoot&gt;'</code>
<code> [62]      :EndIf</code>
<code> [63]      ns.html,←⊂'&lt;/table&gt;'</code>
<code> [64]      ns←Drop ns</code>
<code> [65]      r←1</code>
<code> [66]  :Else</code>
<code class="emphasize">→[67]      r←1</code>
<code class="emphasize">→[68]      ns←Drop ns</code>
<code> [69]  :EndTrap</code>
<code> [70] ⍝Done</code>
</div>
<code class="header" id="listing_47">#.MarkAPL.MarkAPL.ProcessTableWithoutColTitles &mdash; 96%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessTableWithoutColTitles ns</code>
<code> [1]   r←1</code>
<code> [2]   specialAttrs←GetSpecialAttributes⊃ns.markdown</code>
<code> [3]   html←⊂{0=≢⍵:'&lt;table&gt;' ⋄ '&lt;table',⍵,'&gt;'}specialAttrs</code>
<code> [4]   cells←SplitTableRowButMaskCode¨{(⊂specialAttrs DropSpecialAttributes⊃⍵),1↓⍵}ns.noOf↑ns.markdown</code>
<code> [5]   cells←{A.DLB∘A.DTB ⍵}¨¨cells</code>
<code> [6]   cells←ns{⍺ CheckOddNumberOfDoubleQuotes ⍵'header'}¨¨cells</code>
<code> [7]   hasFooter←'='∧.={2≥≢⍵:0 ⋄ ∊(¯1+≢⍵)⊃⍵}cells</code>
<code> [8]   align←('left' 'right')[1+{∧/⊃⎕VFI∊' ',¨⍵}¨↓⍉↑hasFooter{1=⍺:1↓¯2⌽⍵ ⋄ ⍵}cells]</code>
<code> [9]   :If {(∧/⍵∊' -:')∧('-'∊⍵)}↑,/1⊃cells</code>
<code class="emphasize">→[10]      cells←1↓cells</code>
<code> [11]  :EndIf</code>
<code> [12]  cells←⊃¨¨ns ProcessInlineMarkUp¨¨cells</code>
<code> [13]  (footer cells)←ns.parms.markdownStrict GetFooter cells</code>
<code> [14]  :If 0=≢cells</code>
<code> [15]      r←0</code>
<code> [16]  :Else</code>
<code> [17]      :If 0≠≢footer</code>
<code> [18]          html,←⊂'&lt;tfoot&gt;'</code>
<code> [19]          html,←⊃,/{(⊂'&lt;tr&gt;'),⍵,⊂'&lt;/tr&gt;'}¨{('td'∘{⍺,⍵}¨2 AddAlignStyle¨align)Tag¨⍵}¨(≢align)↑¨footer</code>
<code> [20]          html,←⊂'&lt;/tfoot&gt;'</code>
<code> [21]      :EndIf</code>
<code> [22]      html,←⊂'&lt;tbody&gt;'</code>
<code> [23]      rows←{('td'∘{⍺,⍵}¨AddAlignStyle¨align)Tag¨⍵}¨(⊃⌈/≢¨cells)↑¨cells</code>
<code> [24]      html,←⊃,/{(⊂'&lt;tr&gt;'),⍵,⊂'&lt;/tr&gt;'}¨rows</code>
<code> [25]      html,←⊂'&lt;/tbody&gt;'</code>
<code> [26]      html,←⊂'&lt;/table&gt;'</code>
<code> [27]      ns.html,←html</code>
<code> [28]      ns←Drop ns</code>
<code> [29]  :EndIf</code>
<code> [30] ⍝Done</code>
</div>
<code class="header" id="listing_48">#.MarkAPL.MarkAPL.EscapeSpecialChars &mdash; 97%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←{opCode}EscapeSpecialChars tx</code>
<code> [1]  ⍝ ⍵ is typically a line of a Markdown document.</code>
<code> [2]  ⍝ Code is **not** masked here: we need to exchange "&lt;&gt;&amp;" even in code.</code>
<code> [3]  ⍝ See `EscapeSpecialCharsOutsideCode` if you don't want this to happen.</code>
<code> [4]  ⍝ However, don't touch anything between "" inside &lt;&gt; (attribute definitions).</code>
<code> [5]  ⍝ ⍺ may be 1 or 2 and defaults to 1; that means that "&lt;&lt;" remains untouched.</code>
<code> [6]  ⍝ If ⍺ is 2 (typically ⍵ is nothing but codethen) "&amp;&lt;&gt;" are all converted.</code>
<code> [7]  ⍝ The opcode allows for faster operation.</code>
<code> [8]   opCode←{0&lt;⎕NC ⍵:⍎⍵ ⋄ 1}'opCode'</code>
<code> [9]   :If 0&lt;≢r←tx</code>
<code> [10]      :If opCode=1</code>
<code> [11]          :If ∨/b←GetMaskForCode tx</code>
<code> [12]              buff←b/tx</code>
<code> [13]              b1←buff='&amp;'</code>
<code> [14]              b2←buff='&lt;'</code>
<code> [15]              b3←buff='&gt;'</code>
<code> [16]              (b1/buff)←⊂'&amp;amp;'</code>
<code> [17]              (b2/buff)←⊂'&amp;lt;'</code>
<code> [18]              (b3/buff)←⊂'&amp;gt;'</code>
<code> [19]              (b/tx)←buff</code>
<code> [20]              tx←⊃,/tx</code>
<code> [21]          :EndIf</code>
<code> [22]          ignore←''</code>
<code> [23]          ignore,←⊂'`[^`]+`'                     ⍝ Code blocks</code>
<code> [24]          ignore,←⊂'&lt;!--.+--&gt;'                   ⍝ SGML comments</code>
<code> [25]          ignore,←⊂'&lt;![CDATA[.+]]&gt;'              ⍝ SGML CDATA section</code>
<code> [26]          ignore,←⊂'\&amp;[a-z][a-z0-9]*;'           ⍝ HTML entities by name</code>
<code> [27]          ignore,←⊂'\&amp;#[0-9][0-9]*;'             ⍝ HTML entities by number</code>
<code> [28]          :If ns.parms.syntaxSugar</code>
<code> [29]              ignore,←⊂'(?&lt;!&lt;)&lt;&lt;(?!&lt;)'</code>
<code> [30]              ignore,←⊂'(?&lt;!&gt;)&gt;&gt;(?!&gt;)'</code>
<code> [31]          :EndIf</code>
<code> [32]          replace←''</code>
<code> [33]          replace,←⊂'(?&lt;!\\)&amp;'                   ⍝ Not "\&amp;" ?</code>
<code> [34]          replace,←⊂'&lt;[a-zA-Z][a-zA-Z0-9]*&gt;'     ⍝ Opening tags pure</code>
<code> [35]          replace,←⊂'&lt;[a-zA-Z][a-zA-Z0-9]* .+&gt;'  ⍝ Opening tags with attributes</code>
<code> [36]          replace,←⊂'&lt;/[a-zA-Z][a-zA-Z0-9]*&gt;'    ⍝ Closing tags</code>
<code> [37]          replace,←⊂,'&lt;'</code>
<code> [38]          replace,←⊂,'&gt;'</code>
<code> [39]          replaceBy←(,¨((≢ignore)⍴'&amp;'),'\&amp;amp;' '\0' '\0' '\0' '\&amp;lt;' '\&amp;gt;')</code>
<code> [40]          r←(ignore,replace)⎕R replaceBy⊣tx</code>
<code> [41]      :ElseIf opCode=2</code>
<code> [42]          r←'&lt;'⎕R'\&amp;lt;'⊣'&gt;'⎕R'\&amp;gt;'⊣'\&amp;'⎕R'&amp;amp;'⊣tx</code>
<code> [43]      :Else</code>
<code class="emphasize">→[44]          .                                      ⍝ Huh?! Invalid left argument</code>
<code> [45]      :EndIf</code>
<code> [46]  :EndIf</code>
<code> [47] ⍝Done</code>
</div>
<code class="header" id="listing_49">#.MarkAPL.MarkAPL.ProcessList &mdash; 97%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>   r←ProcessList ns</code>
<code> [1]   ⍝ Processing lists is more complex than one would think at first glance for several reasons:</code>
<code> [2]   ⍝ * Lists can be nested at any level.</code>
<code> [3]   ⍝ * A nested list can have a different type.</code>
<code> [4]   ⍝ * Changing the bullet char for bulleted lists (+-*) starts a new list!</code>
<code> [5]   ⍝ * Lists may contain independent paragrahs; their level is defined by indenting.</code>
<code> [6]   ⍝ * MarkAPL allows lazy indenting: if a list item spans over several lines only the first</code>
<code> [7]   ⍝   line must be indented properly. All other lines may or may not be indented.</code>
<code> [8]   ⍝ * A single backslash at the end of an item are interpreted as "inject &lt;br&gt; here".</code>
<code> [9]    :If 0=ns.noOf←IdentifyListItems ns</code>
<code class="emphasize">→[10]       r←0</code>
<code> [11]   :Else</code>
<code> [12]       type←,(1+(⊃⊃ns.leadingChars)∊'*+-')⌷'ou'</code>
<code> [13]       bl←A.DTB GetListBlock ns.noOf↑ns.markdown</code>
<code> [14]       report←''</code>
<code> [15]       :If type='u'</code>
<code> [16]           html←,⊂'&lt;ul&gt;'</code>
<code> [17]       :Else</code>
<code> [18]           startAt←{⍵↑⍨¯1+⌊/⍵⍳'.)'}A.DLB⊃bl</code>
<code> [19]           html←,⊂'&lt;ol start="',startAt,'"&gt;'</code>
<code> [20]       :EndIf</code>
<code> [21]       i←lastWasEmpty←levelChange←0</code>
<code> [22]      ⍝ `levels` and `indentation` record almost the same thing:</code>
<code> [23]      ⍝ * `level` counts white-space until the first non-white-space character.</code>
<code> [24]      ⍝ * `indentation` does the same but then adds the length of the list-marker.</code>
<code> [25]      ⍝ The latter is needed in order to identify the level of paragraphs and code blocks within a list.</code>
<code> [26]       levels←+/∧\' '=⊃bl</code>
<code> [27]       indendations←GetLengthOfLeadingWhitespacePlusListMarker⊃bl</code>
<code> [28]       lastType←⊃A.DLB⊃bl</code>
<code> [29]       :Repeat</code>
<code> [30]           drop←1</code>
<code> [31]           i←i+1</code>
<code> [32]           :If IsHtmlList A.DLB⊃bl</code>
<code> [33]               noOfBlanks←+/∧\' '=⊃bl</code>
<code> [34]               :If noOfBlanks≠¯1↑levels</code>
<code> [35]                   :If noOfBlanks&gt;¯1↑levels</code>
<code> [36]                       type,←(1+(⊃i⊃ns.leadingChars)∊'*+-')⌷'ou'</code>
<code> [37]                       ((≢html)⊃html)←'&lt;/li&gt;'{⍵↓⍨(-≢⍺)×⍺≡(-≢⍺)↑⍵}(≢html)⊃html</code>
<code> [38]                       :If 'u'=¯1↑type</code>
<code> [39]                           html,←⊂'&lt;ul&gt;'</code>
<code> [40]                       :Else</code>
<code> [41]                           startAt←{⍵↑⍨¯1+⌊/⍵⍳'.)'}A.DLB⊃bl</code>
<code> [42]                           html,←⊂'&lt;ol start="',startAt,'"&gt;'</code>
<code> [43]                       :EndIf</code>
<code> [44]                       levels,←noOfBlanks</code>
<code> [45]                       indendations,←GetLengthOfLeadingWhitespacePlusListMarker⊃bl</code>
<code> [46]                       lastType,←⊃A.DLB⊃bl</code>
<code> [47]                   :Else</code>
<code> [48]                       levelChange←+/∧\(⌽levels)&gt;noOfBlanks</code>
<code> [49]                       html,←({'&lt;/',(¯1↑⍵),'l&gt;'}¨⌽(-levelChange)↑type),¨⊂'&lt;/li&gt;'</code>
<code> [50]                       (levels indendations lastType type)←(-levelChange)↓¨levels indendations lastType type</code>
<code> [51]                   :EndIf</code>
<code> [52]               :ElseIf 0≠≢⊃bl</code>
<code> [53]               :AndIf (¯1↑lastType){~⍺∊'+-*':~⍵∊⎕D ⋄ ⍺≠⍵}⊃A.DLB⊃bl</code>
<code> [54]                   html,←⊂'&lt;/',(¯1↑type),'l&gt;'</code>
<code> [55]                   ((≢type)⊃type)←(1+(⊃i⊃ns.leadingChars)∊'*+-')⌷'ou'</code>
<code> [56]                   lastType,←⊃A.DLB⊃bl</code>
<code> [57]                   :If 'u'=¯1↑type</code>
<code> [58]                       html,←⊂'&lt;ul&gt;'</code>
<code> [59]                   :Else</code>
<code> [60]                       startAt←{⍵↑⍨¯1+⍵⍳'.'}A.DLB⊃bl</code>
<code> [61]                       html,←⊂'&lt;ol start="',startAt,'"&gt;'</code>
<code> [62]                   :EndIf</code>
<code> [63]               :EndIf</code>
<code> [64]           :EndIf</code>
<code> [65]           :If 0=≢' '~⍨⊃bl</code>
<code> [66]               lastWasEmpty←1</code>
<code> [67]           :Else</code>
<code> [68]               :If IsHtmlList A.DLB⊃bl</code>
<code> [69]                   (drop item)←CollectItem bl</code>
<code> [70]                   :If 0≠≢sa←GetSpecialAttributes⊃bl</code>
<code> [71]                       :If (⊂3↑(≢html)⊃html)∊'&lt;ul' '&lt;ol'</code>
<code> [72]                           ((≢html)⊃html)←(¯1↓((≢html)⊃html)),sa,'&gt;'</code>
<code> [73]                           item←A.DLB A.DTB sa DropSpecialAttributes item</code>
<code> [74]                       :EndIf</code>
<code> [75]                   :Else</code>
<code> [76]                       item←A.DLB A.DTB item</code>
<code> [77]                   :EndIf</code>
<code> [78]                   i←i+drop-1</code>
<code> [79]                   item←ns CheckOddNumberOfDoubleQuotes item'list item'</code>
<code> [80]                   :If '\'=¯1↑item</code>
<code class="emphasize">→[81]                       item,←'&lt;br&gt;'</code>
<code> [82]                   :EndIf</code>
<code> [83]                   buff←⊃¯1↑html</code>
<code> [84]                   :If ~(⊂{' '~⍨{⍵↑⍨⌊/⍵⍳' &gt;'}{⌽⍵↑⍨⍵⍳'&lt;'}⌽⍵}buff)∊'&lt;/ul&gt;' '&lt;/ol&gt;' '&lt;/li&gt;' '&lt;ul' '&lt;ol' '&lt;ul&gt;' '&lt;ol&gt;'</code>
<code class="emphasize">→[85]                       (¯1↑html)←⊂buff,'&lt;/li&gt;'</code>
<code> [86]                   :EndIf</code>
<code> [87]                   buff3←⊃ns ProcessInlineMarkUp{A.DLB ⍵↓⍨⍵⍳' '},item</code>
<code> [88]                   html,←⊂'&lt;li&gt;',(A.DLB buff3),'&lt;/li&gt;'</code>
<code> [89]                   lastWasEmpty←0</code>
<code> [90]               :Else</code>
<code> [91]                   noOfBlanks←+/∧\' '=⊃bl</code>
<code> [92]                   :If (¯1↑indendations){0=⍵:0 ⋄ ⍵≠⍺}noOfBlanks          ⍝ The level has changed</code>
<code> [93]                       :If noOfBlanks∊indendations                       ⍝ Did the user get the indentation right?</code>
<code> [94]                           levelChange←¯1+(⌽indendations)⍳noOfBlanks</code>
<code> [95]                       :Else                                             ⍝ No he did not.</code>
<code> [96]                           levelChange←0⌈¯1++/indendations&lt;noOfBlanks    ⍝ Let's get as close as possible</code>
<code> [97]                       :EndIf</code>
<code> [98]                       :If 0≠levelChange</code>
<code> [99]                           :If '&gt;'=¯1↑buff←⊃¯1↑html</code>
<code> [100]                          :AndIf ~(⊂{⌽⍵↑⍨⍵⍳'&lt;'}⌽buff)∊'&lt;/ul&gt;' '&lt;/ol&gt;' '&lt;ul&gt;' '&lt;ol&gt;'</code>
<code> [101] ⍝                                  (¯1↑html)←⊂buff,'&lt;/li&gt;'</code>
<code> [102]                          :EndIf</code>
<code> [103]                          html,←({'&lt;/',⍵,'l&gt;'}¨(-levelChange)↑type),¨⊂'&lt;/li&gt;'</code>
<code> [104]                          (type levels indendations lastType)←(-levelChange)↓¨type levels indendations lastType</code>
<code> [105]                      :EndIf</code>
<code> [106]                  :EndIf</code>
<code> [107]                  :If lastWasEmpty</code>
<code> [108]                      buff←⊃bl</code>
<code> [109]                      :If 0≠≢cb←(¯1↑indendations)GetCodeBlockFrom bl</code>
<code> [110]                          sa←GetSpecialAttributes⊃cb</code>
<code> [111]                          infoString←(¯1↑indendations)GetInfoString⊃cb</code>
<code> [112]                          :If (+/∧\' '=⊃cb)≥⊃noOfBlanks                  ⍝ Max number of spaces is the indentation</code>
<code> [113]                              cb←MassageCodeBlock cb noOfBlanks</code>
<code> [114]                              cb←¯1↓1↓cb</code>
<code> [115]                              :If 0&lt;+/≢¨cb~¨' '</code>
<code> [116]                                  buff2←⊃¯1↑html</code>
<code> [117]                                  :If '&lt;/li&gt;'{⍺≡(-≢⍺)↑⍵}buff2</code>
<code> [118]                                      buff2←(-≢'&lt;/li&gt;')↓buff2</code>
<code> [119]                                      (¯1↑html)←⊂buff2</code>
<code> [120]                                  :EndIf</code>
<code> [121]                                  html,←MarkUpAsCode(2 EscapeSpecialChars¨cb)sa infoString</code>
<code> [122]                                  (¯1↑html)←⊂(⊃¯1↑html),'&lt;/li&gt;'</code>
<code> [123]                              :EndIf</code>
<code> [124]                              drop←2+≢cb</code>
<code> [125]                              i+←1+≢cb</code>
<code> [126]                          :EndIf</code>
<code> [127]                      :ElseIf '|'=⊃A.DLB buff                             ⍝ Is it a table?</code>
<code> [128]                      :AndIf (+/∧\' '=buff)≥⊃noOfBlanks                 ⍝ Max number of spaces is the indentation</code>
<code> [129]                          drop←+/∧\'|'=,1↑[2]A.DLB↑bl</code>
<code> [130]                          buff←drop↑bl</code>
<code> [131]                          parms←CreateParms</code>
<code> [132]                          parms←ns.parms CopyTo parms</code>
<code> [133]                          parms.lineNumberOffset←⊃ns.lineNumbers</code>
<code> [134]                          ns2←Init parms(A.DLB buff)</code>
<code> [135]                          ns2←Process ns2</code>
<code> [136]                          report,←ns2.report</code>
<code> [137]                          ((≢html)⊃html)←(-≢'&lt;/li&gt;')↓(≢html)⊃html</code>
<code> [138]                          html,←ns2.html</code>
<code> [139]                          ((≢html)⊃html),←'&lt;/li&gt;'</code>
<code> [140]                      :ElseIf '&gt; '≡2⍴A.DLB buff                           ⍝ Is it a blockquote?</code>
<code> [141]                          ns3←⎕NS''</code>
<code> [142]                          ns3.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)←(ns.noOf-≢bl)↓¨ns.noOf↑¨ns.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)</code>
<code> [143]                          drop←ScanForBlockQuotes ns3</code>
<code> [144]                          parms←CreateParms</code>
<code> [145]                          parms.bookmarkLink←0</code>
<code> [146]                          parms.markdownStrict←ns.parms.markdownStrict</code>
<code> [147]                          parms.verbose←0</code>
<code> [148]                          parms.checkLinks←0</code>
<code> [149]                          parms.checkFootnotes←0</code>
<code> [150]                          parms.subTocs←0</code>
<code> [151]                          parms.syntaxSugar←ns.parms.syntaxSugar</code>
<code> [152]                          parms.lineNumberOffset←⊃ns.lineNumbers</code>
<code> [153]                          md←noOfBlanks↓¨drop↑ns3.markdown</code>
<code> [154]                          ns2←Init parms md</code>
<code> [155]                          ns2←Process ns2</code>
<code> [156]                          ((≢html)⊃html)←(-≢'&lt;/li&gt;')↓(≢html)⊃html</code>
<code> [157]                          html,←ns2.html</code>
<code> [158]                          ((≢html)⊃html),←'&lt;/li&gt;'</code>
<code> [159]                          report,←ns2.report</code>
<code> [160]                      :Else</code>
<code> [161]                          (drop para)←CollectItemPara bl</code>
<code> [162]                          i←i+drop-1</code>
<code> [163]                          :If '!['{⍺≡(≢⍺)↑⍵}A.DLB buff</code>
<code> [164]                          :AndIf '![CDATA['{⍺≢(≢⍺)↑⍵}A.DLB buff</code>
<code> [165]                          :AndIf 1</code>
<code> [166]                               ⍝ Regular expression needed that catches the image.</code>
<code> [167]                               ⍝ If nothing is left then any special attributes belong to the image rather than the paragraph.</code>
<code> [168]                               ⍝ OR: The definition of images is wrong and special attributes MUST be specified inside the ()!!!!</code>
<code> [169]                               ⍝ (That's much more likely!)</code>
<code> [170]                              sa←'' ⍝ then any special attributes</code>
<code> [171]                          :Else</code>
<code> [172]                              sa←GetSpecialAttributes para</code>
<code> [173]                          :EndIf</code>
<code> [174]                          para←A.DTB sa DropSpecialAttributes para</code>
<code> [175]                          buff←⊃¯1↑html</code>
<code> [176]                          :If '&lt;/li&gt;'≡({{⌽⍵↑⍨⍵⍳'&lt;'}⌽⍵}buff)</code>
<code> [177]                              buff←(-≢'&lt;/li&gt;')↓buff</code>
<code> [178]                              (¯1↑html)←⊂buff</code>
<code> [179]                          :EndIf</code>
<code> [180]                          buff3←⊃ns ProcessInlineMarkUp para</code>
<code> [181]                          html,←⊂'&lt;p',sa,'&gt;',(A.DLB buff3),'&lt;/p&gt;&lt;/li&gt;'</code>
<code> [182]                      :EndIf</code>
<code> [183]                  :Else</code>
<code class="emphasize">→[184]                      html,←⊂'&lt;p&gt;',(⊃bl),'&lt;/p&gt;'</code>
<code> [185]                  :EndIf</code>
<code> [186]                  lastWasEmpty←0</code>
<code> [187]              :EndIf</code>
<code> [188]          :EndIf</code>
<code> [189]          bl←drop↓bl</code>
<code> [190]      :Until 0=≢bl</code>
<code> [191]      html,←({'&lt;/',(¯1↑⍵),'l&gt;'}¨⌽type),¨((¯1+≢type)⍴⊂'&lt;/li&gt;'),⊂''</code>
<code> [192]      html←InjectBR¨html</code>
<code> [193]      ns.html,←html</code>
<code> [194]      ns←Drop ns</code>
<code> [195]      r←1</code>
<code> [196]  :EndIf</code>
</div>
<code class="header" id="listing_50">#.MarkAPL.MarkAPL.CreateParms &mdash; 98%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←CreateParms</code>
<code> [1]  ⍝ Returns a parameter namespace with default values. Use method `∆List` to list all names and their values.\\</code>
<code> [2]  ⍝ For a documentation of all parameters refer to the MarkAPL reference. Call `MarkAPL.Reference 0` for that.</code>
<code> [3]   r←⎕NS''</code>
<code> [4]   clp←GetCommandLineParms''</code>
<code> [5]   SetTo←{0=clp.⎕NC ⍺:⍎'r.',⍺,'←⍵' ⋄ ⍎'r.',⍺,'←clp.⍎⍺'}  ⍝ Take command line parms or default</code>
<code> [6]   'bookmarkLink'SetTo 6</code>
<code> [7]   'bookmarkMayStartWithDigit'SetTo 1</code>
<code> [8]   r.debug←A.IsDevelopment</code>
<code> [9]   'charset'SetTo'utf-8'</code>
<code> [10]  'checkFootnotes'SetTo r.debug</code>
<code> [11]  'checkLinks'SetTo r.debug</code>
<code> [12]  'collapsibleTOC'SetTo 0</code>
<code> [13]  'compressCSS'SetTo 1</code>
<code> [14]  'copy2ClipboardBtn'SetTo 1</code>
<code> [15]  'createFullHtmlPage'SetTo ¯1</code>
<code> [16]  'cssURL'SetTo ⎕NULL</code>
<code> [17]  'div_h_tag'SetTo 1</code>
<code> [18]  'enforceEdge'SetTo 1</code>
<code> [19]  'footnotesCaption'SetTo'Footnotes'</code>
<code> [20]  'hasTOC'SetTo 0</code>
<code> [21]  'hasCodeBlock'SetTo 0</code>
<code> [22]  'hasCollapsible'SetTo 0</code>
<code> [23]  'head'SetTo''</code>
<code> [24]  :If 0&lt;##.⎕NC'TatinVars.HOME'</code>
<code> [25]      'homeFolder'SetTo⍎'##.TatinVars.HOME'</code>
<code> [26]  :Else</code>
<code class="emphasize">→[27]      'homeFolder'SetTo''</code>
<code> [28]  :EndIf</code>
<code> [29]  'ignoreEmbeddedParms'SetTo 0</code>
<code> [30]  'imageURL'SetTo''</code>
<code> [31]  'inputFilename'SetTo''</code>
<code> [32]  'lang'SetTo'en'</code>
<code> [33]  'leanpubExtensions'SetTo 0</code>
<code> [34]  'leanpubIconsUrl'SetTo'https://download.aplwiki.com/LeanPub/Images/'</code>
<code> [35]  'lineNumberOffset'SetTo 0</code>
<code> [36]  'linkToCSS'SetTo 0</code>
<code> [37]  'lowercaseID'SetTo 1</code>
<code> [38]  'markAPL_Extensions'SetTo 1</code>
<code> [39]  'markdownStrict'SetTo 0</code>
<code> [40]  'numberHeaders'SetTo 0</code>
<code> [41]  'noCSS'SetTo 0</code>
<code> [42]  'outputFilename'SetTo''</code>
<code> [43]  'printCSS'SetTo'MarkAPL_print.css'</code>
<code> [44]  'reportLinks'SetTo 0</code>
<code> [45]  'reportLinksCaption'SetTo'Link report'</code>
<code> [46]  'saveHTML'SetTo ¯1                            ⍝ Meddy parameter</code>
<code> [47]  'screenCSS'SetTo'MarkAPL_screen.css'</code>
<code> [48]  'smoothScrolling'SetTo 1</code>
<code> [49]  'subTocs'SetTo 1</code>
<code> [50]  'syntaxSugar'SetTo 1</code>
<code> [51]  'title'SetTo ⎕NULL</code>
<code> [52]  'toc'SetTo 0</code>
<code> [53]  'tocCaption'SetTo'Table of contents'</code>
<code> [54]  'verbose'SetTo r.debug</code>
<code> [55]  'width'SetTo 900</code>
<code> [56]  r.⎕FX'r←∆List;⎕IO' '⍝ List all variables and possible references in this namespace' '⎕IO←1' 'r←{⍵,[1.5]⍎¨⍵}⎕NL-2 9'</code>
<code> [57] ⍝Done</code>
</div>
<code class="header" id="listing_51">#.MarkAPL.MarkAPL.MakeHTML_Doc &mdash; 98%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←parms MakeHTML_Doc html</code>
<code> [1]  ⍝ Takes HTML, typically created by calling `Process`, and makes it a fully fledged document by adding</code>
<code> [2]  ⍝ &lt;body&gt;, &lt;head&gt; -- with &lt;title&gt; -- and &lt;html&gt; including the DocType. By default CSS is injected as well.</code>
<code> [3]   :Access Public Shared</code>
<code> [4]   r←⊂'&lt;!DOCTYPE html&gt;'</code>
<code> [5]   r,←⊂'&lt;html',((0≠≢parms.lang)/' lang="',(parms.lang~'"'),'"'),(parms.smoothScrolling/' style="scroll-behavior:smooth" '),'&gt;'</code>
<code> [6]   r,←⊂'&lt;head&gt;'</code>
<code> [7]   :If parms.enforceEdge</code>
<code> [8]            ⍝ ↓↓↓ https://blogs.msdn.microsoft.com/askie/2009/03/23/understanding-compatibility-modes-in-internet-explorer-8/</code>
<code> [9]       r,←⊂'&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;'</code>
<code> [10]           ⍝ This MUST be the first &lt;meta&gt; tag!</code>
<code> [11]  :EndIf</code>
<code> [12]  r,←⊂'&lt;meta charset="',parms.charset,'"&gt;'</code>
<code> [13]  :If ⎕NULL≡parms.title</code>
<code> [14]      :If 1=+/ind←∨/¨⊃∨/'&lt;h1 ' '&lt;h1&gt;'{⍺∘⍷¨⍵}¨⊂html</code>
<code> [15]          parms.title←{⍵↑⍨¯1+⍵⍳'&lt;'}{⍵↓⍨⍵⍳'&gt;'}{⍵↓⍨¯1+1⍳⍨'&lt;h1'⍷⍵}(ind⍳1)⊃html</code>
<code> [16]      :Else</code>
<code> [17]          parms.title←'MarkAPL'</code>
<code> [18]      :EndIf</code>
<code> [19]  :EndIf</code>
<code> [20]  r,←⊂'&lt;title&gt;',parms.title,'&lt;/title&gt;'</code>
<code> [21]  parms←EstablishDefaultHomeFolder parms</code>
<code> [22]  :If 0=parms.noCSS</code>
<code> [23]      :If ⎕NULL≡parms.cssURL</code>
<code> [24]          parms.cssURL←parms.homeFolder,'/Files/'</code>
<code> [25]      :EndIf</code>
<code> [26]      parms.cssURL~←'"'</code>
<code> [27]      :If 0≠≢parms.cssURL</code>
<code> [28]          parms.cssURL,←{'/'/⍨~(¯1↑⍵)∊'/\'}parms.cssURL</code>
<code> [29]          ((parms.cssURL='\')/parms.cssURL)←'/'</code>
<code> [30]      :EndIf</code>
<code> [31]      :If parms.linkToCSS</code>
<code> [32]          r,←'screen'InjectCssFilenamesIntoHtml parms</code>
<code> [33]          :If 0≠≢parms.printCSS</code>
<code> [34]              r,←'print'InjectCssFilenamesIntoHtml parms</code>
<code> [35]          :EndIf</code>
<code> [36]      :Else</code>
<code> [37]          :If 0≠≢parms.screenCSS</code>
<code> [38]              r,←'screen'InjectCssIntoHtml parms</code>
<code> [39]          :EndIf</code>
<code> [40]          :If 0≠≢parms.printCSS</code>
<code> [41]              r,←'print'InjectCssIntoHtml parms</code>
<code> [42]          :EndIf</code>
<code> [43]      :EndIf</code>
<code> [44]  :EndIf</code>
<code> [45]  buff←∊html</code>
<code> [46]  parms.hasCodeBlock←∨/'&lt;pre'⍷buff</code>
<code> [47]  parms.hasCollapsible←∨/'&lt;summary'⍷buff</code>
<code> [48]  parms.hasTOC←∨/'&lt;nav id="main_nav"&gt;'⍷buff</code>
<code> [49]  buff←''</code>
<code> [50]  :If parms.hasCollapsible</code>
<code> [51]      r,←⊂'&lt;script&gt;'</code>
<code> [52]      r,←GetJavaScriptForPrintingCollapsibles</code>
<code> [53]      r,←⊂'&lt;/script&gt;'</code>
<code> [54]  :EndIf</code>
<code> [55]  :If 0≠≢parms.head</code>
<code> [56]      r,←,⊆parms.head</code>
<code> [57]  :EndIf</code>
<code> [58]  copyCodeJavaScript←toggleTocJavaScript←''</code>
<code> [59]  :If parms.hasCodeBlock</code>
<code> [60]      copyCodeJavaScript←GetCopyCodeJavaScript parms.copy2ClipboardBtn</code>
<code> [61]  :EndIf</code>
<code> [62]  :If parms.hasTOC</code>
<code class="emphasize">→[63]      toggleTocJavaScript←GetJavaScriptForTogglingTOC</code>
<code> [64]  :EndIf</code>
<code> [65]  javaScript←copyCodeJavaScript,toggleTocJavaScript</code>
<code> [66]  r,←'&lt;/head&gt;' '&lt;body&gt;',html,(⊂'&lt;/body&gt;'),javaScript,(⊂'&lt;/html&gt;')</code>
<code> [67] ⍝Done</code>
</div>
<code class="header" id="listing_52">#.MarkAPL.MarkAPL.A &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←A</code>
<code> [1]  r←APLTreeUtils2</code>
</div>
<code class="header" id="listing_53">#.MarkAPL.MarkAPL.AddAlignStyle &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> AddAlignStyle←{</code>
<code> [1] ⍝ ⍺←1 : it is for &lt;th&gt;</code>
<code> [2] ⍝ ⍺←2 : it is for &lt;td&gt;  (default)</code>
<code> [3]      ⍺←2</code>
<code> [4]      (⍺=1)∧⍵≡'center':''                ⍝ For ⍺←→1 (th): headers default to center anyway</code>
<code> [5]      (⍺=2)∧⍵≡'left':''                  ⍝ For ⍺←→2 (td): headers default to left anyway</code>
<code> [6]      ' style="text-align: ',⍵,';"'</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_54">#.MarkAPL.MarkAPL.AddAppropriateExtension &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> filename←recompileFlag AddAppropriateExtension filename</code>
<code> [1]       ⍝ If ⍵ (a filename) has an extension it's just returned.</code>
<code> [2]  :If 0=≢3⊃⎕NPARTS filename</code>
<code> [3]      filename,←(1+recompileFlag)⊃'.html' '.md'</code>
<code> [4]  :EndIf</code>
</div>
<code class="header" id="listing_55">#.MarkAPL.MarkAPL.AddBookmarkLink &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  anchor←AddBookmarkLink(level ns bookmarkName)</code>
<code> [1]  ⍝ Add ID and HREF if that is okay with ns.parms.bookmarkLink</code>
<code> [2]   anchor←''</code>
<code> [3]   :If 0&lt;ns.parms.bookmarkLink</code>
<code> [4]   :AndIf ns.parms.bookmarkLink≥level</code>
<code> [5]       anchor,←' href="#',bookmarkName,'" id="',bookmarkName,'"'</code>
<code> [6]       ⍝ Make sure the class is assigned after ID/Href, otherwise you'll break `CheckInternalLinks`</code>
<code> [7]       anchor,←' class="autoheader_anchor"'</code>
<code> [8]       anchor←'&lt;a',anchor,'&gt;'</code>
<code> [9]   :EndIf</code>
</div>
<code class="header" id="listing_56">#.MarkAPL.MarkAPL.AllAllowedCharsInTag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←AllAllowedCharsInTag</code>
<code> [1]  r←⎕A,'abcdefghijklmnopqrstuvwxyz-_',⎕D</code>
</div>
<code class="header" id="listing_57">#.MarkAPL.MarkAPL.AllWhiteSpaceChars &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←AllWhiteSpaceChars</code>
<code> [1]  r←⎕UCS 32 9 10 11 13</code>
</div>
<code class="header" id="listing_58">#.MarkAPL.MarkAPL.AppendFootnoteDefinitions &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←AppendFootnoteDefinitions ns</code>
<code> [1]   html←''</code>
<code> [2]   html,←⊂'&lt;div id="footnotes_div"&gt;'</code>
<code> [3]   html,←⊂'&lt;hr&gt;'</code>
<code> [4]   html,←⊂'&lt;p&gt;&lt;strong&gt;',ns.parms.footnotesCaption,'&lt;/strong&gt;&lt;/p&gt;'</code>
<code> [5]   html,←⊂'&lt;ol&gt;'</code>
<code> [6]   :For i footnote :InEach {(⍳≢⍵)⍵}ns.footnoteDefs[;2]</code>
<code> [7]       html,←⊂'&lt;li id="fnref',(⍕i),'"&gt;',(⊃,/Tag¨footnote),'&lt;a href="#fnref',(⍕i),'" class="footnote_anchor"&gt;&lt;/a&gt;'</code>
<code> [8]   :EndFor</code>
<code> [9]   html,←'&lt;/ol&gt;' '&lt;/div&gt;'</code>
<code> [10]  ns.html,←html</code>
<code> [11] ⍝Done</code>
</div>
<code class="header" id="listing_59">#.MarkAPL.MarkAPL.Between &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Between←{⍵∨≠\⍵}</code>
</div>
<code class="header" id="listing_60">#.MarkAPL.MarkAPL.BringBackSpecialHtmlEntities &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> BringBackSpecialHtmlEntities←{</code>
<code> [1] ⍝ Bring back the three special HTML entities: &amp;lt; and &amp;gt; and &amp;amp;</code>
<code> [2] ⍝ Needed in cases processed stuff must be processed again (TOC for example)</code>
<code> [3]      0=≢⍵:⍵</code>
<code> [4]      '&amp;amp;'⎕R'\&amp;'⊣'&amp;gt;'⎕R'&gt;'⊣'&amp;lt;'⎕R'&lt;'⊣⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_61">#.MarkAPL.MarkAPL.CalculateHeaderNumbers &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←CalculateHeaderNumbers ns</code>
<code> [1]   current←6⍴0</code>
<code> [2]   :If ∧/bool←CheckHeaders ns</code>
<code> [3]       bool←ns.headers[;1]∊{1=≢⍵:⍳⍵ ⋄ ⍵}ns.parms.numberHeaders</code>
<code> [4]       :If 0≠≢headers←bool⌿ns.headers</code>
<code> [5]           headers[;1]-←(⊃headers)-1</code>
<code> [6]           nos←(⊃≢headers)⍴0</code>
<code> [7]           lastLevel←1</code>
<code> [8]           :For i :In ⍳⊃≢headers</code>
<code> [9]               level←headers[i;1]</code>
<code> [10]              :If lastLevel&gt;level</code>
<code> [11]                  (level↓current)←0</code>
<code> [12]              :EndIf</code>
<code> [13]              current[level]+←1</code>
<code> [14]              nos[i]←⊂level↑current</code>
<code> [15]              lastLevel←level</code>
<code> [16]          :EndFor</code>
<code> [17]          (bool⌿ns.headers)[;4]←{⊃,/(⍕¨⍵),¨'.'}¨nos</code>
<code> [18]      :EndIf</code>
<code> [19]  :Else</code>
<code> [20]      ns.report,←⊂'Headers are ill-nested and need correction - check level(s) ',⍕⍸~bool</code>
<code> [21]  :EndIf</code>
</div>
<code class="header" id="listing_62">#.MarkAPL.MarkAPL.CheckForHtmlBlock &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  flag←CheckForHtmlBlock(markdown emptyLines topOfDocument)</code>
<code> [1]  ⍝ Returns 1 if `markdown` starts with an HTML block and 0 otherwise</code>
<code> [2]   flag←0</code>
<code> [3]   :If topOfDocument</code>
<code> [4]   :OrIf ⊃⍴'^&lt;pre.*&gt;' '^&lt;script.*&gt;' '^&lt;style.*&gt;'⎕S 0⍠('Greedy' 0)⊣⊃markdown  ⍝ &lt;pre&gt;, &lt;script&gt;, &lt;style&gt; don't require empty lines around them.</code>
<code> [5]   :OrIf ∆LastLineWasEmpty∨(⊃emptyLines)∧'&lt;'=1↑⊃⊃1↓markdown                  ⍝ But it MAY have a blank leading line anyway!</code>
<code> [6]       row←⊃(⊃emptyLines)↓markdown</code>
<code> [7]       :If flag←'&lt;'=1⍴row</code>
<code> [8]           flag←0=≢'^&lt;([a-zA-Z0-9]){3,6}://'⎕S 0⊣row                         ⍝ Tell implicit links (like &lt;http://aplwiki.com&gt;) from an HTML blocks; 3="ftp"; 6="mailto"</code>
<code> [9]       :EndIf</code>
<code> [10]  :EndIf</code>
</div>
<code class="header" id="listing_63">#.MarkAPL.MarkAPL.CheckForInvalidFootnotes1 &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ns←CheckForInvalidFootnotes1 ns</code>
<code> [1] ⍝ At this point if headers are converted to links automatically they must not carry a footnote ref (early)</code>
<code> [2]  :If 0&lt;ns.parms.bookmarkLink</code>
<code> [3]  :AndIf 0&lt;≢ind←⍸{≢'^#{1,6}'⎕S 2⍠('Greedy' 0)⊢⍵}¨ns.markdown</code>
<code> [4]  :AndIf 0&lt;≢ind2←2+'\[\^[a-zA-Z]+\]'⎕S 2⊣ns.markdown[ind]</code>
<code> [5]  :AndIf 0&lt;≢ind←ind[ind2]</code>
<code> [6]      ns.report←'Invalid footnote definition in auto-link headers: line(s) ',⊃{⍺,',',⍵}/⍕¨ind</code>
<code> [7]  :EndIf</code>
</div>
<code class="header" id="listing_64">#.MarkAPL.MarkAPL.CheckForInvalidFootnotes2 &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←CheckForInvalidFootnotes2 ns</code>
<code> [1]  ⍝ At this point if we find any footnote refs they must be invalid, otherwise we wouldn't find them. (Let check)</code>
<code> [2]   :If ns.parms.checkFootnotes</code>
<code> [3]   :AndIf 0≠≢ns.html</code>
<code> [4]       html←FlattenHTML ns.html</code>
<code> [5]       mask←~GetMaskForCodeTags html</code>
<code> [6]   :AndIf 0≠≢html←mask/html</code>
<code> [7]   :AndIf 0≠≢ind←⍸'[^'⍷html</code>
<code> [8]       ids←ind{{⍵↑⍨¯1+⍵⍳']'}(⍺+1)↓⍵}¨⊂html</code>
<code> [9]       ns.report,←'Warning: invalid footnote: '∘,¨ids</code>
<code> [10]  :EndIf</code>
</div>
<code class="header" id="listing_65">#.MarkAPL.MarkAPL.CheckHeaders &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CheckHeaders←{</code>
<code> [1]      ns←⍵</code>
<code> [2]      bool←({1=≢⍵:⍳⍵ ⋄ ⍵}ns.parms.numberHeaders)∊ns.headers[;1]</code>
<code> [3]      (-+/∧\~⌽bool)↓bool   ⍝ The highest levels might not be in use, so we need to drop them</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_66">#.MarkAPL.MarkAPL.CheckInternalLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←CheckInternalLinks ns</code>
<code> [1]  ⍝ Checks all internal links for being correct (not pointing into nowhere land).</code>
<code> [2]   :If ns.parms.checkLinks</code>
<code> [3]   :AndIf 0≠≢ns.html</code>
<code> [4]       html←⊃,/ns.html</code>
<code> [5]   :AndIf 0≠≢html←(~GetMaskForCodeTags html)/html</code>
<code> [6]       anchors←GetBookmarkAnchors html</code>
<code> [7]       links←GetBookmarkLinks html</code>
<code> [8]   :AndIf 0≠≢links←(~links∊anchors)/links</code>
<code> [9]       ns.report,←'Invalid internal link: ['∘,¨links,¨']'</code>
<code> [10]  :EndIf</code>
</div>
<code class="header" id="listing_67">#.MarkAPL.MarkAPL.CheckOddNumberOfDoubleQuotes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ns CheckOddNumberOfDoubleQuotes(txt type)</code>
<code> [1]  ⍝ Check "txt". That can be anything: paragraph, cell, list item, header, blockquote ...</code>
<code> [2]  ⍝ * If it contains no " or an even number nothing changes.</code>
<code> [3]  ⍝ * A single one is escaped.</code>
<code> [4]  ⍝ * When an odd number is found the last one is escaped and a warning is issued, because</code>
<code> [5]  ⍝   that might well not be what the user intended to do.</code>
<code> [6]   r←' ',txt</code>
<code> [7]   msg←''</code>
<code> [8]   mask←~GetMaskForCode r</code>
<code> [9]   :If 0=≢ind←⍸mask\'"'=mask/r                      ⍝ No double quotes at all? Done!</code>
<code> [10]      r←txt</code>
<code> [11]  :ElseIf 1=≢ind                                        ⍝ Just one double quote? Done!</code>
<code> [12]      r←'`(.*?)`' '"'⎕R'&amp;' '\\"'⊣txt                    ⍝ Escapes the " but ignores `code`</code>
<code> [13]      msg←'Warning: single double quote found in ',type</code>
<code> [14]      ns.report,←⊂msg,' (line ',(⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers),')'</code>
<code> [15]  :Else</code>
<code> [16]      :If '\'∧.≠r[ind-1]                                ⍝ Nothing escaped?</code>
<code> [17]          :If 0=2|≢ind                                  ⍝ Even number of "?</code>
<code> [18]              r←txt</code>
<code> [19]          :Else                                         ⍝ No, number is odd</code>
<code> [20]              (txt[¯1+¯1↑ind])←⊂'\"'                    ⍝ Escape the last one.</code>
<code> [21]              r←⊃,/txt</code>
<code> [22]              msg←'Warning: odd number of double quotes found in ',type</code>
<code> [23]              ns.report,←⊂msg,' (line ',(⍕¯1+ns.parms.lineNumberOffset+⊃ns.lineNumbers),')'</code>
<code> [24]          :EndIf</code>
<code> [25]      :Else                                             ⍝ We have some `\"` so we need a loop</code>
<code> [26]          openFlag←1</code>
<code> [27]          txt←' ',txt</code>
<code> [28]          :For i :In ind</code>
<code> [29]              :If '\"'≢txt[i-1 0]</code>
<code> [30]                  :If openFlag</code>
<code> [31]                      openFlag←0</code>
<code> [32]                  :Else</code>
<code> [33]                      openFlag←1</code>
<code> [34]                  :EndIf</code>
<code> [35]              :EndIf</code>
<code> [36]          :EndFor</code>
<code> [37]          r←1↓⊃,/txt</code>
<code> [38]      :EndIf</code>
<code> [39]  :EndIf</code>
</div>
<code class="header" id="listing_68">#.MarkAPL.MarkAPL.CollectItem &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  (noOf item)←CollectItem bl</code>
<code> [1]  ⍝ Collects as many lines from `bl` as belong to what's a single list item.</code>
<code> [2]  ⍝ bl:    All the lines a list may be compiled from.</code>
<code> [3]  ⍝ The end is defined by one of:</code>
<code> [4]  ⍝ * Empty line</code>
<code> [5]  ⍝ * Line consisting of nothing but spaces</code>
<code> [6]  ⍝ * The next list item (either numbered or bulleted, no matter what the indentation is)</code>
<code> [7]  ⍝ Whatever comes first.</code>
<code> [8]   noOf←+/∧\0≠≢¨bl~¨' '</code>
<code> [9]   noOf←1++/∧\~IsHtmlList¨1↓noOf↑bl</code>
<code> [10]  item←FlattenNestedItem noOf↑bl</code>
</div>
<code class="header" id="listing_69">#.MarkAPL.MarkAPL.CollectItemPara &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  (noOf para)←CollectItemPara bl</code>
<code> [1]  ⍝ Collects as many lines from `bl` as belong to what's a paragraph.</code>
<code> [2]  ⍝ bl:    All the lines a list may be compiled from.</code>
<code> [3]  ⍝ indentation:   Number of blanks defining the indentation. May be zero.</code>
<code> [4]  ⍝ ←:     [1]=Number of lines in bl the para is made of; [2]=the para as such</code>
<code> [5]  ⍝ Note: this function must be called only when at least ⊃bl is a para indeed.</code>
<code> [6]   :If 1=noOf←+/∧\0≠≢¨bl</code>
<code> [7]       para←⊃bl</code>
<code> [8]   :Else</code>
<code> [9]       noOf←1++/∧\0=IsHtmlList¨1↓noOf↑bl</code>
<code> [10]      options←('Mode' 'M')('EOL' 'CR')('DotAll' 1)</code>
<code> [11]      para←A.DLB⊃,/' ',¨noOf↑bl</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_70">#.MarkAPL.MarkAPL.CollectToc &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  toc←CollectToc ns</code>
<code> [1]   toc←⍬</code>
<code> [2]   :If 0≠≢ind←'&lt;h[1-6][ &gt;]'⎕S 2⍠('Greedy' 0)⊣ns.html</code>
<code> [3]       level←{⊃A.ToNum 1↑2↓⊃'&lt;h[1-6].*&gt;'⎕S{⍵.Match}⍠('Greedy' 0)⊣⍵}¨ns.html[ind+1]</code>
<code> [4]       caption←{1↓¨(-1+≢'&lt;hx&gt;')↓¨{⊃'\&gt;.*\&lt;/h[1-6]&gt;'⎕S{⍵.Match}⍠('Greedy' 0)⊣⍵}¨⍵}ns.html[1+ind]</code>
<code> [5]       caption←{0=≢⍵:⍵ ⋄ '&amp;lt;' '&amp;gt;' '&amp;amp;' '&lt;code.*&gt;' '&lt;/code&gt;'⎕R('&lt;' '&gt;' '\&amp;' '`' '`')⍠('Greedy' 0)('Mode' 'L')⊣⍵}¨caption</code>
<code> [6]       IDs←{⊃'data-id="[^"]*"'⎕S{⍵.Match}⊣⍵}¨ns.html[ind+1]</code>
<code> [7]       ((0=⊃¨1↑¨0⍴¨IDs)/IDs)←⊂''</code>
<code> [8]       toc←↓(level,[1.5]caption),IDs</code>
<code> [9]       (3⊃¨toc)←{0=≢⍵:⍵ ⋄ ¯1↓⍵↓⍨⍵⍳'"'}¨3⊃¨toc</code>
<code> [10]      bool←{2&lt;+/{⍵∨≠\⍵}⍵='"'}¨IDs</code>
<code> [11]  :AndIf 0≠≢toc←bool⌿toc</code>
<code> [12]      toc,¨←ns.headerLineNos</code>
<code> [13]  :EndIf</code>
</div>
<code class="header" id="listing_71">#.MarkAPL.MarkAPL.CompileAttribute &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompileAttribute←{</code>
<code> [1]      attr←⍵</code>
<code> [2]      0≠2|'"'+.=attr:'Special attributes: invalid nunmber of "'⎕SIGNAL 11</code>
<code> [3]      mask←Between'"'=attr</code>
<code> [4]      0&lt;+/mask:' ',attr</code>
<code> [5]      ⊃{⍺,'="',⍵,'"'}/'='A.Split attr</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_72">#.MarkAPL.MarkAPL.CompileAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompileAttributes←{</code>
<code> [1]      sp←⍺</code>
<code> [2]      attrs←A.DMB ⍵</code>
<code> [3]      attrs←CompileAttribute¨attrs</code>
<code> [4]      1=≢attrs:sp⊣sp.r,←' ',⊃attrs</code>
<code> [5]      sp.r,←⊃{⍺,' ',⍵}/attrs</code>
<code> [6]      sp</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_73">#.MarkAPL.MarkAPL.CompileBookMarkName &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  CompileBookMarkName←{</code>
<code> [1]  ⍝ Returns the bookmark name</code>
<code> [2]       ⍺←1</code>
<code> [3]       bookmarkMayStartWithDigit←⍺</code>
<code> [4]       (txt specialAttrs)←⍵</code>
<code> [5]       txt←BringBackSpecialHtmlEntities txt</code>
<code> [6]       r←GetIdFromSpecialAttributes specialAttrs</code>
<code> [7]       0≠≢r:{{⍵↑⍨¯1+⍵⍳'"'}⍵↓⍨⍵⍳'"'}r</code>
<code> [8]       r←txt</code>
<code> [9]       r←'&amp;[A-Za-z]*;'⎕R''⊢r                 ⍝ Remove HTML entities (&amp;{word}; only)</code>
<code> [10]      r←'&lt;.+?&gt;'⎕R''⊣r                       ⍝ Remove everything between &lt;&gt;</code>
<code> [11]      r←RemoveHTML r</code>
<code> [12]      r←'\[.*\]'⎕R''⊣r                      ⍝ Remove everything between []</code>
<code> [13]      r←'\(.*\)'⎕R''⊣r                      ⍝ Remove everything between ()</code>
<code> [14]      allowed←' ∆⍙_-',⎕D,⎕A,⎕C ⎕A</code>
<code> [15]      r←(r∊allowed)/r                       ⍝ Remove invalid characters</code>
<code> [16]      r←allowed{⍵↓⍨+/∧\~⍵∊⍺~⎕D}⍣(~bookmarkMayStartWithDigit)⊣r ⍝ Remove all leading digits if ~bookmarkMayStartWithDigit</code>
<code> [17]      r←A.DLB A.DTB r                           ⍝ Remove leading and trailing blanks</code>
<code> [18]      r←{0=≢⍵:⍵ ⋄ (⊃⍵)∊'∆⍙_',⎕D,⎕A,⎕C ⎕A:⍵ ⋄ ∇ 1↓⍵}r</code>
<code> [19]      ((' '=r)/r)←'-'                       ⍝ Replace remaining blanks by hyphens</code>
<code> [20]      r</code>
<code> [21]  }</code>
</div>
<code class="header" id="listing_74">#.MarkAPL.MarkAPL.CompileClassNames &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompileClassNames←{</code>
<code> [1]      sp←⍺</code>
<code> [2]      sp.r,←' class="',(⊃{⍺,' ',⍵}/1↓¨⍵),'"'</code>
<code> [3]      sp</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_75">#.MarkAPL.MarkAPL.CompileID_Names &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompileID_Names←{</code>
<code> [1]      sp←⍺</code>
<code> [2]      sp.r,←' id="',(LowercaseID 1↓⍵),'"'</code>
<code> [3]      sp</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_76">#.MarkAPL.MarkAPL.CompilePara &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompilePara←{</code>
<code> [1]      para←⍵</code>
<code> [2]      para←('⍝'≠⊃¨para)/para  ⍝ Get rid of lines that start with a lamp symbol.</code>
<code> [3]      para←{'\'≠¯1↑⍵:⍵ ⋄ (¯1↓⍵),⎕UCS 13}¨para</code>
<code> [4]      para←(1↓⊃,/' ',¨para)</code>
<code> [5]      mask←GetMaskForCode para</code>
<code> [6]      {⍵/⍨(GetMaskForCode ⍵)∨~(∧\' '=⍵)∨('  '⍷⍵)∨⌽∧\' '=⌽⍵}para</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_77">#.MarkAPL.MarkAPL.CompileParms &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  parms←CompileParms parms</code>
<code> [1]   :If 0=≢parms</code>
<code> [2]       parms←CreateParms</code>
<code> [3]   :EndIf</code>
<code> [4]   parms←EstablishDefaultHomeFolder parms</code>
<code> [5]   :If ⎕NULL≡parms.cssURL</code>
<code> [6]       parms.cssURL←'file:///',FilesAndDirs.NormalizePath parms.homeFolder,'/Files/'</code>
<code> [7]   :EndIf</code>
<code> [8]   ((parms.cssURL='\')/parms.cssURL)←'/'</code>
<code> [9]   ((parms.leanpubIconsUrl='\')/parms.leanpubIconsUrl)←'/'</code>
<code> [10]  parms.cssURL,←(~(¯1↑parms.cssURL)∊' /')/'/'</code>
<code> [11]  parms.leanpubIconsUrl,←(~(¯1↑parms.leanpubIconsUrl)∊' /')/'/'</code>
<code> [12]  parms.(inputFilename outputFilename)←1 CorrectSlash¨parms.(inputFilename outputFilename)</code>
<code> [13]  parms.(cssURL screenCSS printCSS)←0 CorrectSlash¨parms.(cssURL screenCSS printCSS)</code>
<code> [14] ⍝Done</code>
</div>
<code class="header" id="listing_78">#.MarkAPL.MarkAPL.CompressCSS &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  css←CompressCSS css</code>
<code> [1]   :Access Public Shared</code>
<code> [2]  ⍝ Takes CSS and compresses it to a single line.</code>
<code> [3]  ⍝ Along the way it...</code>
<code> [4]  ⍝ * removes all comments</code>
<code> [5]  ⍝ * removes any spaces around `;:{}`</code>
<code> [6]  ⍝ * replaces &lt;TAB&gt; chars by spaces</code>
<code> [7]  ⍝ * removes multiple spaces</code>
<code> [8]  ⍝</code>
<code> [9]  ⍝ Note that this method can have desastrous results when performed on non-valid CSS!\\</code>
<code> [10] ⍝ Throws an error in case something is not right with the CSS.</code>
<code> [11]  css←{(1↓⊃,/(⎕UCS 13),¨⍵)}⍣(1≠≡css)⊣css</code>
<code> [12]  start←'/*'⍷css</code>
<code> [13]  end←'*/'⍷css</code>
<code> [14]  mask←~{⍵∨≠\⍵}css='"'</code>
<code> [15]  'Cannot compress CSS: number of occurrences of /* and */ are different'⎕SIGNAL 11/⍨0=≡/+/¨mask∘/¨start end</code>
<code> [16]  'Cannot compress CSS: Invalid nested comments'⎕SIGNAL 11/⍨0≠≢(∪⊃-/+\¨start end)~0 1</code>
<code> [17]  start∧←mask</code>
<code> [18]  end∧←mask</code>
<code> [19]  bool←~{⍵∨≠\⍵}start∨end</code>
<code> [20]  bool[1+⍸end]←0</code>
<code> [21]  css←bool/css</code>
<code> [22]  css←A.DMB css~⎕TC</code>
<code> [23]  ((css=⎕UCS 9)/css)←' '</code>
<code> [24]  mask←~{⍵∨≠\⍵}css='"'</code>
<code> [25]  b1←mask\mask/⊃∨/' :' ' ;' ' {' ' }'⍷¨⊂css</code>
<code> [26]  b2←mask\mask/⊃∨/': ' '; ' '{ ' '} '⍷¨⊂css</code>
<code> [27]  b←~b1∨0,¯1↓b2</code>
<code> [28]  css←b/css</code>
<code> [29] ⍝Done</code>
</div>
<code class="header" id="listing_79">#.MarkAPL.MarkAPL.ConvertEscapedAmpersand &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←ConvertEscapedAmpersand md</code>
<code> [1]  r←'\\&amp;'⎕R'\&amp;amp;'⊣md</code>
<code> [2] ⍝Done</code>
</div>
<code class="header" id="listing_80">#.MarkAPL.MarkAPL.ConvertH1AndH2HeadersToH3 &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ConvertH1AndH2HeadersToH3←{</code>
<code> [1]  ⍝ This is called within any Aside (LeanPub extension) as well as by ProcessMarkAPLExtensions (collapsibles).</code>
<code> [2]  ⍝ Since screen readers read out any &lt;h1&gt; and &lt;h2&gt; tags we convert them to &lt;h3&gt; which is a common strategy.</code>
<code> [3]      html←⍵</code>
<code> [4]      html←'&lt;h1&gt;' '&lt;h2&gt;'⎕R'&lt;h3&gt;'⊣html</code>
<code> [5]      '&lt;/h1&gt;' '&lt;/h2&gt;'⎕R'&lt;/h3&gt;'⊣html</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_81">#.MarkAPL.MarkAPL.ConvertMarkdown2HTML &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  (html report)←ConvertMarkdown2HTML markdown</code>
<code> [1]  ⍝ `markdown` may come from an aside (= LeanPub extension like `A&gt; `) or a collapsible (`^&gt; `).</code>
<code> [2]  ⍝ This requires to be converted to HTML with MarkAPL but without...</code>
<code> [3]  ⍝ * header anchors</code>
<code> [4]  ⍝ * numbering headers</code>
<code> [5]  ⍝ etc.</code>
<code> [6]   parms←CreateParms</code>
<code> [7]   parms.numberHeaders←0</code>
<code> [8]   parms.bookmarkLink←0</code>
<code> [9]   parms.createFullHtmlPage←0</code>
<code> [10]  parms.verbose←0</code>
<code> [11]  parms.ignoreEmbeddedParms←1</code>
<code> [12]  parms.div_h_tag←0</code>
<code> [13]  (html ns)←parms Markdown2HTML markdown</code>
<code> [14]  html←ConvertH1AndH2HeadersToH3 html</code>
<code> [15]  report←ns.report</code>
<code> [16] ⍝Done</code>
</div>
<code class="header" id="listing_82">#.MarkAPL.MarkAPL.ConvertMarkdownFile &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {report}←{parms}ConvertMarkdownFile filename</code>
<code> [1]  ⍝ Converts the contents of `filename` to HTML5. The output filename equals `filename` except that</code>
<code> [2]  ⍝ the extension changes from `.md` to `.html`.\\</code>
<code> [3]  ⍝ This can be overwritten by specifying a parameter space as left argument (typically created</code>
<code> [4]  ⍝ by calling `CreateParms`) and setting `outputFilename`.\\</code>
<code> [5]  ⍝ Note however that when you specify `inputFilename` to anything but '' or `filename an error is</code>
<code> [6]  ⍝ generated. Other settings in parms are honoured.\\</code>
<code> [7]  ⍝ If no left argument is passed then defaults take place, in particular regarding the CSS.\\</code>
<code> [8]  ⍝ Note that by default `ConvertMarkdownFile` creates a fully-fledged HTML page.\\</code>
<code> [9]  ⍝ The result is either an empty text vector or a vector of text vectors. It may contain warnings or error</code>
<code> [10] ⍝ messages. It's what is returned by `Init` on `ns.report`.</code>
<code> [11]  parms←{0=⎕NC ⍵:CreateParms ⋄ ⍎⍵}'parms'</code>
<code> [12]  :If 0≠≢parms.inputFilename</code>
<code> [13]  :AndIf parms.inputFilename≢filename</code>
<code> [14]      '"inputFilename" must not be specified'⎕SIGNAL 11</code>
<code> [15]  :EndIf</code>
<code> [16]  parms.inputFilename←FilesAndDirs.NormalizePath filename</code>
<code> [17]  parms.createFullHtmlPage←(1+¯1≡parms.createFullHtmlPage)⊃parms.createFullHtmlPage 1</code>
<code> [18]  :If 0=≢parms.outputFilename</code>
<code> [19]      parms.outputFilename←FilesAndDirs.NormalizePath∊(¯1↓⎕NPARTS filename),'.html'</code>
<code> [20]  :EndIf</code>
<code> [21]  ns←Init parms''</code>
<code> [22]  ns←Process ns</code>
<code> [23]  :If parms.createFullHtmlPage</code>
<code> [24]      ns.html←ns.parms MakeHTML_Doc ns.html</code>
<code> [25]  :EndIf</code>
<code> [26]  (⊂ns.html)⎕NPUT parms.outputFilename 1</code>
<code> [27]  report←ns.report</code>
<code> [28] ⍝Done</code>
</div>
<code class="header" id="listing_83">#.MarkAPL.MarkAPL.CorrectSlash &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  CorrectSlash←{</code>
<code> [1]        ⍝ ⍺ is a Boolean that decides whether ⍵ shall be normalized (1) or not (0).</code>
<code> [2]        ⍝ For everything that points to the local file system we want normalization,</code>
<code> [3]        ⍝ but for stuff that potentially points elsewhere (like `cssUrl`) we don't want that:</code>
<code> [4]        ⍝ We don't necessarily know the OS over there!</code>
<code> [5]        ⍝ Default is normalization.</code>
<code> [6]        ⍝ Leave any kind of protocol alone like "http://" etc. but also stuff like "foo://".</code>
<code> [7]       ⍺←1</code>
<code> [8]       ss←'://' ⍝ Search string</code>
<code> [9]       0=+/bool←ss⍷⍵:FilesAndDirs.NormalizePath⍣(⊃⍺)⊣⍵</code>
<code> [10]      length←(¯1+≢ss)+bool⍳1</code>
<code> [11]      r←(length↑⍵),FilesAndDirs.NormalizePath⍣(⊃⍺)⊣length↓⍵</code>
<code> [12]      0='file://'{((⊃(≢⍺)↓⍵)∊'\/')∧⍺≡(≢⍺)↑⍵}r:r</code>
<code> [13]      'file:///',(1+≢'file://')↓r</code>
<code> [14]  }</code>
</div>
<code class="header" id="listing_84">#.MarkAPL.MarkAPL.CreateHelpParms &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  parms←CreateHelpParms</code>
<code> [1]   parms←CreateParms</code>
<code> [2]   parms.linkToCSS←0</code>
<code> [3]   parms.toc←2 3</code>
<code> [4]   parms.numberHeaders←2 3 4 5 6</code>
<code> [5]   parms.bookmarkLink←6</code>
<code> [6]   parms.viewInBrowser←1</code>
<code> [7]   parms.compressCSS←1</code>
<code> [8]   parms.title←'MarkAPL Reference'</code>
<code> [9]   parms.width←1100</code>
<code> [10]  parms.reportLinks←1</code>
</div>
<code class="header" id="listing_85">#.MarkAPL.MarkAPL.CreateMarkdownFromUrlAndLinkText &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  md←CreateMarkdownFromUrlAndLinkText(urls linkTexts)</code>
<code> [1]   md←''</code>
<code> [2]   i←0</code>
<code> [3]   :For url linkText :InEach urls linkTexts</code>
<code> [4]       i+←1</code>
<code> [5]       buff←'* &lt;',url,'&gt;'</code>
<code> [6]       :If url≢linkText</code>
<code> [7]           buff,←':&lt;br&gt;','{{{{{',(⍕i),'}}}}}'</code>
<code> [8]       :EndIf</code>
<code> [9]       md,←⊂buff</code>
<code> [10]  :EndFor</code>
</div>
<code class="header" id="listing_86">#.MarkAPL.MarkAPL.CreateTOC &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ns CreateTOC def</code>
<code> [1]  ⍝ def:</code>
<code> [2]  ⍝ [;1] level</code>
<code> [3]  ⍝ [;2] caption</code>
<code> [4]  ⍝ [;3] running no</code>
<code> [5]  ⍝ [;4] id</code>
<code> [6]   r←⊂'&lt;nav id="main_nav" class="toc"&gt;'</code>
<code> [7]   r,←⊂'&lt;h2 id="toc-heading"&gt;',ns.parms.tocCaption,'&lt;/h2&gt;'</code>
<code> [8]   :If 1  ⍝TODO⍝ ns.parms.collapsibleTOC</code>
<code> [9]       r,←⊂'&lt;button id="toc-toggle" aria-controls="toc-list" aria-expanded="true"&gt;Hide&lt;/button'</code>
<code> [10]  :EndIf</code>
<code> [11]  r,←⊂''</code>
<code> [12]  r,←⊂'&lt;div class="toc-container"&gt;'</code>
<code> [13]  r,←⊂'&lt;ul id="toc-list"&gt;'</code>
<code> [14]  lastLevel←⊃⊃def</code>
<code> [15]  bf←(,0)≢,ns.parms.bookmarkLink        ⍝ Bookmark flag</code>
<code> [16]  nf←(,0)≢,ns.parms.numberHeaders       ⍝ Numbered flag</code>
<code> [17]  co←1                                  ⍝ Count opened lists</code>
<code> [18]  ff←1                                  ⍝ "First" flag</code>
<code> [19]  :For (level caption no id) :In ↓def</code>
<code> [20]      :If lastLevel&lt;level</code>
<code> [21]          r,←⊂'&lt;ul&gt;'</code>
<code> [22]          co+←1</code>
<code> [23]      :ElseIf lastLevel&gt;level</code>
<code> [24]          ((≢r)⊃r),←'&lt;/li&gt;'</code>
<code> [25]          r,←(lastLevel-level)⍴⊂'&lt;/ul&gt;',(co&gt;1)/'&lt;/li&gt;'</code>
<code> [26]          co-←lastLevel-level</code>
<code> [27]      :ElseIf lastLevel=level</code>
<code> [28]      :AndIf ~ff</code>
<code> [29]          ((≢r)⊃r),←'&lt;/li&gt;'</code>
<code> [30]      :EndIf</code>
<code> [31]      caption←⊃ns ProcessInlineMarkUp caption</code>
<code> [32]      r,←⊂'&lt;li class="toc-entry toc-h',(⍕level),'"&gt;&lt;a href="#',(LowercaseID id),'"&gt;',caption,'&lt;/a&gt;'</code>
<code> [33]      lastLevel←level</code>
<code> [34]      ff←0</code>
<code> [35]  :EndFor</code>
<code> [36]  r,←(0⌈co-1)⍴⊂'&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;'</code>
<code> [37]  r,←⊂'&lt;/ul&gt;'</code>
<code> [38]  r,←⊂'&lt;/div&gt;'</code>
<code> [39]  r,←⊂'&lt;/nav&gt;'</code>
</div>
<code class="header" id="listing_87">#.MarkAPL.MarkAPL.Create_NS &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  Create_NS←{</code>
<code> [1]       ns←⎕NS''</code>
<code> [2]       ns.markdown←''</code>
<code> [3]       ns.emptyLines←⍬</code>
<code> [4]       ns.leadingChars←''</code>
<code> [5]       ns.lineNumbers←⍬                              ⍝ Useful for reporting problems</code>
<code> [6]       ns.report←''                                  ⍝ That's how MarkAPL tells about potential problem.</code>
<code> [7]       ns.withoutBlanks←⍬</code>
<code> [8]       ns.footnoteDefs←0 2⍴''</code>
<code> [9]       ns.headerLineNos←⍬</code>
<code> [10]      ns.headers←0 4⍴''                             ⍝ Level, bookmark, caption, header numbers</code>
<code> [11]      ns.html←''                                    ⍝ Our result</code>
<code> [12]      ns.embeddedParms←0 2⍴''</code>
<code> [13]      ns.abbreviations←0 2⍴''</code>
<code> [14]      ns.linkRefs←⍬</code>
<code> [15]      ns.data←⍬</code>
<code> [16]      ns.(subToc toc)←⊂''</code>
<code> [17]      _←'parms'ns.⎕NS''</code>
<code> [18]      ns.parms.syntaxSugar←1</code>
<code> [19]      ns.parms.lang←'en'</code>
<code> [20]      ns</code>
<code> [21]  }</code>
</div>
<code class="header" id="listing_88">#.MarkAPL.MarkAPL.DetectClosingTag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> DetectClosingTag←{</code>
<code> [1]  ⍝ Find the tag</code>
<code> [2]      (md tag)←⍵</code>
<code> [3]      (∨/¨tag∘⍷¨md)⍳1</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_89">#.MarkAPL.MarkAPL.DetectClosingTagBeforeEmptyLine &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> DetectClosingTagBeforeEmptyLine←{</code>
<code> [1] ⍝ Find the tag followed by a blank line</code>
<code> [2]      (md tag)←⍵</code>
<code> [3]      b←(∨/¨tag∘⍷¨md)∧((1↓0=≢¨md)),0</code>
<code> [4]      0=+/b:0</code>
<code> [5]      b⍳1</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_90">#.MarkAPL.MarkAPL.DetectOpeningTag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> DetectOpeningTag←{</code>
<code> [1]  ⍝ When this is called we know that the first char of the current line is a `&lt;` character.</code>
<code> [2]  ⍝ ⍺ is something like "&lt;style" (Yes, without the closing &gt;!)</code>
<code> [3]  ⍝ We now need to find out whether it is really an HTML tag.</code>
<code> [4]      md←⍵                                  ⍝ Nested vector with all the Markdown</code>
<code> [5]      tag←⍺</code>
<code> [6]      0≠≢tag ⎕S 0⍠('IC' 1)⊣⊃md</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_91">#.MarkAPL.MarkAPL.Drop &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Drop←{</code>
<code> [1]      ns←⍵</code>
<code> [2]      ns.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)←ns.noOf↓¨ns.(markdown markdownLC leadingChars emptyLines withoutBlanks lineNumbers)</code>
<code> [3]      ns.noOf←1</code>
<code> [4]      ns</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_92">#.MarkAPL.MarkAPL.DropSpecialAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  DropSpecialAttributes←{</code>
<code> [1]       specialAttrs←⍺</code>
<code> [2]       0=≢specialAttrs:⍵</code>
<code> [3]       '\'=1↑¯2↑⍵:⍵</code>
<code> [4]       buff←(⎕UCS 13)A.Split ⍵     ⍝ In case of &lt;&lt;BR&gt;&gt;!</code>
<code> [5]       tx←A.DTB⊃buff</code>
<code> [6]       '}'≠¯1↑tx:1↓⊃,/(⎕UCS 13),¨(⊂tx),1↓buff</code>
<code> [7]       ~'{'∊tx:1↓⊃,/(⎕UCS 13),¨(⊂tx),1↓buff</code>
<code> [8]       tx←A.DTB{⌽⍵↓⍨⍵⍳'{'}1↓⌽tx</code>
<code> [9]       1↓⊃,/(⎕UCS 13),¨(⊂tx),1↓buff</code>
<code> [10]  }</code>
</div>
<code class="header" id="listing_93">#.MarkAPL.MarkAPL.DropSpecialImageAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  DropSpecialImageAttributes←{</code>
<code> [1]  ⍝ In general special attributes are always located at the end of an object</code>
<code> [2]  ⍝ while an image might might well be inside something else like a para or a cell etc.</code>
<code> [3]       specialAttrs←⍺</code>
<code> [4]       0=≢specialAttrs:⍵</code>
<code> [5]       '\'=1↑¯2↑⍵:⍵</code>
<code> [6]       buff←(⎕UCS 13)A.Split ⍵     ⍝ In case of &lt;&lt;BR&gt;&gt;!</code>
<code> [7]       tx←A.DTB⊃buff</code>
<code> [8]       ~'{'∊tx:⍵</code>
<code> [9]       no←¯1+tx⍳'{'</code>
<code> [10]      tx←no⌽⍵</code>
<code> [11]      (-no)⌽{⍵↓⍨⍵⍳'}'}tx</code>
<code> [12]  }</code>
</div>
<code class="header" id="listing_94">#.MarkAPL.MarkAPL.DropTailAfterClosingTag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> DropTailAfterClosingTag←{</code>
<code> [1]      html←⍵</code>
<code> [2]      tag←⍺</code>
<code> [3]      buff←(≢html)⊃html</code>
<code> [4]      buff←((¯1+≢tag)+1⍳⍨tag⍷⎕C buff)↑buff</code>
<code> [5]      ((≢html)⊃html)←buff</code>
<code> [6]      html</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_95">#.MarkAPL.MarkAPL.EscapePipeSymbolInCell &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  EscapePipeSymbolInCell←{</code>
<code> [1]  ⍝ ⍵ is a cell from any APL matrix.</code>
<code> [2]  ⍝ We convert any | to \| (escaping) except when it lives within code</code>
<code> [3]       c←⍵</code>
<code> [4]       mask←~GetMaskForCode c     ⍝ We must ignore code</code>
<code> [5]       0=+/mask:c                 ⍝ Everything is code? Done!</code>
<code> [6]       b←'|'=mask/c               ⍝ Where are the | when we ignore the code?</code>
<code> [7]       0=+/b:c                    ⍝ None?! Done!</code>
<code> [8]       buff←mask/c                ⍝ Get what's not code</code>
<code> [9]       (b/buff)←⊂'\|'             ⍝ Replace all | by \|</code>
<code> [10]      (mask/c)←buff              ⍝ Put stuff back</code>
<code> [11]      ⊃,/c                       ⍝ Simplify</code>
<code> [12]  }</code>
</div>
<code class="header" id="listing_96">#.MarkAPL.MarkAPL.Execute &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←Execute y</code>
<code> [1]  ⍝ This is used for test purposes only: to execute non-public methods.</code>
<code> [2]   :Access Public Shared</code>
<code> [3]   'Invalid call'⎕SIGNAL 11/⍨~A.IsDevelopment</code>
<code> [4]   :If 0=⎕NC'ns'</code>
<code> [5]       ⎕SHADOW'ns'</code>
<code> [6]       ns←Create_NS ⍬</code>
<code> [7]   :EndIf</code>
<code> [8]   r←⍎y</code>
<code> [9]  ⍝Done</code>
</div>
<code class="header" id="listing_97">#.MarkAPL.MarkAPL.FindFenceEnd &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> FindFenceEnd←{</code>
<code> [1]  ⍝ The end of a fence must have at last three ⍺ characters and may have leading and trailing blanks as well</code>
<code> [2]  ⍝ but nothing else, in particular no special attributes.</code>
<code> [3]  ⍝ ⍵ is a vector of Markdown vectors.</code>
<code> [4]      pattern←⍺</code>
<code> [5]      0≠≢noOf←1+(pattern,'\s{0,}$')⎕S 2⍠('Mode' 'L')⊣⍵:1+⊃noOf</code>
<code> [6]      1+≢⍵            ⍝ To the end of the document!</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_98">#.MarkAPL.MarkAPL.FlattenHTML &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> FlattenHTML←{</code>
<code> [1] ⍝ Typically used to flatten ns.html</code>
<code> [2] ⍝ Bring back with :</code>
<code> [3] ⍝ ns.html ←→ (⎕Ucs 13) A.Split FlattenHTML ns.html</code>
<code> [4]      1↓⊃,/(⎕UCS 13),¨⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_99">#.MarkAPL.MarkAPL.FlattenNestedItem &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> FlattenNestedItem←{</code>
<code> [1]      item←⍵</code>
<code> [2]      1=≢item:⊃item</code>
<code> [3]      1↓⊃,/' ',¨A.DLB item</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_100">#.MarkAPL.MarkAPL.GatherFootNoteReferences &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  hits←GatherFootNoteReferences ns</code>
<code> [1]  ⍝ Finds all the references to footnotes in the HTML</code>
<code> [2]  ⍝ `hits` is a matrix with 4 columns:</code>
<code> [3]  ⍝ [;1] Number</code>
<code> [4]  ⍝ [;2] Original name</code>
<code> [5]  ⍝ [;3] Row in ns.html where a hit was found</code>
<code> [6]  ⍝ [;4] Index of the hit in that row.</code>
<code> [7]   hits←0 4⍴⍬</code>
<code> [8]   :For i id footnote :In ↓(⍳⊃⍴ns.footnoteDefs),ns.footnoteDefs</code>
<code> [9]       mask←{~Between⊃∨/'&lt;code&gt;' '&lt;/code&gt;'⍷¨⊂⍵}¨ns.html</code>
<code> [10]      :If 0&lt;+/∊bool←('[^',id,']')∘⍷¨mask/¨ns.html</code>
<code> [11]          :For row :In ⍸∨/¨bool</code>
<code> [12]              ind←1⍳⍨('[^',id,']')⍷row⊃ns.html                                      ⍝ Only the first one is taken into account</code>
<code> [13]              :If 0≠≢ind←(~ind∊⍸GetMaskForCodeTags row⊃ns.html)/ind  ⍝ Remove those between &lt;code tags</code>
<code> [14]                  hits⍪←i,(⊂id),row,ind</code>
<code> [15]              :EndIf</code>
<code> [16]          :EndFor</code>
<code> [17]      :EndIf</code>
<code> [18]  :EndFor</code>
<code> [19]  hits←{⍵[⍒⍵[;3];]}{⍵[⍒⍵[;4];]}hits   ⍝ It's essential to turn them around!</code>
</div>
<code class="header" id="listing_101">#.MarkAPL.MarkAPL.GetAllLinkRefs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetAllLinkRefs←{</code>
<code> [1]  ⍝ This combs through the html and finds all link references ([][]-syntax).</code>
<code> [2]  ⍝ Ignores in-line code.</code>
<code> [3]  ⍝ Returns a three-item-vector for each hit.</code>
<code> [4]  ⍝ [1] The link text - that can by anything.</code>
<code> [5]  ⍝ [2] The ref id. That's what we hope to find in ns.linkRefs later on.</code>
<code> [6]  ⍝     This must be US ASCII letters and digits and nothing else, not even white space.</code>
<code> [7]  ⍝ [3] The match - -everything between the opening [ and the closing ], including [].</code>
<code> [8]       html←⍵</code>
<code> [9]       mask←GetMaskForCodeTags¨html</code>
<code> [10]      maskedHtml←mask{⎕ML←3 ⋄ 0=+/⍺:⍵ ⋄ w←⍵ ⋄ (⍺/w)←' ' ⋄ w}¨html</code>
<code> [11]      hits←↓⍉↑'\[[^\]]*\]\[[^\]][A-Za-z0-9-_]*\]'⎕S(0 1 2)⊣maskedHtml</code>
<code> [12]      0=≢∊hits:hits</code>
<code> [13]      html∘GetLinkRef¨↓⍉↑hits</code>
<code> [14]  }</code>
</div>
<code class="header" id="listing_102">#.MarkAPL.MarkAPL.GetBookmarkAnchors &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  anchors←GetBookmarkAnchors html</code>
<code> [1]  ⍝ There are three different types of bookmark anchors:</code>
<code> [2]  ⍝ * Headers (auto-generated; they have the class "autoheader_anchor")</code>
<code> [3]  ⍝ * Footnotes (they have the class "footnote_anchor")</code>
<code> [4]  ⍝ * Those with an ID assigned by special attributes or as part of an HTML block)</code>
<code> [5]  ⍝ For that reason we need to take anything into account that carries an ID though</code>
<code> [6]  ⍝ they might carry that ID only to be styleable with CSS.</code>
<code> [7]   anchors←''</code>
<code> [8]   buff←'&lt;'A.Split html</code>
<code> [9]   :If 0≠≢buff←(∨/¨'id="'∘⍷¨buff)/buff</code>
<code> [10]  :AndIf 0≠≢anchors←(∨/¨' id="'∘⍷¨buff)/buff</code>
<code> [11]      anchors←{⍵{0=≢⍵:'' ⋄ {⍵↑⍨¯1+⍵⍳'"'}(+/⍵)↓⍺}⊃'id="'⎕S 0 1⊣⍵}¨anchors</code>
<code> [12]  :EndIf</code>
<code> [13]     ⍝Done</code>
</div>
<code class="header" id="listing_103">#.MarkAPL.MarkAPL.GetBookmarkLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  links←GetBookmarkLinks html</code>
<code> [1]  ⍝ Those have the class "bookmark_link" or "footnote_link" assigned in case they are generated via Markdown.</code>
<code> [2]  ⍝ However, if they are part of an HTML block then they might or not have any class assigned to them.</code>
<code> [3]  ⍝ Therefore we need to take anything into account that carries an HREF attribute.</code>
<code> [4]   links←''</code>
<code> [5]   :If 0≠≢buff←'&lt;'A.Split html</code>
<code> [6]   :AndIf 0≠≢links←(∨/¨' href="'∘⍷¨buff)/buff</code>
<code> [7]       links←{⍵{0=≢⍵:'' ⋄ {⍵↑⍨¯1+⍵⍳'"'}(+/⍵)↓⍺}⊃'href="'⎕S 0 1⊣⍵}¨links</code>
<code> [8]       links←1↓¨('#'=⊃¨links)/links</code>
<code> [9]   :EndIf</code>
</div>
<code class="header" id="listing_104">#.MarkAPL.MarkAPL.GetCodeBlockFrom &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←indendations GetCodeBlockFrom list</code>
<code> [1]   r←''</code>
<code> [2]   fence←⊃(⊃list)~' '</code>
<code> [3]   :If fence∊'~`'</code>
<code> [4]       pattern←'^\s{0,',(⍕indendations),'}',fence,'{3,}'</code>
<code> [5]   :AndIf 0≠≢pattern ⎕S 0⊣⊃list</code>
<code> [6]   :AndIf 0&lt;+/bool←pattern∘{⊃⍴⍺ ⎕S 0⍠('Mode' 'L')('Greedy' 0)⊣⍵}¨1↓list</code>
<code> [7]       noOf←2++/∧\~bool</code>
<code> [8]       r←noOf↑list</code>
<code> [9]   :EndIf</code>
</div>
<code class="header" id="listing_105">#.MarkAPL.MarkAPL.GetCommandLineParms &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetCommandLineParms←{</code>
<code> [1]       ⍺←1↓2 ⎕NQ #'GetCommandLineArgs'</code>
<code> [2]       arg←⍺</code>
<code> [3]       r←⎕NS''</code>
<code> [4]       clp←{⍵/⍨'-'≠⊃¨⍵}arg</code>
<code> [5]       0=≢clp:r</code>
<code> [6]       0=≢clp←{⍵/⍨'='∊¨⍵}clp:r</code>
<code> [7]       clp←'='A.Split¨clp</code>
<code> [8]       _←r.{⍎⍺,'←',{'''',⍵,''''}⍣(0∊⊃⎕VFI ⍵)⊢⍵}/¨clp</code>
<code> [9]       r</code>
<code> [10]  }</code>
</div>
<code class="header" id="listing_106">#.MarkAPL.MarkAPL.GetCopyCodeJavaScript &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←GetCopyCodeJavaScript flag</code>
<code> [1]   ⍝ Returns the JavaScript that adds a "Copy" button to every `&lt;pre&gt;` and established the handler for the "Click" event.</code>
<code> [2]   r←⊂''</code>
<code> [3]   :If flag</code>
<code> [4]       r←''</code>
<code> [5]       copyCaption←' ',(⎕UCS 128203),' '</code>
<code> [6]       copyCaption←' Copy '</code>
<code> [7]       r,←⊂''</code>
<code> [8]       r,←⊂'&lt;script&gt;'</code>
<code> [9]       r,←⊂'// Adds a "Copy" button to every code block &amp; established the event handler'</code>
<code> [10]      r,←⊂'const copyButtonLabel = "',(copyCaption),'" ;'</code>
<code> [11]      r,←⊂''</code>
<code> [12]      r,←⊂'let blocks = document.querySelectorAll("pre");'</code>
<code> [13]      r,←⊂''</code>
<code> [14]      r,←⊂'blocks.forEach((block) =&gt; {'</code>
<code> [15]      r,←⊂'  if (navigator.clipboard) {'</code>
<code> [16]      r,←⊂'    let button = document.createElement("button");'</code>
<code> [17]      r,←⊂''</code>
<code> [18]      r,←⊂'    button.innerText = copyButtonLabel;'</code>
<code> [19]      r,←⊂'    button.title = "Copies the code block to the clipboard.";'</code>
<code> [20]      r,←⊂'    block.appendChild(button);'</code>
<code> [21]      r,←⊂'     '</code>
<code> [22]      r,←⊂'    button.addEventListener("click", async () =&gt; {'</code>
<code> [23]      r,←⊂'      await copyCode(block, button);'</code>
<code> [24]      r,←⊂'    });'</code>
<code> [25]      r,←⊂'  }  '</code>
<code> [26]      r,←⊂'});  '</code>
<code> [27]      r,←⊂''</code>
<code> [28]      r,←⊂'async function copyCode(block, button) {'</code>
<code> [29]      r,←⊂'  let code = block.querySelector("code");'</code>
<code> [30]      r,←⊂'  let text = code.innerText;'</code>
<code> [31]      r,←⊂''</code>
<code> [32]      r,←⊂'  await navigator.clipboard.writeText(text);'</code>
<code> [33]      r,←⊂''</code>
<code> [34]     ⍝r,←⊂'  button.innerText = " ✓ ";'</code>
<code> [35]      r,←⊂'  button.innerText = " Copied ";'</code>
<code> [36]      r,←⊂''</code>
<code> [37]      r,←⊂'  setTimeout(() =&gt; {'</code>
<code> [38]      r,←⊂'    button.innerText = copyButtonLabel;'</code>
<code> [39]      r,←⊂'  }, 700);'</code>
<code> [40]      r,←⊂'}'</code>
<code> [41]      r,←⊂'&lt;/script&gt;'</code>
<code> [42]      r,←⊂''</code>
<code> [43]  :EndIf</code>
</div>
<code class="header" id="listing_107">#.MarkAPL.MarkAPL.GetEmptyLines &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←GetEmptyLines md</code>
<code> [1] ⍝ Returns vector of Booleans for those lines that are empty.</code>
<code> [2] ⍝ Note that empty lines within code blocks are **ignored**!</code>
<code> [3]  r←0=≢¨md</code>
<code> [4]  r∧←~WhereAreCodeBlocks md</code>
</div>
<code class="header" id="listing_108">#.MarkAPL.MarkAPL.GetFooter &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> GetFooter←{</code>
<code> [1]      strict←⍺</code>
<code> [2]      strict:''⍵ ⍝ No footers</code>
<code> [3]      cells←⍵</code>
<code> [4]      0=+/bool←{'='∧.=⊃,/⍵}¨cells:''cells</code>
<code> [5]      ind←¯1+bool⍳1</code>
<code> [6]      ((1+ind)↓cells)(ind↑cells)</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_109">#.MarkAPL.MarkAPL.GetIdFromSpecialAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> GetIdFromSpecialAttributes←{</code>
<code> [1] ⍝ 'id="foo"' ←→ GetIdFromSpecialAttributes 'class="qwe" id="foo" style="color:red;"'</code>
<code> [2]      0=≢buff←⊃'\sid="[^"]*."'⎕S(0 1)⊣⍵:''</code>
<code> [3]      (ind length)←buff</code>
<code> [4]      length↑(ind+1)↓⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_110">#.MarkAPL.MarkAPL.GetInfoString &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetInfoString←{</code>
<code> [1]       ⍺←3</code>
<code> [2]       indendation←⍺</code>
<code> [3]       md←⍵</code>
<code> [4]       fence←⊃md~' '</code>
<code> [5]       0=≢md←(+/∧\md=fence)↓md:''</code>
<code> [6]       0=≢md←(¯1+md⍳'{')↑md:''               ⍝ Remove special attributes (if any)</code>
<code> [7]       pattern←'^\s{0,',(⍕indendation),'}',fence,'{3,}'</code>
<code> [8]       0=≢infoString←A.DLB A.DTB pattern ⎕R''⊣md:''</code>
<code> [9]       (~fence∊infoString)/infoString        ⍝ Any info string must not contain a fencing character</code>
<code> [10]  }</code>
</div>
<code class="header" id="listing_111">#.MarkAPL.MarkAPL.GetJavaScriptForPrintingCollapsibles &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←GetJavaScriptForPrintingCollapsibles</code>
<code> [1]   r←''</code>
<code> [2]   r,←⊂''</code>
<code> [3]   r,←⊂'// Function that makes sure that all "Collapsibles" are extended (open) when printing'</code>
<code> [4]   r,←⊂'// We have to make sure that everything is going to be printed'</code>
<code> [5]   r,←⊂'window.matchMedia("print").addEventListener("change", evt =&gt; {'</code>
<code> [6]   r,←⊂'    if (evt.matches) {'</code>
<code> [7]   r,←⊂'        elms = document.body.querySelectorAll("details:not([open])");'</code>
<code> [8]   r,←⊂'        for (e of elms) {'</code>
<code> [9]   r,←⊂'            e.setAttribute("open", "");'</code>
<code> [10]  r,←⊂'            e.dataset.wasclosed = "";'</code>
<code> [11]  r,←⊂'        }'</code>
<code> [12]  r,←⊂'    } else {'</code>
<code> [13]  r,←⊂'        elms = document.body.querySelectorAll("details[data-wasclosed]");'</code>
<code> [14]  r,←⊂'        for (e of elms) {'</code>
<code> [15]  r,←⊂'            e.removeAttribute("open");'</code>
<code> [16]  r,←⊂'            delete e.dataset.wasclosed;'</code>
<code> [17]  r,←⊂'        }'</code>
<code> [18]  r,←⊂'    }'</code>
<code> [19]  r,←⊂'})'</code>
<code> [20]  r,←⊂'// End "PrintingCollapsibles"'</code>
<code> [21]  r,←⊂''</code>
<code> [22] ⍝Done</code>
</div>
<code class="header" id="listing_112">#.MarkAPL.MarkAPL.GetLengthOfLeadingWhitespacePlusListMarker &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> GetLengthOfLeadingWhitespacePlusListMarker←{</code>
<code> [1] ⍝ 9 ← ∇ '  123)   List item'</code>
<code> [2] ⍝ 0 ← ∇ 'List item'</code>
<code> [3]      ⊃'^\s*?\b\d{1,9}\b[.)]\s+' '^\s*?[-*+]{1}\s+'⎕S 1⊢⍵</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_113">#.MarkAPL.MarkAPL.GetLinkRef &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetLinkRef←{</code>
<code> [1]       html←⍺</code>
<code> [2]       (start length row)←⍵</code>
<code> [3]       row+←⎕IO</code>
<code> [4]       buff←row⊃html</code>
<code> [5]       match←(⊂start+⍳length)⌷buff</code>
<code> [6]       '[]['≡3↑match:''(¯1↓3↓match)match</code>
<code> [7]       (linkText id)←{⎕ML←3 ⋄ 0 2↓¨(1++\']['⍷⍵)⊂⍵}¯1↓1↓match</code>
<code> [8]       linkText id match</code>
<code> [9]   }</code>
</div>
<code class="header" id="listing_114">#.MarkAPL.MarkAPL.GetListBlock &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> GetListBlock←{</code>
<code> [1]      bl←⍵</code>
<code> [2]      mask←~Between{⊃3&gt;≢⍵:0 ⋄ (⊂3⍴⍵)∊'```' '~~~'}¨bl~¨' '</code>
<code> [3]      bl←(⌊/(~(≢bl)⍴ns.emptyLines)⌿+/∧\' '=↑bl)↓¨bl</code>
<code> [4]      (mask/bl)←HandleEscapedNewLines mask/bl</code>
<code> [5]      leadingBlanks←+/∧\' '=↑bl</code>
<code> [6]      drop←{⍵⌊⊃⍵}leadingBlanks</code>
<code> [7]      drop↓¨bl</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_115">#.MarkAPL.MarkAPL.GetMarkdown &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  markdown←GetMarkdown markdown</code>
<code> [1]   :If 0=≢markdown</code>
<code> [2]       'Neither "markdown" nor "inputFilename" are set?!'⎕SIGNAL 6/⍨0=≢parms.inputFilename</code>
<code> [3]       markdown←⊃⎕NGET parms.inputFilename 1</code>
<code> [4]   :EndIf</code>
<code> [5]   markdown←,,¨markdown</code>
<code> [6]   'Invalid Markdown (depth)'⎕SIGNAL 11/⍨2≠|≡markdown</code>
<code> [7]   'Invalid Markdown (depth)'⎕SIGNAL 11/⍨(,1)≢∪≡¨markdown</code>
<code> [8]   length←≢markdown</code>
<code> [9]   :If length&gt;≢markdown←'\t'⎕R(4⍴' ')⍠('Mode' 'M')⊣markdown              ⍝ Replace all &lt;TAB&gt; chars by 4 spaces</code>
<code> [10]      markdown,←(length-≢markdown)⍴⊂''                                  ⍝ In order to overcome bug &lt;01446&gt;</code>
<code> [11]  :EndIf</code>
<code> [12]  markdown←{0=+/b←(⎕UCS 0)=⍵:⍵ ⋄ w←⍵ ⋄ (b/w)←⎕UCS 65533 ⋄ w}¨markdown   ⍝ Replace U+0000 by U+FFFD for secutity reasons</code>
<code> [13] ⍝Done</code>
</div>
<code class="header" id="listing_116">#.MarkAPL.MarkAPL.GetMaskForCode &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←GetMaskForCode txt</code>
<code> [1]  ⍝ Returns a mask (vector of Booleans with zeros for all APL code in ⍵.</code>
<code> [2]  ⍝ Does not fall over odd number of tick: the last one is then ignored.</code>
<code> [3]  ⍝ Honors escaped backticks when found outside a code block.</code>
<code> [4]  ⍝ This can only be solved in a loop because of, say, this:  `\\`</code>
<code> [5]  ⍝ This is a code block with two backslashes, not an opening backtick followed by an escaped one!</code>
<code> [6]   txt_←' ',txt,' '</code>
<code> [7]   on←0</code>
<code> [8]   :If 0=≢ind←⍸txt_='`'</code>
<code> [9]       r←(≢txt)⍴0</code>
<code> [10]  :Else</code>
<code> [11]      r←(≢txt)⍴0</code>
<code> [12]      r←(2+≢txt)⍴0</code>
<code> [13]      i←0</code>
<code> [14]      :Repeat</code>
<code> [15]          i+←1</code>
<code> [16]          in←ind[i]</code>
<code> [17]          :If 0=on                          ⍝ No code block is "open" right now?</code>
<code> [18]              :If '\'≠txt_[in-1]            ⍝ Then an escape char in front of the ` must be honoured.</code>
<code> [19]              :AndIf i&lt;≢ind                 ⍝ At least one more char to come? (results in ignoring the last in case of an odd number of backticks.</code>
<code> [20]                  noOf←+/∧\'`'=(in-1)↓txt_  ⍝ How many consecutive backticks? The same number must be used to close it!</code>
<code> [21]                  i+←0⌈noOf-1</code>
<code> [22]                  :If 1=+/bool←'`'=(in+noOf)↓txt_      ⍝ Is there a corresponding ...      (single backtick)</code>
<code> [23]                  :OrIf noOf∊{+/¨∧\¨1↓¨⍵⊂⍨0 1⍷⍵}0,bool                ⍝ ... closing block of backticks?   (more than one backtick)</code>
<code> [24]                      r[in]←1</code>
<code> [25]                      on←1                  ⍝ Code block "opened".</code>
<code> [26]                  :Else</code>
<code> [27]                                                 ⍝ There is no corresponding closing block of backticks, so they did not open a block: they survive!</code>
<code> [28]                  :EndIf</code>
<code> [29]              :EndIf</code>
<code> [30]          :Else</code>
<code> [31]              :If noOf=+/∧\'`'=(in-1)↓txt_  ⍝ Only the precise same number of backticks that opened a block can close it.</code>
<code> [32]                  r[in+noOf-1]←1</code>
<code> [33]                  i+←noOf-1</code>
<code> [34]                  on←0                      ⍝ Code block "closed".</code>
<code> [35]              :EndIf</code>
<code> [36]          :EndIf</code>
<code> [37]      :Until i≥≢ind</code>
<code> [38]      r←{⍵∨≠\⍵}¯1↓1↓r</code>
<code> [39]  :EndIf</code>
</div>
<code class="header" id="listing_117">#.MarkAPL.MarkAPL.GetMaskForCodeTags &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetMaskForCodeTags←{</code>
<code> [1]   ⍝ Returns a mask for everything between &lt;code*&gt; and &lt;/code&gt;.</code>
<code> [2]   ⍝ We can savely assume valid HTML5 here.</code>
<code> [3]       txt←⍵</code>
<code> [4]       r←(≢txt)⍴0=1</code>
<code> [5]       0=+/b←'&lt;/code&gt;'⍷txt:r         ⍝ No closing tag? Done!</code>
<code> [6]       r[(¯1+≢'&lt;/code&gt;')+⍸b]←1</code>
<code> [7]       ind←⍸'&lt;code'⍷txt</code>
<code> [8]       ind←(txt[ind+≢'&lt;code']∊'&gt; ')/ind</code>
<code> [9]       r[ind]←1</code>
<code> [10]      Between r</code>
<code> [11]  }</code>
</div>
<code class="header" id="listing_118">#.MarkAPL.MarkAPL.GetRegExPatternForSubToc &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←GetRegExPatternForSubToc</code>
<code> [1]  r←''</code>
<code> [2]  r,←⊂'^&lt;&lt;subtoc&gt;&gt;'</code>
<code> [3]  r,←⊂'^&lt;&lt;subtoc *\{[^}]*}&gt;&gt;'</code>
<code> [4]  r,←⊂'^&lt;&lt;subtoc-[0-6]&gt;&gt;'</code>
<code> [5]  r,←⊂'^&lt;&lt;subtoc-[0-6] *\{[^}]*}&gt;&gt;'</code>
</div>
<code class="header" id="listing_119">#.MarkAPL.MarkAPL.GetSpecialAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  GetSpecialAttributes←{</code>
<code> [1]   ⍝ Checks whether ⍵ (a single line of Markdown) carries a "special attributes" definition.</code>
<code> [2]   ⍝ If so it returns a vector of definitions.</code>
<code> [3]   ⍝ Example:</code>
<code> [4]   ⍝ 'id="foo" class="cl1 cl2" attr1="A B C" attr2=123' ←→ ∇ '{#foo .cl1 .cl2 attr1="A B C" attr2=123}'</code>
<code> [5]   ⍝  'style="color=red;font-family='APL385 Unicode'"' ←→ ∇ 'style="color:red;font-family:'APL385 Unicode'"</code>
<code> [6]       md←A.DTB ⍵</code>
<code> [7]       ('!['≡2⍴md)∧0=+/'&lt;&lt;br&gt;&gt;'⍷md:''  ⍝ Might be a stand-alone image!</code>
<code> [8]       '}'≠¯1↑md:''</code>
<code> [9]       '\'=1↑¯2↑md:'' ⍝ Escaped?</code>
<code> [10]      ~'{'∊md:''</code>
<code> [11]      0=≢def←A.DMB{¯1↓1↓⌽⍵↑⍨⍵⍳'{'}⌽md:''</code>
<code> [12]      mask←~Between'"'=def</code>
<code> [13]      defs←1↓¨(1,mask\' '=mask/def)⊂' ',def</code>
<code> [14]      0∊'='∊¨{⍵/⍨~(⊃¨⍵)∊'.#'}defs:''</code>
<code> [15]      0∨.≠2|'"'+.=¨defs:''</code>
<code> [16]      sp←⎕NS''          ⍝ Result space</code>
<code> [17]      sp.r←''           ⍝ Collects the result(s)</code>
<code> [18]      b←'.'=⊃¨defs      ⍝ All class definitions (if any)</code>
<code> [19]      sp{0=≢⍵:⍺ ⋄ ⍺ CompileClassNames ⍵}←b/defs</code>
<code> [20]      b←'#'=⊃¨defs      ⍝ An id definitions (if any)</code>
<code> [21]      1&lt;+/b:'Invalid special attribute: more than one "id"'⎕SIGNAL 11</code>
<code> [22]      sp{0=≢⍵:⍺ ⋄ ⍺ CompileID_Names ⍵}←(b⍳1)⊃defs,⊂''</code>
<code> [23]      b←~(⊃¨defs)∊'#.'  ⍝ Any attribute defs</code>
<code> [24]      sp{0=≢⍵:⍺ ⋄ ⍺ CompileAttributes ⍵}←b/defs</code>
<code> [25]      sp.r/⍨←~''''''⍷sp.r  ⍝ APLers might specify double-quotes, so we remove them.</code>
<code> [26]      {⍵/⍨~'  '⍷⍵}sp.r</code>
<code> [27]  }</code>
</div>
<code class="header" id="listing_120">#.MarkAPL.MarkAPL.GetUrlAndTitleFromLink &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  (url title)←GetUrlAndTitleFromLink link</code>
<code> [1]  ⍝ Takes something like [Link Text](#A BookMark Link "The Title") and returns</code>
<code> [2]  ⍝ '#a-bookmark-link` `The Title`</code>
<code> [3]  ⍝ or [APL wiki](http://aplwiki.com "foo")</code>
<code> [4]  ⍝ 'http://aplwiki.com' 'foo'</code>
<code> [5]   url←((link{⍵\⍵/⍺}~GetMaskForCode link)⍳']')↓link</code>
<code> [6]   url←(url⍳'(')↓url</code>
<code> [7]   url↓⍨←-{⍵⍳')'}⌽url</code>
<code> [8]   url←A.DTB url</code>
<code> [9]   ((url='\')/url)←'/'</code>
<code> [10]  :If '"'=¯1↑url           ⍝ Has it a title?!</code>
<code> [11]  :AndIf 2≤'"'+.=url</code>
<code> [12]      noOf←1+{+/∧\1=+\⍵='"'}⌽url</code>
<code> [13]      title←¯1↓1↓(-noOf)↑url</code>
<code> [14]      url←A.DTB A.DLB(-noOf)↓url</code>
<code> [15]  :Else</code>
<code> [16]      title←''</code>
<code> [17]  :EndIf</code>
<code> [18]  :If 0=+/'://'⍷url         ⍝ Protocol</code>
<code> [19]  :AndIf 'mailto:'{⍺≢(≢⍺)↑⍵}url ⍝ Is not a "mailto" link</code>
<code> [20]  :AndIf '#'≠1⍴url          ⍝ Bookmark</code>
<code> [21]  :AndIf ':/'≢2⍴1↓url,'  '  ⍝ Absolute Windows path</code>
<code> [22]  :AndIf './'≢2⍴url,'  '    ⍝ Relative path</code>
<code> [23]  :AndIf '/'≠1⍴url          ⍝ Absolute UNIX path</code>
<code> [24]      :If '@'∊url</code>
<code> [25]          url←'mailto:',url</code>
<code> [26]      :Else</code>
<code> [27]          url←'http://',url</code>
<code> [28]      :EndIf</code>
<code> [29]  :EndIf</code>
</div>
<code class="header" id="listing_121">#.MarkAPL.MarkAPL.HandleEscapedNewLines &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> HandleEscapedNewLines←{</code>
<code> [1]      items←⍵</code>
<code> [2]      0=+/b←'\'=⊃¨¯1↑¨items:items</code>
<code> [3]      ind←⍸b</code>
<code> [4]      items[ind]←{(¯1↓⍵),⎕UCS 13}¨items[ind]</code>
<code> [5]      items</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_122">#.MarkAPL.MarkAPL.HtmlBlockTags &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←HtmlBlockTags</code>
<code> [1]  ⍝ Returns a list with all block elements in HTML5</code>
<code> [2]   r←''</code>
<code> [3]   r,←⊂'&lt;address&gt;'</code>
<code> [4]   r,←⊂'&lt;article&gt;'</code>
<code> [5]   r,←⊂'&lt;aside&gt;'</code>
<code> [6]   r,←⊂'&lt;blockquote&gt;'</code>
<code> [7]   r,←⊂'&lt;canvas&gt;'</code>
<code> [8]   r,←⊂'&lt;dd&gt;'</code>
<code> [9]   r,←⊂'&lt;div&gt;'</code>
<code> [10]  r,←⊂'&lt;dl&gt;'</code>
<code> [11]  r,←⊂'&lt;dt&gt;'</code>
<code> [12]  r,←⊂'&lt;fieldset&gt;'</code>
<code> [13]  r,←⊂'&lt;figcaption&gt;'</code>
<code> [14]  r,←⊂'&lt;figure&gt;'</code>
<code> [15]  r,←⊂'&lt;footer&gt;'</code>
<code> [16]  r,←⊂'&lt;form&gt;'</code>
<code> [17]  r,←⊂'&lt;h1&gt;'</code>
<code> [18]  r,←⊂'&lt;h6&gt;'</code>
<code> [19]  r,←⊂'&lt;header&gt;'</code>
<code> [20]  r,←⊂'&lt;hr&gt;'</code>
<code> [21]  r,←⊂'&lt;li&gt;'</code>
<code> [22]  r,←⊂'&lt;main&gt;'</code>
<code> [23]  r,←⊂'&lt;nav&gt;'</code>
<code> [24]  r,←⊂'&lt;noscript&gt;'</code>
<code> [25]  r,←⊂'&lt;ol&gt;'</code>
<code> [26]  r,←⊂'&lt;p&gt;'</code>
<code> [27]  r,←⊂'&lt;pre&gt;'</code>
<code> [28]  r,←⊂'&lt;section&gt;'</code>
<code> [29]  r,←⊂'&lt;table&gt;'</code>
<code> [30]  r,←⊂'&lt;tfoot&gt;'</code>
<code> [31]  r,←⊂'&lt;ul&gt;'</code>
<code> [32]  r,←⊂'&lt;video&gt;'</code>
</div>
<code class="header" id="listing_123">#.MarkAPL.MarkAPL.HtmlTags &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>   r←HtmlTags</code>
<code> [1]   ⍝ Returns a list with all official tags supported in HTML5</code>
<code> [2]    r←''</code>
<code> [3]    r,←⊂'a'</code>
<code> [4]    r,←⊂'abbr'</code>
<code> [5]    r,←⊂'address'</code>
<code> [6]    r,←⊂'area'</code>
<code> [7]    r,←⊂'article'</code>
<code> [8]    r,←⊂'aside'</code>
<code> [9]    r,←⊂'audio'</code>
<code> [10]   r,←⊂'b'</code>
<code> [11]   r,←⊂'base'</code>
<code> [12]   r,←⊂'bdi'</code>
<code> [13]   r,←⊂'bdo'</code>
<code> [14]   r,←⊂'basefont'</code>
<code> [15]   r,←⊂'blockquote'</code>
<code> [16]   r,←⊂'body'</code>
<code> [17]   r,←⊂'br'</code>
<code> [18]   r,←⊂'button'</code>
<code> [19]   r,←⊂'canvas'</code>
<code> [20]   r,←⊂'caption'</code>
<code> [21]   r,←⊂'cite'</code>
<code> [22]   r,←⊂'code'</code>
<code> [23]   r,←⊂'col'</code>
<code> [24]   r,←⊂'colgroup'</code>
<code> [25]   r,←⊂'data'</code>
<code> [26]   r,←⊂'datalist'</code>
<code> [27]   r,←⊂'dd'</code>
<code> [28]   r,←⊂'del'</code>
<code> [29]   r,←⊂'details'</code>
<code> [30]   r,←⊂'dfn'</code>
<code> [31]   r,←⊂'dialog'</code>
<code> [32]   r,←⊂'div'</code>
<code> [33]   r,←⊂'dl'</code>
<code> [34]   r,←⊂'dt'</code>
<code> [35]   r,←⊂'em'</code>
<code> [36]   r,←⊂'embed'</code>
<code> [37]   r,←⊂'fieldset'</code>
<code> [38]   r,←⊂'figcaption'</code>
<code> [39]   r,←⊂'figure'</code>
<code> [40]   r,←⊂'footer'</code>
<code> [41]   r,←⊂'form'</code>
<code> [42]   r,←⊂'h1'</code>
<code> [43]   r,←⊂'h2'</code>
<code> [44]   r,←⊂'h3'</code>
<code> [45]   r,←⊂'h4'</code>
<code> [46]   r,←⊂'h5'</code>
<code> [47]   r,←⊂'h6'</code>
<code> [48]   r,←⊂'head'</code>
<code> [49]   r,←⊂'header'</code>
<code> [50]   r,←⊂'hgroup'</code>
<code> [51]   r,←⊂'hr'</code>
<code> [52]   r,←⊂'html'</code>
<code> [53]   r,←⊂'i'</code>
<code> [54]   r,←⊂'iframe'</code>
<code> [55]   r,←⊂'img'</code>
<code> [56]   r,←⊂'input'</code>
<code> [57]   r,←⊂'ins'</code>
<code> [58]   r,←⊂'kbd'</code>
<code> [59]   r,←⊂'label'</code>
<code> [60]   r,←⊂'legend'</code>
<code> [61]   r,←⊂'li'</code>
<code> [62]   r,←⊂'link'</code>
<code> [63]   r,←⊂'main'</code>
<code> [64]   r,←⊂'map'</code>
<code> [65]   r,←⊂'mark'</code>
<code> [66]   r,←⊂'menu'</code>
<code> [67]   r,←⊂'menuitem'</code>
<code> [68]   r,←⊂'meta'</code>
<code> [69]   r,←⊂'meter'</code>
<code> [70]   r,←⊂'nav'</code>
<code> [71]   r,←⊂'noscript'</code>
<code> [72]   r,←⊂'object'</code>
<code> [73]   r,←⊂'ol'</code>
<code> [74]   r,←⊂'optgroup'</code>
<code> [75]   r,←⊂'option'</code>
<code> [76]   r,←⊂'p'</code>
<code> [77]   r,←⊂'param'</code>
<code> [78]   r,←⊂'picture'</code>
<code> [79]   r,←⊂'portal'</code>
<code> [80]   r,←⊂'pre'</code>
<code> [81]   r,←⊂'progress'</code>
<code> [82]   r,←⊂'q'</code>
<code> [83]   r,←⊂'rp'</code>
<code> [84]   r,←⊂'rt'</code>
<code> [85]   r,←⊂'ruby'</code>
<code> [86]   r,←⊂'s'</code>
<code> [87]   r,←⊂'samp'</code>
<code> [88]   r,←⊂'script'</code>
<code> [89]   r,←⊂'search'</code>
<code> [90]   r,←⊂'section'</code>
<code> [91]   r,←⊂'slot'</code>
<code> [92]   r,←⊂'small'</code>
<code> [93]   r,←⊂'source'</code>
<code> [94]   r,←⊂'span'</code>
<code> [95]   r,←⊂'strong'</code>
<code> [96]   r,←⊂'style'</code>
<code> [97]   r,←⊂'sub'</code>
<code> [98]   r,←⊂'summary'</code>
<code> [99]   r,←⊂'table'</code>
<code> [100]  r,←⊂'tbody'</code>
<code> [101]  r,←⊂'td'</code>
<code> [102]  r,←⊂'template'</code>
<code> [103]  r,←⊂'textarea'</code>
<code> [104]  r,←⊂'tfoot'</code>
<code> [105]  r,←⊂'th'</code>
<code> [106]  r,←⊂'thead'</code>
<code> [107]  r,←⊂'title'</code>
<code> [108]  r,←⊂'tr'</code>
<code> [109]  r,←⊂'track'</code>
<code> [110]  r,←⊂'u'</code>
<code> [111]  r,←⊂'ul'</code>
<code> [112]  r,←⊂'var'</code>
<code> [113]  r,←⊂'video'</code>
<code> [114]  r,←⊂'wbr'</code>
<code> [115]  r←,¨r</code>
</div>
<code class="header" id="listing_124">#.MarkAPL.MarkAPL.IdentifyListItems &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←IdentifyListItems ns</code>
<code> [1]  ⍝ Takes "ns" as right argument and figures out how many items belong to the current list.</code>
<code> [2]  ⍝ Things are complicated by ...</code>
<code> [3]  ⍝ * the fact that lazyness is allowed.</code>
<code> [4]  ⍝ * lines might be glued together with a trailing `\` or divided by &lt;&lt;br&gt;&gt;.</code>
<code> [5]  ⍝ * Laziness and indentation might be mixed together.</code>
<code> [6]  ⍝ * Lists might be nested.</code>
<code> [7]  ⍝ Note that a single blank line between items is okay; only more than one empty line breaks a list definition.</code>
<code> [8]  ⍝ We know already where two blank lines occur (max).</code>
<code> [9]   r←max←{0=+/⍵:≢⍵ ⋄ ⍵⍳1}⍨1 1⍷ns.emptyLines      ⍝ Two empty lines stop a list dead in any case</code>
<code> [10]  buff←max↑ns.markdown</code>
<code> [11]  :If 0≠≢ind←(⍸max↑ns.emptyLines)~max     ⍝ We are interested in the lines after any empty line</code>
<code> [12]      b1←0=+/∧\' '=↑buff[ind+1]                 ⍝ If those are not indented they potentially break the list</code>
<code> [13]      b2←~IsHtmlList¨buff[ind+1]                ⍝ Which ones are not list items as such at all?</code>
<code> [14]      :If 0&lt;+/b←b1∧b2</code>
<code> [15]          r←⊃b/ind</code>
<code> [16]      :EndIf</code>
<code> [17]  :EndIf</code>
</div>
<code class="header" id="listing_125">#.MarkAPL.MarkAPL.InjectBR &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> InjectBR←{</code>
<code> [1] ⍝ In case ⍵ contains any (⎕UCS 13) these are converted into `&lt;br&gt;`</code>
<code> [2]      tx←⍵</code>
<code> [3]      0=+/b←tx=⎕UCS 13:tx</code>
<code> [4]      '\r'⎕R' &lt;br&gt;'⍠'Mode' 'D'⊣tx</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_126">#.MarkAPL.MarkAPL.InjectCssFilenamesIntoHtml &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←type InjectCssFilenamesIntoHtml parms</code>
<code> [1]  ⍝ Inject zero, one or many CSS filenames and embrace them with a &lt;style&gt; tag.</code>
<code> [2]   'Invalid CSS media type'⎕SIGNAL 11/⍨0=+/(⊂type)∊'screen' 'print'</code>
<code> [3]   cssFiles←','A.Split parms.⍎type,'CSS'</code>
<code> [4]   cssFiles←{0=+/b←'\'=r←⍵~'"':r ⋄ (b/r)←'/' ⋄ r}¨cssFiles</code>
<code> [5]   html←''</code>
<code> [6]   :For cssFile :In cssFiles</code>
<code> [7]       html,←⊂'&lt;link href="',parms.cssURL,cssFile,'" rel="stylesheet" media="',type,'"&gt;'</code>
<code> [8]   :EndFor</code>
<code> [9]  ⍝Done</code>
</div>
<code class="header" id="listing_127">#.MarkAPL.MarkAPL.InjectFootNotes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ns←InjectFootNotes ns</code>
<code> [1]  hits←GatherFootNoteReferences ns</code>
<code> [2]  ns←ReplaceFootnoteReferences ns hits</code>
<code> [3]  :If 0&lt;≢ns.footnoteDefs</code>
<code> [4]      ns←AppendFootnoteDefinitions ns</code>
<code> [5]  :EndIf</code>
</div>
<code class="header" id="listing_128">#.MarkAPL.MarkAPL.InjectLinkTextIntoReportLink &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←InjectLinkTextIntoReportLink(html linkTexts)</code>
<code> [1]   :For i :In ⍳≢linkTexts</code>
<code> [2]       pattern←'\{\{\{\{\{',(⍕i),'}}}}}'</code>
<code> [3]       replaceBy←i⊃linkTexts</code>
<code> [4]       b1←replaceBy='\'</code>
<code> [5]       b2←replaceBy='%'</code>
<code> [6]       b3←replaceBy='&amp;'</code>
<code> [7]       (b1/replaceBy)←⊂'\\'</code>
<code> [8]       (b2/replaceBy)←⊂'\&amp;'</code>
<code> [9]       (b3/replaceBy)←⊂'\&amp;'</code>
<code> [10]      replaceBy←⊃,/replaceBy</code>
<code> [11]      html←pattern ⎕R replaceBy⍠('Greedy' 0)⊣html</code>
<code> [12]  :EndFor</code>
</div>
<code class="header" id="listing_129">#.MarkAPL.MarkAPL.InjectNumberedHeaders &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {ns}←InjectNumberedHeaders ns</code>
<code> [1]   :If 0≠≢ns.headers  ⍝ Are their any headers at all?</code>
<code> [2]       levelsToBeNumbered←{1≠≢⍵:⍵ ⋄ ⍳⍵}ns.parms.numberHeaders</code>
<code> [3]   :AndIf ∨/levelsToBeNumbered∊ns.headers[;1] ⍝ Right levels?!</code>
<code> [4]       html←FlattenHTML ns.html</code>
<code> [5]       :For i :In ⍳≢ns.headers</code>
<code> [6]           (level header no)←ns.headers[i;1 3 4]</code>
<code> [7]           :If level∊levelsToBeNumbered</code>
<code> [8]               searchFor←A.DMB'&gt;',header,'&lt;/h',(⍕level),'&gt;'</code>
<code> [9]           :AndIf 1=+/bool←searchFor⍷html</code>
<code> [10]              ind←bool⍳1</code>
<code> [11]              length←¯1+1⍳⍨'&lt;/h'⍷{m←~GetMaskForCodeTags ⍵ ⋄ m\m/⍵}ind↓html</code>
<code> [12]              new←no,((0&lt;≢no)/' '),header</code>
<code> [13]              html←(-ind)⌽new,length↓ind⌽html</code>
<code> [14]          :EndIf</code>
<code> [15]      :EndFor</code>
<code> [16]      ns.html←(⎕UCS 13)A.Split html</code>
<code> [17]  :EndIf</code>
</div>
<code class="header" id="listing_130">#.MarkAPL.MarkAPL.InjectPointyBrackets &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> InjectPointyBrackets←{</code>
<code> [1]      tx←⍵</code>
<code> [2]      tx←'&amp;amp;pointybracket_open;'⎕R'&lt;'⊣tx</code>
<code> [3]      '&amp;amp;pointybracket_close;'⎕R'&gt;'⊣tx</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_131">#.MarkAPL.MarkAPL.InjectSubTOCs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←InjectSubTOCs ns</code>
<code> [1]   :If (,0)≢,ns.parms.toc</code>
<code> [2]   :AndIf 0≠≢ns.subToc</code>
<code> [3]       where←⍸{≢GetRegExPatternForSubToc ⎕S 0⍠('Greedy' 0)('IC' 1)⊣⍵}¨ns.html</code>
<code> [4]       :For i :In ⍳≢ns.subToc</code>
<code> [5]           (level header depth specialAttrs)←i⊃ns.subToc</code>
<code> [6]           ind←i⊃where</code>
<code> [7]           from←1⍳⍨(ns.headers[;1]=level)∧(ns.headers[;3]≡¨⊂header)</code>
<code> [8]           noOf←+/∧\level&lt;from↓ns.headers[;1]</code>
<code> [9]           levels←noOf↑from↓ns.headers[;1]</code>
<code> [10]          toc←↑3↑¨noOf↑from↓ns.toc</code>
<code> [11]          :If depth&gt;0</code>
<code> [12]              toc←((depth+¯1+⊃toc[;1])≥toc[;1])⌿toc</code>
<code> [13]          :EndIf</code>
<code> [14]          :If (≢toc)∊0 1</code>
<code> [15]              ns.html[i⊃where]←⊂''</code>
<code> [16]              ns.report,←⊂'No SubTOC injected for "',header,'": ',((1+1=≢toc)⊃'no item' 'just one sub-header'),' found'</code>
<code> [17]              :Leave</code>
<code> [18]          :Else</code>
<code> [19]              drop←⌊/toc[;1]</code>
<code> [20]              md←{(' '⍴⍨(1⊃⍵)-drop),'* [',(2⊃⍵),'](#',(3⊃⍵),')'}¨↓toc</code>
<code> [21]              parms←CreateParms</code>
<code> [22]              parms.markdownStrict←ns.parms.markdownStrict</code>
<code> [23]              parms.verbose←0</code>
<code> [24]              parms.checkLinks←0</code>
<code> [25]              parms.checkFootnotes←0</code>
<code> [26]              parms.syntaxSugar←0</code>
<code> [27]              ns2←Init parms md</code>
<code> [28]              {}ProcessLists ns2</code>
<code> [29]              :If (,0)≢,ns.parms.numberHeaders</code>
<code> [30]                  ns2.html←'href="#\d{0,}-'⎕R'href="#'⍠('Greedy' 0)⊣ns2.html</code>
<code> [31]              :EndIf</code>
<code> [32]              subToc←('&lt;nav',specialAttrs,' class="sub-toc"&gt;')('&lt;p&gt;Topics:&lt;/p&gt;'),ns2.html,⊂'&lt;/nav&gt;'</code>
<code> [33]              ns.html[i⊃where]←⊂subToc</code>
<code> [34]          :EndIf</code>
<code> [35]      :EndFor</code>
<code> [36]      ns.html←⊃,/{1=≡⍵:⊂⍵ ⋄ ⍵}¨ns.html</code>
<code> [37]  :EndIf</code>
</div>
<code class="header" id="listing_132">#.MarkAPL.MarkAPL.InjectTOC &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←InjectTOC ns</code>
<code> [1]  ⍝ Inject a TOC in case the user has specified this</code>
<code> [2]   :If 1=≢ns.parms.toc</code>
<code> [3]       levels←⍳ns.parms.toc</code>
<code> [4]   :Else</code>
<code> [5]       levels←ns.parms.toc</code>
<code> [6]   :EndIf</code>
<code> [7]   :If 0≠≢toc←↑((⊃¨ns.toc)∊levels)/ns.toc</code>
<code> [8]       drop←⌊/toc[;1]</code>
<code> [9]       :If (,0)≢,ns.parms.numberHeaders</code>
<code> [10]          toc,←toc{⍵[;4]⌿⍨⍵[;2]∊LowercaseID ⍺[;3]}ns.headers</code>
<code> [11]          links←ns.parms.bookmarkMayStartWithDigit{LowercaseID ⍺ CompileBookMarkName ⍵''}¨toc[;3]</code>
<code> [12]          tocHtml←ns CreateTOC toc[;1 2 5],links</code>
<code> [13]      :Else</code>
<code> [14]          links←{(3⊃⍵)≡GetBookMarkNameFromCaption(2⊃⍵)'':3⊃⍵ ⋄ 3⊃⍵}¨↓toc</code>
<code> [15]          tocHtml←ns CreateTOC(toc[;1 2],(⊂'')),links</code>
<code> [16]      :EndIf</code>
<code> [17]      :If '&lt;a' '&lt;h'≡2↑¨2↑ns.html                        ⍝ First two lines define a header?!</code>
<code> [18]          noOf←1⍳⍨'&lt;/a&gt;'{⍺∘≡¨(≢⍺)↑¨⍵}ns.html</code>
<code> [19]          ns.html←(noOf↑ns.html),tocHtml,noOf↓ns.html   ⍝ Insert after the first header</code>
<code> [20]      :Else</code>
<code> [21]          :If ∨/'&lt;h1 '⍷∊ns.html</code>
<code> [22]          ⍝ Insert TOC after &lt;h1&gt;</code>
<code> [23]              :If ∨/'&lt;div class="h_tag"&gt;'⍷∊ns.html</code>
<code> [24]                  i←⊃ns.html⍳⊂'&lt;/div&gt;'</code>
<code> [25]                  ns.html←(i↑ns.html),tocHtml,i↓ns.html</code>
<code> [26]              :EndIf</code>
<code> [27]          :EndIf</code>
<code> [28]      :EndIf</code>
<code> [29]  :EndIf</code>
</div>
<code class="header" id="listing_133">#.MarkAPL.MarkAPL.IotaSetextHeader &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IotaSetextHeader←{</code>
<code> [1]  ⍝ Returns indices as a vector of Booleans for all lines in ns.markdown that in itself would qualify as a SeText header.</code>
<code> [2]  ⍝ "In itself" means that it does not check whether what is above it is a para; that need to be checked independently.</code>
<code> [3]      type←⍺</code>
<code> [4]      (withoutBlanks markdown emptyLines)←⍵</code>
<code> [5]      0=+/b←(~emptyLines)∧withoutBlanks∧.=¨type:1+⍴markdown</code>
<code> [6]      ⍸b\{4&gt;+/∧\' '=⍵}¨b/markdown          ⍝ Max 3 leading blanks</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_134">#.MarkAPL.MarkAPL.IsBulletedHtmlList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsBulletedHtmlList←{</code>
<code> [1] ⍝ Returns a 1 in case ⍵ qualifies as an LI element of a bulleted list.</code>
<code> [2]      tx←,⍵</code>
<code> [3]      ~{(⊃A.DLB ⍵)∊'*+-'}tx:0</code>
<code> [4]      pattern←'^\s{0,',(⍕⍺),'}[-+\*]\s'</code>
<code> [5]      0≠≢pattern ⎕S 0⊣tx</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_135">#.MarkAPL.MarkAPL.IsFence &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  IsFence←{</code>
<code> [1]  ⍝ ⍺ must be either ~ or `</code>
<code> [2]  ⍝ Returns 1 in case ⍵ is a valid fence for a code block.</code>
<code> [3]       md←⍵</code>
<code> [4]       fence←⍺</code>
<code> [5]       pattern←'^ {0,3}',fence,'{3,}'</code>
<code> [6]       0=≢pattern ⎕S 0⍠('Greedy' 0)('Mode' 'L')⊣md:0</code>
<code> [7]       remains←pattern ⎕R''⍠('Greedy' 0)('Mode' 'L')⊣md</code>
<code> [8]       ~fence∊{⍵↓⍨+/∧\fence=⍵}remains</code>
<code> [9]   }</code>
</div>
<code class="header" id="listing_136">#.MarkAPL.MarkAPL.IsFenceStart &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  IsFenceStart←{</code>
<code> [1]   ⍝ The start of a code block fence may have an info string after the fence as such.</code>
<code> [2]       md←⍵</code>
<code> [3]       3&lt;noOfBlanks←+/∧\' '=md:0             ⍝ Max three blanks</code>
<code> [4]       md←noOfBlanks↓md</code>
<code> [5]       fence←⊃md</code>
<code> [6]       ~fence∊'`~':0</code>
<code> [7]       3&gt;noOfFencingChars←+/∧\md=fence:0     ⍝ At least three fencing characters</code>
<code> [8]       0=≢md←noOfFencingChars↓md:1</code>
<code> [9]       ~fence∊md                             ⍝ Any info string must not contain the fence character</code>
<code> [10]  }</code>
</div>
<code class="header" id="listing_137">#.MarkAPL.MarkAPL.IsHtmlList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsHtmlList←{</code>
<code> [1] ⍝ Returns a 1 in case ⍵ qualifies as an LI element of a list.</code>
<code> [2] ⍝ That is the case if one of the following conditions holds true:</code>
<code> [3]      tx←⍵</code>
<code> [4]      ⍺←99                          ⍝ Number of leading blanks allowed.</code>
<code> [5]      ⍺ IsBulletedHtmlList tx:1</code>
<code> [6]      ⍺ IsOrderedHtmlList tx</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_138">#.MarkAPL.MarkAPL.IsLeanPubEncodingLine &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsLeanPubEncodingLine←{</code>
<code> [1] ⍝ For the Leanpub Servcie the first line of the markdown (⍵) my contain `{:: encoding="` somewhere.</code>
<code> [2] ⍝ This function returns a 1 in case this is true.\\</code>
<code> [3] ⍝ Note that this is **not** related to the LeanPub extensions.</code>
<code> [4]      ≢'^ *{:: encoding=".*$'⎕S 0⊣⍵</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_139">#.MarkAPL.MarkAPL.IsOrderedHtmlList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  IsOrderedHtmlList←{</code>
<code> [1]  ⍝ Returns a 1 in case ⍵ qualifies as an LI element of an ordered list.</code>
<code> [2]  ⍝ ⍺ is the number of leading blanks allowed (for a starting list item this would be 3).</code>
<code> [3]  ⍝ [1] Zero to many white spaces</code>
<code> [4]  ⍝ [2] 1 to 9 digits ...</code>
<code> [5]  ⍝ [3] ... but not more than 9 of them</code>
<code> [6]  ⍝ [4] Either a `.` or a `)`</code>
<code> [7]  ⍝ [5] One or more white spaces</code>
<code> [8]  ⍝ Then it's an ordered list item</code>
<code> [9]       tx←⍵</code>
<code> [10]      0=≢'^\s*?\b\d{1,9}\b[.)]\s+?'⎕S 0⊣tx:0</code>
<code> [11]      ⍺&gt;3:1</code>
<code> [12]      3≥+/∧\' '=tx</code>
<code> [13]  }</code>
</div>
<code class="header" id="listing_140">#.MarkAPL.MarkAPL.IsSelfDefinedHtmlTag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> flag←IsSelfDefinedHtmlTag tag</code>
<code> [1]  flag←0</code>
<code> [2]  :If '-'∊tag                                   ⍝ A self-defined tag MUST contain a hyphen</code>
<code> [3]  :AndIf ∧/tag∊AllAllowedCharsInTag             ⍝ Check for allowed characters</code>
<code> [4]      flag←(⊃tag)∊TagMustStartWith              ⍝ The first char after the `&lt;` must be a char</code>
<code> [5]  :EndIf</code>
</div>
<code class="header" id="listing_141">#.MarkAPL.MarkAPL.IsTableRow &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsTableRow←{</code>
<code> [1]  ⍝ ⍵ qualifies as a table row if it contains at least 2 un-escaped pipes (`|`).</code>
<code> [2]      row←,⍵</code>
<code> [3]      mask←~GetMaskForCode row</code>
<code> [4]      0=+/b←'|'=mask/row:0</code>
<code> [5]      ∨/'\'≠(' ',row)[⍸b]</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_142">#.MarkAPL.MarkAPL.IsUnicodeCharacter &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsUnicodeCharacter←{</code>
<code> [1] ⍝ Input is a text vector.</code>
<code> [2] ⍝ Returns 0 or 1 for every single chacter in ⍵.</code>
<code> [3] ⍝ Uses RegEx for the identification, therefore slow on large amounts of data.</code>
<code> [4]      1=≢⍵:≢'\p{L}'⎕S 0⊣⍵</code>
<code> [5]      ∇¨⍵</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_143">#.MarkAPL.MarkAPL.IsolateLink &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> IsolateLink←{</code>
<code> [1]      txt←⍵</code>
<code> [2]      mask←⍺</code>
<code> [3]      0=+/b←']('⍷mask\mask/txt:⍬</code>
<code> [4]      link←⌽(b⍳1)↑txt</code>
<code> [5]      mask2←⌽(≢link)↑mask</code>
<code> [6]      link2←mask2\mask2/link</code>
<code> [7]      (≢link)-1++/∧\~(+\link2='[')=+\link2=']'</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_144">#.MarkAPL.MarkAPL.LeanPubAltTextFor &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> LeanPubAltTextFor←{</code>
<code> [1]      altText←'Error' 'Discussion' 'Information' 'Warning' 'Question' 'Tip' 'Exercise'</code>
<code> [2]      extension←'ediwqtx'</code>
<code> [3]      (extension⍳⎕C ⍵)⊃altText</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_145">#.MarkAPL.MarkAPL.LeanPubImageFor &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> LeanPubImageFor←{</code>
<code> [1]      icons←'error.png' 'discussion.png' 'information.png' 'warning.png' 'question.png' 'tip.png' 'exercise.png'</code>
<code> [2]      extension←'ediwqtx'</code>
<code> [3]      icon←(extension⍳⎕C ⍵)⊃icons</code>
<code> [4]      parms←⍺</code>
<code> [5]      parms.leanpubIconsUrl,icon</code>
<code> [6]  }</code>
</div>
<code class="header" id="listing_146">#.MarkAPL.MarkAPL.MakeLiteralForRegex &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MakeLiteralForRegex←{</code>
<code> [1] ⍝ Escapes all reserved chars in ⍵ which is a RegEx search pattern that needs to be interpreted literal.</code>
<code> [2]      literal←⍵</code>
<code> [3]      reservedChars←'^.\$|?+()['</code>
<code> [4]      b←literal∊reservedChars</code>
<code> [5]      0=+/b:literal</code>
<code> [6]      (b/literal)←('\',¨reservedChars)[reservedChars⍳b/literal]</code>
<code> [7]      ⊃,/literal</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_147">#.MarkAPL.MarkAPL.MarkUpAsCode &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MarkUpAsCode←{</code>
<code> [1]      (code specialAttrs infoString)←⍵</code>
<code> [2]      code←,⊆code</code>
<code> [3]      st←'&lt;pre',((0≠≢infoString)/' class="',infoString,'"'),' tabindex="0"&gt;&lt;code',({0=≢⍵:⍵ ⋄ ' ',⍵}A.DMB specialAttrs),'&gt;'    ⍝ Start tag</code>
<code> [4]      (1⊃code)←st,1⊃code</code>
<code> [5]      ((≢code)⊃code),←'&lt;/code&gt;&lt;/pre&gt;'</code>
<code> [6]      code</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_148">#.MarkAPL.MarkAPL.MarkUpInlineCode &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  tx2←MarkUpInlineCode tx</code>
<code> [1]   :If 0&lt;+/mask←GetMaskForCode tx2←tx</code>
<code> [2]       offset1←⍸0 1⍷0,mask</code>
<code> [3]       tx2[offset1]←⊂'&lt;code&gt;'</code>
<code> [4]       offset2←⍸1 0⍷mask,0</code>
<code> [5]       tx2[offset2]←⊂'&lt;/code&gt;'</code>
<code> [6]       ⍝ In case a block was opened/closed by more than just one backtick we need to get rid of the additonal ones:</code>
<code> [7]       noOf←tx2∘{+/∧\'`'=∊⍵↓⍺}¨offset1           ⍝ noOf opening (closing backticks). Those larger than 0 need attention</code>
<code> [8]       :For i :In ⍳≢noOf</code>
<code> [9]           :If 0&lt;i⊃noOf</code>
<code> [10]              tx2[offset1[i]+⍸{(∧\'`'=⍵)∨⌽∧\'`'=⌽⍵}tx2[offset1[i]+⍳offset2[i]-offset1[i]+1]]←⊂''</code>
<code> [11]          :EndIf</code>
<code> [12]      :EndFor</code>
<code> [13]      tx2←⊃,/tx2</code>
<code> [14]      leading←(¯1+1⊃⍸'&lt;code&gt;'⍷tx2)↑tx2</code>
<code> [15]      tx2←(≢leading)↓tx2</code>
<code> [16]      tx2←(≢'code&gt;')↓¨{⍵⊆⍨~'&lt;code&gt;'⍷⍵}tx2</code>
<code> [17]      tx2←'&lt;code&gt;'∘,¨MarkUpInlineCode_¨tx2</code>
<code> [18]      tx2←leading,⊃,/tx2</code>
<code> [19]  :EndIf</code>
</div>
<code class="header" id="listing_149">#.MarkAPL.MarkAPL.MarkUpInlineCode_ &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> txt←MarkUpInlineCode_ txt</code>
<code> [1]  length←¯1+⍸'&lt;/code&gt;'⍷txt</code>
<code> [2]  :If 2&lt;length</code>
<code> [3]      buff←length↑txt</code>
<code> [4]  :AndIf buff∨.≠' '</code>
<code> [5]  :AndIf buff[1,≢buff]∧.=' '</code>
<code> [6]      txt←((length-2)↑1↓txt),length↓txt</code>
<code> [7]  :EndIf</code>
<code> [8] ⍝Done</code>
</div>
<code class="header" id="listing_150">#.MarkAPL.MarkAPL.MaskTagAttrs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MaskTagAttrs←{</code>
<code> [1]      txt←⍵</code>
<code> [2]      r←(≢txt)⍴0</code>
<code> [3]      ~'&lt;'∊txt:r</code>
<code> [4]      ind←∊{(⊃⍵)+⍳1↓⍵}¨'&lt;[a-z]*\b[^&gt;]*&gt;'⎕S(0 1)⊣txt</code>
<code> [5]      r[ind]←1</code>
<code> [6]      r</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_151">#.MarkAPL.MarkAPL.MassageCodeBlock &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> cb←MassageCodeBlock(cb noOfBlanks)</code>
<code> [1]  pc←¯1↓1↓cb                            ⍝ Pure code: without the fences.</code>
<code> [2]  :If ' '∧.=⊃,/noOfBlanks↑¨pc           ⍝ We take this as indicator that the pure code has it's own ideas regarding indentation; nothing needs to be done</code>
<code> [3]      (¯1↓1↓cb)←noOfBlanks↓¨pc</code>
<code> [4]  :EndIf</code>
</div>
<code class="header" id="listing_152">#.MarkAPL.MarkAPL.MassageFilename &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MassageFilename←{</code>
<code> [1]      CorrectSlash'file:/{2,3}'⎕R''⊣⍵</code>
<code> [2]  }</code>
</div>
<code class="header" id="listing_153">#.MarkAPL.MarkAPL.Matrix2MarkdownList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  md←Matrix2MarkdownList mat</code>
<code> [1]   :Access Public Shared</code>
<code> [2]  ⍝ Converts an APL matrix in to list definition(s).\\</code>
<code> [3]  ⍝ The matrix must have three columns:\\</code>
<code> [4]  ⍝ 1. List type. 0=bulleted list, 1 etc numeric list **and** starting point.</code>
<code> [5]  ⍝ 2. Nesting level. May start with either 0 or 1.</code>
<code> [6]  ⍝ 3. Text vector of vector of text vector.</code>
<code> [7]   'Invalid right argument - not a matrix'⎕SIGNAL 11/⍨2≠⍴⍴mat</code>
<code> [8]   'Invalid right argument - must have 3 columns'⎕SIGNAL 11/⍨3≠2⊃⍴mat</code>
<code> [9]   'First line''s level must be either 0 or 1'⎕SIGNAL 11/⍨~(⊃mat)∊0 1</code>
<code> [10]  'Invalid right argument - must have 3 columns'⎕SIGNAL 11/⍨~∧/mat[;1]∊0,⍳999</code>
<code> [11]  mat[;2]←{⍵-1}⍣(1=⊃mat[;2])⊣mat[;2]        ⍝ Ensure 0 is first level</code>
<code> [12]  md←mat[;2]⍴¨' '</code>
<code> [13]  type←0=mat[;1]</code>
<code> [14]  (type/md)←(type/md),¨⊂'* '</code>
<code> [15]  type←~type</code>
<code> [16]  (type/md)←(type/md),¨(⍕¨type/mat[;1]),¨⊂'. '</code>
<code> [17]  md←⊃,/md{(≡⍵)∊0 1:⊂⍺,⍵ ⋄ (⊂⍺,⊃⍵),(⊂(≢⍺)⍴' '),¨1↓⍵}¨mat[;3]</code>
<code> [18]  md←'' '',md,'' ''</code>
<code> [19] ⍝Done</code>
</div>
<code class="header" id="listing_154">#.MarkAPL.MarkAPL.Matrix2MarkdownTable &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←{colHeader}Matrix2MarkdownTable mat</code>
<code> [1]   :Access Public Shared</code>
<code> [2]  ⍝ Converts an APL matrix into Markdown.\\</code>
<code> [3]  ⍝ Since the Markdown is created automatically we value space &amp; performance more than readability.\\</code>
<code> [4]  ⍝ Without a left argument the right argument transforms into a matrix without</code>
<code> [5]  ⍝ column headers. If a column is strictly numeric it is right-aligned.\\</code>
<code> [6]  ⍝ If a left argument is provided then it is expected to be a vector of text vectors</code>
<code> [7]  ⍝ defining column headers.\\</code>
<code> [8]  ⍝ Such column headers may define column alignment via a leading and/or a trailing `:`; that means</code>
<code> [9]  ⍝ that when using this method you cannot have a trailing `:` in a column header.\\</code>
<code> [10] ⍝ In case no column headers are specified or the column headers don't define alignment then columns</code>
<code> [11] ⍝ that contain nothing but numeric data are by default right-aligned while all other columns</code>
<code> [12] ⍝ are left-aligned.\\</code>
<code> [13] ⍝ This method does not allow special attributes, although they may be added in a seperate</code>
<code> [14] ⍝ step of course.</code>
<code> [15]  'Invalid right argument - not a matrix'⎕SIGNAL 11/⍨2≠⍴⍴r←mat</code>
<code> [16]  :If 0&lt;=/b←,∨/¨'|'∊¨r                          ⍝ Any "|" anywhere?!</code>
<code> [17]      (b/,r)←EscapePipeSymbolInCell¨b/,r</code>
<code> [18]  :EndIf</code>
<code> [19]  dt←0=⊃¨0⍴¨r                                   ⍝ Data type</code>
<code> [20]  :If 0=⎕NC'colHeader'                          ⍝ If no left argument...</code>
<code> [21]      colHeader←,[0.5](':-' '-:')[1+∧⌿dt]       ⍝ ... then we right-align numeric cols.</code>
<code> [22]  :Else</code>
<code> [23]      'Left argument: length error'⎕SIGNAL 6/⍨(≢colHeader)≠2⊃⍴mat</code>
<code> [24]      'Left argument: depth error'⎕SIGNAL 11/⍨2≠≡colHeader</code>
<code> [25]      colHeader←⍉↑(∧⌿dt)BuildColumnHeader¨colHeader</code>
<code> [26]  :EndIf</code>
<code> [27]  r←colHeader⍪r</code>
<code> [28]  dt←((⍴colHeader)⍴0)⍪dt</code>
<code> [29]  ((,dt)/,r)←⍕¨(,dt)/,r                         ⍝ Format numeric cells only</code>
<code> [30]  r←'|',¨r                                      ⍝ Insert the "|" for cell recognition</code>
<code> [31]  noOfColumns←2⊃⍴r</code>
<code> [32]  r←↓r</code>
<code> [33]  r←noOfColumns{⎕ML←3 ⋄ (1&lt;⍺)↓¨∊¨⍵}r</code>
<code> [34] ⍝Done</code>
</div>
<code class="header" id="listing_155">#.MarkAPL.MarkAPL.NotWithinWord &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  flag←x NotWithinWord hit</code>
<code> [1]  ⍝ ⍵ is a vector of hits for, say, `_`</code>
<code> [2]  ⍝ ⍺ is a two-element vector:</code>
<code> [3]  ⍝   [1] Something like a paragraph</code>
<code> [4]  ⍝   [2] Length of markup (_, *, **, __, ~~, ...); 1∨2</code>
<code> [5]   (txt length)←x</code>
<code> [6]   :If ~flag←' '=boundary1←(⊂hit+¯1)⌷txt       ⍝ What's to the left of the hit? ∆⍙&gt;,⎕D and Unicode "letters" qualify</code>
<code> [7]       boundary2←(⊂hit+length)⌷txt   ⍝ What's to the left and right of the hit</code>
<code> [8]       :If '&gt;'=boundary1</code>
<code> [9]           flag1←0</code>
<code> [10]      :ElseIf 0=flag1←IsUnicodeCharacter boundary1</code>
<code> [11]          l←¯1+⊃'[\p{L}0-9∆⍙]+'⎕S 1⊣'a',buff←⌽¯2↓hit↑txt    ⍝ How many are there?</code>
<code> [12]          flag1←∨/IsUnicodeCharacter l↑buff                 ⍝ Investigate whether at least one "letter" is part of it</code>
<code> [13]      :EndIf</code>
<code> [14]      flag2←(IsUnicodeCharacter boundary2)∨boundary1∊'&lt;∆⍙',⎕D</code>
<code> [15]      flag←~flag1∧flag2</code>
<code> [16]  :EndIf</code>
</div>
<code class="header" id="listing_156">#.MarkAPL.MarkAPL.NumberHeaders &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> NumberHeaders←{</code>
<code> [1]      ns←⍵</code>
<code> [2]      (,0)≡,ns.parms.numberHeaders:ns</code>
<code> [3]      ns←CalculateHeaderNumbers ns</code>
<code> [4]      InjectNumberedHeaders ns</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_157">#.MarkAPL.MarkAPL.PolishWarnings &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←PolishWarnings ns</code>
<code> [1]   noOf←≢ns.report</code>
<code> [2]   :For i :In ⍳noOf</code>
<code> [3]       this←i⊃ns.report</code>
<code> [4]       :If 'Invalid internal link:'{⍺≡(≢⍺)↑⍵}this</code>
<code> [5]           name←{⍵↑⍨¯1+⍵⍳']'}{⍵↓⍨⍵⍳'['}this</code>
<code> [6]       :AndIf (⊂name)∊ns.headers[;2]</code>
<code> [7]            ⍝ It is an internal bookmark link, which was wrongly reported as invalid, so we remove it from the report</code>
<code> [8]           ns.report[i]←⊂''</code>
<code> [9]       :EndIf</code>
<code> [10]  :EndFor</code>
<code> [11]  ns.report←(0&lt;≢¨ns.report)/ns.report</code>
</div>
<code class="header" id="listing_158">#.MarkAPL.MarkAPL.ProcessATX_Header &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  flag←ProcessATX_Header ns</code>
<code> [1]   flag←0</code>
<code> [2]   l←+/∧\'#'=1⊃ns.leadingChars                   ⍝ Level</code>
<code> [3]   'Invalid header level'⎕SIGNAL 11/⍨~l∊⍳6</code>
<code> [4]   txt←1⊃ns.markdown</code>
<code> [5]   :If 4&gt;+/∧\' '=txt                             ⍝ A maximum of three spaces is allowed</code>
<code> [6]   :AndIf ' '=⊃txt~'#'                           ⍝ The first char after the # must be a blank</code>
<code> [7]       sa←GetSpecialAttributes⊃ns.markdown</code>
<code> [8]       txt←sa DropSpecialAttributes txt</code>
<code> [9]   :AndIf '#'∨.≠txt~' '</code>
<code> [10]      (level c)←txt{(⍵↑⍺)((1+⍵)↓⍺)}⊃⍸'# '⍷txt   ⍝ c=Caption; first eliminate leading `#`</code>
<code> [11]      :If (' ',level)≡(-1+≢level)↑c             ⍝ Does it have a closing tag?</code>
<code> [12]          c←(-1+≢level)↓c                       ⍝ Remove closing tag</code>
<code> [13]      :EndIf</code>
<code> [14]      c←ns CheckOddNumberOfDoubleQuotes c'header'</code>
<code> [15]      c2←⊃ns ProcessInlineMarkUp c</code>
<code> [16]      bookmarkName←ns GetBookMarkNameFromCaption txt((l≤ns.parms.bookmarkLink)/sa)</code>
<code> [17]      bookmarkName_←LowercaseID bookmarkName</code>
<code> [18]      anchor←AddBookmarkLink l ns bookmarkName_</code>
<code> [19]      ns.html,←ns.parms.div_h_tag/⊂'&lt;div class="h_tag"&gt;'</code>
<code> [20]      ns.html,←{⊂⍣(0≠≢⍵)⊣⍵}anchor</code>
<code> [21]      ns.html,←⊂A.DMB'&lt;h',(⍕l),({0=≢⍵:⍵ ⋄ ' data-id="',⍵,'"'}bookmarkName),({0=≢⍵:⍵ ⋄ ' ',⍵}RemoveIdFromSpecialAttributes⍣(0≠≢anchor)⊣sa),'&gt;',c2,'&lt;/h',(⍕l),'&gt;'</code>
<code> [22]      ns.html,←(0&lt;≢anchor)/⊂'&lt;/a&gt;'</code>
<code> [23]      ns.html,←ns.parms.div_h_tag/⊂'&lt;/div&gt;'</code>
<code> [24]      ns.headers⍪←l bookmarkName_ c2''</code>
<code> [25]      ns.headerLineNos,←⊃ns.lineNumbers</code>
<code> [26]      ns.noOf←1</code>
<code> [27]      ns←Drop ns</code>
<code> [28]      flag←1</code>
<code> [29]  :EndIf</code>
<code> [30] ⍝Done</code>
</div>
<code class="header" id="listing_159">#.MarkAPL.MarkAPL.ProcessAbbreviationDefs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessAbbreviationDefs ns</code>
<code> [1]   r←0</code>
<code> [2]   :If '*['≡2⍴⊃ns.leadingChars</code>
<code> [3]       r←1</code>
<code> [4]       :If 0≠≢'\*\[[\p{L} \/\+-_=&amp;]*\]:'⎕S 0⊣⊃ns.markdown      ⍝ Find identifiers</code>
<code> [5]           (abbr comment)←¯1 0↓¨':'A.Split 2↓⊃ns.markdown</code>
<code> [6]           (abbr comment)←A.DLB∘A.DTB¨abbr comment</code>
<code> [7]           ns.abbreviations⍪←abbr comment</code>
<code> [8]       :Else</code>
<code> [9]           ns.report,←⊂'Invalid abbreviation in line ',⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers</code>
<code> [10]      :EndIf</code>
<code> [11]      ns←Drop ns</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_160">#.MarkAPL.MarkAPL.ProcessAsterisks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  txt←ProcessAsterisks txt_</code>
<code> [1]  ⍝ Takes a string and marks up everything between * and * as &lt;em&gt;</code>
<code> [2]  ⍝ except when it...</code>
<code> [3]  ⍝ * occurs within a word</code>
<code> [4]  ⍝ * occurs within APL code</code>
<code> [5]  ⍝ * has a white-space char to the right of any opening marker</code>
<code> [6]  ⍝ * has a white-space char to the left of any closing marker</code>
<code> [7]  ⍝ Call this **after** having called ProcessDoubleAsterisks</code>
<code> [8]   txt2←txt←'  ',txt_,'  '</code>
<code> [9]   txt2←'\\\*'⎕R'⌹⌹'⍠('Mode' 'D')⊣txt2</code>
<code> [10]  ((GetMaskForCode txt2)/txt2)←' '</code>
<code> [11]  :If 0&lt;+/bool←'*'=txt2</code>
<code> [12]  :AndIf 1&lt;+/bool</code>
<code> [13]  :AndIf 0&lt;+/bool∧bool\~∧/⍉txt2[¯1 1∘.+⍸bool]∊AllWhiteSpaceChars</code>
<code> [14]  :AndIf 0&lt;+/bool∧bool\∧/⍉txt2[¯1 1∘.+⍸bool]≠'*'</code>
<code> [15]      mask←GetMaskForCode txt</code>
<code> [16]      bool∧←~mask</code>
<code> [17]  :AndIf 0≠≢ind←⍸bool</code>
<code> [18]      ind←{⍵↑⍨(≢⍵)-2|≢⍵}ind</code>
<code> [19]      start←((≢ind)⍴1 0)/ind</code>
<code> [20]      end←((≢ind)⍴0 1)/ind</code>
<code> [21]      txt[start]←⊂'&lt;em&gt;'</code>
<code> [22]      txt[end]←⊂'&lt;/em&gt;'</code>
<code> [23]      txt←⊃,/txt</code>
<code> [24]  :EndIf</code>
<code> [25]  txt←2↓¯2↓txt</code>
<code> [26] ⍝Done</code>
</div>
<code class="header" id="listing_161">#.MarkAPL.MarkAPL.ProcessAutomaticLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ProcessAutomaticLinks←{</code>
<code> [1]   ⍝ This must be done early because later any "&lt;" and "&gt;" will be replaced by there HTML entities.</code>
<code> [2]   ⍝ (It was a very bad idea to use this syntax! [](url) is so obvious!)</code>
<code> [3]   ⍝ Note that this function escapes any of `_`, `__`, `*`, `**`, `~~`.</code>
<code> [4]       txt←⍵</code>
<code> [5]       mask←~GetMaskForCode txt</code>
<code> [6]       0=≢i1←¯1+⍸'&lt;'=mask\mask/txt:txt</code>
<code> [7]       txt←i1[1]⌽txt</code>
<code> [8]       (≢txt)&lt;l←txt⍳'&gt;':(-i1[1])⌽txt</code>
<code> [9]       link←¯1↓1↓l↑txt</code>
<code> [10]      sa←GetSpecialAttributes{'{'∊⍵:{⍵↑⍨⍵⍳'}'}{⍵↓⍨¯1+⍵⍳'{'}⍵ ⋄ ⍵}link</code>
<code> [11]      link←A.DTB{⍵/⍨~Between ⍵∊'{}'}link</code>
<code> [12]      ∨/link∊AllWhiteSpaceChars:⍵                       ⍝ The link text must not contain any white space</code>
<code> [13]      0={(∨/'://'⍷⍵)∨'@'∊⍵}link:⍵                       ⍝ We need to catch URLs and email addresses</code>
<code> [14]      link,⍨←(0={(∨/'://'⍷⍵)∨'@'∊⍵}link)/'http://'</code>
<code> [15]  ⍝TODO⍝      link←'\_' '\*' '\~\~'⎕R'\\_' '\\*' '\\~\\~'⍠('Greedy' 0)⊣link</code>
<code> [16]      link,⍨←(('@'∊link)∧'mailto:'{⍺≢⎕C(≢⍺)↑⍵}link)/'mailto:'</code>
<code> [17]      class←' class="',((1+'mailto'{⍺≡(≢⍺)↑⍵}link)⊃'external_link' 'mailto_link'),'"'</code>
<code> [18]      linkText←sa DropSpecialAttributes'mailto:'{⍵↓⍨(≢⍺)×⍺≡(≢⍺)↑⍵}1↓¯1↓l↑txt</code>
<code> [19]      linkText←'\_' '\*' '\~\~'⎕R'\\_' '\\*' '\\~\\~'⍠('Greedy' 0)⊣linkText</code>
<code> [20]      txt←('&lt;a href="',link,'"',class,sa,'&gt;',linkText,'&lt;/a&gt;'),l↓txt</code>
<code> [21]      txt←(-i1[1])⌽txt</code>
<code> [22]      ∇ txt</code>
<code> [23]  }</code>
</div>
<code class="header" id="listing_162">#.MarkAPL.MarkAPL.ProcessBlockQuotes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessBlockQuotes ns</code>
<code> [1]  ⍝ Processes any blockquotes recursively. That way they can contain **everything**, including blockquotes.</code>
<code> [2]   r←0</code>
<code> [3]   :If '&gt; '≡2↑⊃ns.leadingChars</code>
<code> [4]       ns.noOf←ScanForBlockQuotes ns</code>
<code> [5]       parms←CreateParms</code>
<code> [6]       parms.bookmarkLink←0</code>
<code> [7]       parms.markdownStrict←ns.parms.markdownStrict</code>
<code> [8]       parms.verbose←0</code>
<code> [9]       parms.checkLinks←0</code>
<code> [10]      parms.checkFootnotes←0</code>
<code> [11]      parms.subTocs←0</code>
<code> [12]      parms.syntaxSugar←ns.parms.syntaxSugar</code>
<code> [13]      parms.lineNumberOffset←⊃ns.lineNumbers</code>
<code> [14]      md←ns.noOf↑ns.markdown</code>
<code> [15]      (1⊃md)←2↓1⊃md</code>
<code> [16]      (1↓md)←(2×'&gt; '∘≡¨2↑¨1↓md)↓¨1↓md</code>
<code> [17]      sa←GetSpecialAttributes⊃md</code>
<code> [18]      (⊃md)←sa DropSpecialAttributes⊃md</code>
<code> [19]      ns2←Init parms md</code>
<code> [20]      ns2←Process ns2</code>
<code> [21]      ns.html,←(⊂'&lt;blockquote',((0&lt;≢sa)/' ',A.DLB sa),'&gt;'),ns2.html,⊂'&lt;/blockquote&gt;'</code>
<code> [22]      ns.report,←ns2.report</code>
<code> [23]      ns←Drop ns</code>
<code> [24]      r←1</code>
<code> [25]  :EndIf</code>
<code> [26] ⍝Done</code>
</div>
<code class="header" id="listing_163">#.MarkAPL.MarkAPL.ProcessCheckBoxes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessCheckBoxes ns</code>
<code> [1]  ⍝ Replaces "[ ]" with "☐" and "[x]" or "[X]" with "☒"</code>
<code> [2]   r←0</code>
<code> [3]   :If 0&lt;≢list←(+/∧\~ns.emptyLines)↑ns.markdown</code>
<code> [4]       b←∧\{0&lt;≢'^ {0,3}\[[ xX]] '⎕S 0⊣⍵}¨list</code>
<code> [5]   :AndIf ∨/b</code>
<code> [6]       noOfLines←+/b</code>
<code> [7]       list←b/list</code>
<code> [8]       list←ns{⊃⍺ ProcessInlineMarkUp ⍵}¨list</code>
<code> [9]       b←∨/¨'[ ]'∘⍷¨list</code>
<code> [10]      (b/list)←{'\[ \]'⎕R'☐'⊣⍵}¨b/list</code>
<code> [11]      b←~b</code>
<code> [12]      (b/list)←{'\[[xX]\]'⎕R'☒'⊣⍵}¨b/list</code>
<code> [13]      ns.noOf←noOfLines</code>
<code> [14]      r←1</code>
<code> [15]      ns.html,←⊂'&lt;ul class="checkboxes"&gt;'</code>
<code> [16]      ns.html,←{'&lt;li',({'☒'∊⍵:' class="checked"&gt;' ⋄ '&gt;'}⍵),({⍵↓⍨1+⌊/⍵⍳'☐☒'}⍵),'&lt;/li&gt;'}¨list</code>
<code> [17]      ns.html,←⊂'&lt;/ul&gt;'</code>
<code> [18]      ns←Drop ns</code>
<code> [19]      ∆LastLineWasEmpty←1</code>
<code> [20]  :EndIf</code>
<code> [21] ⍝Done</code>
</div>
<code class="header" id="listing_164">#.MarkAPL.MarkAPL.ProcessCodeBlock &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessCodeBlock ns</code>
<code> [1]  ⍝ Handles code block, either "~~~" (Markdown2 Extra) or "```" (Git).</code>
<code> [2]   r←0</code>
<code> [3]   line←⊃ns.markdown</code>
<code> [4]   :If IsFenceStart line</code>
<code> [5]       line←A.DLB line</code>
<code> [6]       min←{(⊃⍵)+.=⍵}line</code>
<code> [7]       fence←⊃line</code>
<code> [8]       pattern←('^\s{0,3}'),fence,'{',(⍕,min),',}'</code>
<code> [9]   :AndIf ¯1≢ns.noOf←pattern FindFenceEnd 1↓ns.markdown</code>
<code> [10]      :If 2&lt;ns.noOf</code>
<code> [11]          bl←1↓¯1↓ns.noOf↑ns.markdown</code>
<code> [12]          sa←GetSpecialAttributes line</code>
<code> [13]          line←sa DropSpecialAttributes line</code>
<code> [14]          infoString←GetInfoString line</code>
<code> [15]          :If 0&lt;+/≢¨bl~¨' '</code>
<code> [16]              bl←((+/∧\' '=⊃ns.markdown)⌊⌊/+/∧\' '=↑bl)↓¨bl   ⍝ Drop as many blanks as there are indendet blanks</code>
<code> [17]              buff←(2 EscapeSpecialChars¨bl)sa infoString</code>
<code> [18]              buff←ns MarkUpAsCode buff</code>
<code> [19]              :If ns.parms.leanpubExtensions</code>
<code> [20]                  buff←ProcessLeanPubCodeEmphasizing buff</code>
<code> [21]              :EndIf</code>
<code> [22]              ns.html,←buff</code>
<code> [23]          :EndIf</code>
<code> [24]          ns.noOf←2+≢bl</code>
<code> [25]      :ElseIf 2≠ns.noOf</code>
<code> [26]      :OrIf 0≠≢(⊃ns.markdown)~'~` '</code>
<code> [27]          ns.noOf←0</code>
<code> [28]          :Return</code>
<code> [29]      :EndIf</code>
<code> [30]      r←1</code>
<code> [31]      ns←Drop ns</code>
<code> [32]  :EndIf</code>
</div>
<code class="header" id="listing_165">#.MarkAPL.MarkAPL.ProcessDataDefs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessDataDefs ns</code>
<code> [1]   r←0</code>
<code> [2]   :If '['=⊃⊃ns.leadingChars</code>
<code> [3]       :If 0≠≢⍸'[data]:'≡⎕C 7↑⊃ns.leadingChars      ⍝ Find identifiers</code>
<code> [4]           def←⊃ns.markdown</code>
<code> [5]           :If '='∊def</code>
<code> [6]               (id value)←¯1 0↓¨7 0↓¨{i←⍵⍳'=' ⋄ (i↑⍵)(i↓⍵)}def</code>
<code> [7]               id←A.DLB A.DTB id</code>
<code> [8]               value←A.DLB A.DTB value</code>
<code> [9]               :If ''''∊value</code>
<code> [10]                  :If ''''''≡2⍴¯1⌽value</code>
<code> [11]                      value←¯1↓1↓value</code>
<code> [12]                  :Else</code>
<code> [13]                      value←''</code>
<code> [14]                      ns.report,←⊂'Data value definition for line ',(⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers),' is invalid'</code>
<code> [15]                  :EndIf</code>
<code> [16]              :Else</code>
<code> [17]                  (b v)←⎕VFI value</code>
<code> [18]                  :If ∧/b</code>
<code> [19]                      value←{1=≢⍵:⍬⍴⍵ ⋄ ⍵}v</code>
<code> [20]                  :EndIf</code>
<code> [21]              :EndIf</code>
<code> [22]              ns.data,←⊂id value</code>
<code> [23]          :Else</code>
<code> [24]              ns.report,←⊂'Data definition on line ',(⍕ns.parms.lineNumberOffset+⊃ns.lineNumbers),' is invalid'</code>
<code> [25]          :EndIf</code>
<code> [26]          ns←Drop ns</code>
<code> [27]          r←1</code>
<code> [28]      :EndIf</code>
<code> [29]  :EndIf</code>
</div>
<code class="header" id="listing_166">#.MarkAPL.MarkAPL.ProcessDefinitionLists &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessDefinitionLists ns</code>
<code> [1]   r←0</code>
<code> [2]   :If 1&lt;≢ns.markdown                                ⍝ A definitions has at least two lines</code>
<code> [3]   :AndIf 1≤ScanForPara ns                           ⍝ Exactly one line for a term but there might be no empty line after it.</code>
<code> [4]   :AndIf 0≠≢'^\s{0,3}:\s'⎕S 0⊣⊃(+/∧\1↓ns.emptyLines)↓1↓ns.markdown  ⍝ Is there ": " in the first non-empty line?</code>
<code> [5]       noOf←(≢ns.markdown)⌊(1 1⍷ns.emptyLines)⍳1     ⍝ Maximum number of lines until the last `:` of this definition list</code>
<code> [6]       colons←': '∘≡¨2↑¨noOf↑ns.leadingChars         ⍝ Where are any leading colons followed by a space?</code>
<code> [7]       total←0</code>
<code> [8]   :AndIf 0&lt;+/colons                                 ⍝ Any at all? If not it's not a definition list!</code>
<code> [9]       bl←noOf↑ns.markdown                           ⍝ The whole lot</code>
<code> [10]      html←⊂'&lt;dl&gt;'</code>
<code> [11]      el←{0=≢¨⍵}bl~¨' '                           ⍝ Empty lines</code>
<code> [12]      :Repeat</code>
<code> [13]          :If 1&lt;≢bl</code>
<code> [14]          :AndIf 0≠≢∊1↓bl</code>
<code> [15]          :AndIf 0≠≢'^\s{0,3}:\s'⎕S 0⊣{⍵⊃⍨1⍳⍨0&lt;≢¨⍵}1↓bl</code>
<code> [16]              sa←GetSpecialAttributes⊃bl</code>
<code> [17]              (⊃bl)←sa DropSpecialAttributes⊃bl</code>
<code> [18]              buff←('dt',sa)∘Tag¨1⊃¨ns ProcessInlineMarkUp¨1↑bl</code>
<code> [19]              not←1++/∧\1↓el</code>
<code> [20]              (bl colons el)←not↓¨bl colons el</code>
<code> [21]          :AndIf 0∊el</code>
<code> [22]               ⍝ Now we pick up everything that fulfills one of the following conditions:</code>
<code> [23]               ⍝ * Starts with a ": "</code>
<code> [24]               ⍝ * Starts with two spaces (plus any leading spaces before the ":")</code>
<code> [25]               ⍝ * Is an empty line</code>
<code> [26]              nop←+/∧\el∨colons∨{⊃(' '=¯1↓⍵)∧' '≠¯1↑⍵}¨(3++/∧\' '=⊃bl)↑¨bl</code>
<code> [27]          :AndIf 0&lt;≢bl2←nop↑bl</code>
<code> [28]              (bl colons el)←(≢bl2)↓¨bl colons el</code>
<code> [29]          :AndIf 0≠≢bl2←(0&lt;≢¨bl2~¨' ')/bl2</code>
<code> [30]              bl2{v←⍺ ⋄ 0=≢⍵:v ⋄ ((¯1+⊃⍵)⊃v)←A.DMB((¯1+⊃⍵)⊃v),' ',(⊃⍵)⊃v ⋄ ((⊃⍵)⊃v)←'' ⋄ v ∇ 1↓⍵}←⌽⍸':'≠⊃¨A.DLB¨bl2</code>
<code> [31]              bl2←(0&lt;≢¨bl2)/bl2</code>
<code> [32]              bl2←{⍵↓⍨1+⍵⍳':'}¨bl2</code>
<code> [33]              sa←GetSpecialAttributes¨bl2</code>
<code> [34]              bl2←sa DropSpecialAttributes¨bl2</code>
<code> [35]              bl2←⊃¨ns ProcessInlineMarkUp¨bl2</code>
<code> [36]              :If 1=not</code>
<code> [37]              :AndIf 1=≢bl2</code>
<code> [38]                  bl2←⊂('dd',⊃sa)Tag⊃bl2</code>
<code> [39]              :Else</code>
<code> [40]                  :If 1&lt;≢bl2←((⊂'dd'),¨sa)Tag¨Tag¨bl2</code>
<code> [41]                      (1⊃bl2)←'&lt;p&gt;'⎕R'&lt;p class="first_dd"&gt;'⊣1⊃bl2</code>
<code> [42]                  :EndIf</code>
<code> [43]              :EndIf</code>
<code> [44]              html,←buff,bl2</code>
<code> [45]              total+←not+nop</code>
<code> [46]          :Else</code>
<code> [47]              bl←''</code>
<code> [48]          :EndIf</code>
<code> [49]      :Until 0=≢bl</code>
<code> [50]      ns.noOf←total</code>
<code> [51]      html,←⊂'&lt;/dl&gt;'</code>
<code> [52]      r←1</code>
<code> [53]      ns.html,←html</code>
<code> [54]      ns←Drop ns</code>
<code> [55]      ∆LastLineWasEmpty←1</code>
<code> [56]  :EndIf</code>
<code> [57] ⍝Done</code>
</div>
<code class="header" id="listing_167">#.MarkAPL.MarkAPL.ProcessDoubleAsterisks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  txt←ProcessDoubleAsterisks txt_</code>
<code> [1]  ⍝ Takes a string and marks up everything between ** and ** as &lt;strong&gt;</code>
<code> [2]  ⍝ except when it occurs within a word or within APL code or the ** are surrounded on both sides by white space.</code>
<code> [3]  ⍝ Call this **before** calling ProcessAsterisks.</code>
<code> [4]   txt←'  ',txt_,'  '</code>
<code> [5]   :If 0&lt;+/bool←'**'⍷txt</code>
<code> [6]   :AndIf 0&lt;+/bool←bool∧bool\~∧/⍉txt[¯1 2∘.+⍸bool]∊AllWhiteSpaceChars</code>
<code> [7]   :AndIf 0&lt;+/bool←bool∧bool\txt[¯1+⍸bool]≠'\'</code>
<code> [8]       mask←GetMaskForCode txt</code>
<code> [9]       bool∧←~mask</code>
<code> [10]  :AndIf 0≠≢ind←⍸bool</code>
<code> [11]  :AndIf 0≠≢ind←(-2|≢ind)↓ind</code>
<code> [12]      start←((≢ind)⍴1 0)/ind</code>
<code> [13]      end←((≢ind)⍴0 1)/ind</code>
<code> [14]      txt[start]←⊂'&lt;strong&gt;'</code>
<code> [15]      txt[end]←⊂'&lt;/strong&gt;'</code>
<code> [16]      txt[1+start,end]←⊂''</code>
<code> [17]      txt←⊃,/txt</code>
<code> [18]  :EndIf</code>
<code> [19]  txt←2↓¯2↓txt</code>
<code> [20] ⍝Done</code>
</div>
<code class="header" id="listing_168">#.MarkAPL.MarkAPL.ProcessDoubleTildes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  txt←ProcessDoubleTildes txt_</code>
<code> [1]  ⍝ Takes a string and marks up everything between ~~ and ~~ as &lt;del&gt;</code>
<code> [2]  ⍝ except when it occurs within a word or within APL code.</code>
<code> [3]  ⍝ "~~" might also appear as "~~~", and it might be escaped.</code>
<code> [4]   txt←'  ',txt_,'  '</code>
<code> [5]   :If 0&lt;+/bool←'~~'⍷txt</code>
<code> [6]       ind←⍸bool</code>
<code> [7]   :AndIf 0&lt;+/bool1←bool∧bool\~txt[¯1+ind]∊'\~'</code>
<code> [8]   :AndIf 0&lt;+/bool2←bool∧bool\~txt[ind+≢'~~']∊'~\'</code>
<code> [9]   :AndIf 0&lt;+/bool←bool1∧bool2</code>
<code> [10]      mask←GetMaskForCode txt</code>
<code> [11]      bool∧←~mask</code>
<code> [12]  :AndIf 0≠≢ind←⍸bool</code>
<code> [13]  :AndIf 0≠≢ind←((txt 2∘NotWithinWord¨ind))/ind</code>
<code> [14]      start←((≢ind)⍴1 0)/ind</code>
<code> [15]      end←((≢ind)⍴0 1)/ind</code>
<code> [16]      txt[start]←⊂'&lt;del&gt;'</code>
<code> [17]      txt[end]←⊂'&lt;/del&gt;'</code>
<code> [18]      txt[1+start,end]←⊂''</code>
<code> [19]      txt←⊃,/txt</code>
<code> [20]  :EndIf</code>
<code> [21]  txt←2↓¯2↓txt</code>
<code> [22] ⍝Done</code>
</div>
<code class="header" id="listing_169">#.MarkAPL.MarkAPL.ProcessDoubleUnderscores &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  txt←ProcessDoubleUnderscores txt_</code>
<code> [1]  ⍝ Takes a string and marks up everything between __ and __ as &lt;strong&gt;</code>
<code> [2]  ⍝ except when it occurs within a word or within APL code or as part of a function call.</code>
<code> [3]   txt2←txt←'  ',txt_,'  '</code>
<code> [4]   ((GetMaskForCode txt2)/txt2)←' '</code>
<code> [5]   :If ∨/bool←'\_'⍷txt2</code>
<code> [6]  ⍝          txt2[,⍉0 1∘.+⍸ bool]←(2×+/bool)⍴'' '_'</code>
<code> [7]       txt2←'\\_'⎕R'aa'⊣txt2</code>
<code> [8]   :EndIf</code>
<code> [9]   :If 0&lt;+/bool←'__'⍷txt2</code>
<code> [10]  :AndIf 0&lt;+/bool∧bool\~∧/⍉txt2[¯1 2∘.+⍸bool]∊AllWhiteSpaceChars</code>
<code> [11]  :AndIf 0≠≢ind←⍸bool</code>
<code> [12]  :AndIf 0≠≢ind←((txt 2∘NotWithinWord¨ind))/ind</code>
<code> [13]      ind←{⍵↑⍨(≢⍵)-2|≢⍵}ind</code>
<code> [14]      start←((≢ind)⍴1 0)/ind</code>
<code> [15]      end←((≢ind)⍴0 1)/ind</code>
<code> [16]      txt[start]←⊂'&lt;strong&gt;'</code>
<code> [17]      txt[end]←⊂'&lt;/strong&gt;'</code>
<code> [18]      txt[1+start,end]←⊂''</code>
<code> [19]      txt←⊃,/txt</code>
<code> [20]  :EndIf</code>
<code> [21]  txt←2↓¯2↓txt</code>
<code> [22] ⍝Done</code>
</div>
<code class="header" id="listing_170">#.MarkAPL.MarkAPL.ProcessEmbeddedParms &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←ignoreEmbeddedParms ProcessEmbeddedParms ns</code>
<code> [1]  ⍝ Here we do not need to add ns.parms.lineNumberOffset because there are no</code>
<code> [2]  ⍝ embedded parameters with recursive calls anyway!</code>
<code> [3]   :If 0&lt;noOf←{¯1+1⍳⍨1 1⍷((0=≢¨⍵)∨⍵∧.=¨' '),1 1}¯1↓ns.markdown            ⍝ Two consecutive blank lines break the [parm]: definitions</code>
<code> [4]       :If 0=⊃b1←(⊃¨noOf↑ns.markdown)∊'[ ⍝'                               ⍝ First character must be one of those</code>
<code> [5]           b1[1]←IsLeanPubEncodingLine⊃ns.markdown                        ⍝ But it might also be a LeanPub encoding directive</code>
<code> [6]       :EndIf</code>
<code> [7]       (b1 buff)←noOf↑¨b1 ns.markdown</code>
<code> [8]       :If 0&lt;noOf←{(≢⍵)-¯1+(⌽⍵)⍳1},b1                                     ⍝ The number of candidates</code>
<code> [9]           buff←noOf↑buff</code>
<code> [10]      :AndIf 0&lt;+/b1←'['=⊃¨buff                                           ⍝ Leading `[` are required for [parm]: definitions!</code>
<code> [11]      :AndIf 0&lt;noOf←{(≢⍵)-¯1+(⌽⍵)⍳1},b1                                  ⍝ The number of candidates</code>
<code> [12]          buff[(IsLeanPubEncodingLine⊃buff)/1]←⊂''                       ⍝ Erase the LeanPub encoding directive</code>
<code> [13]          buff←noOf↑buff</code>
<code> [14]      :AndIf 0&lt;+/b1←'[parm]:'{⍺∘≡¨(≢⍺)↑¨⍵}buff                           ⍝ Now we are getting more specific because of `[data]:`</code>
<code> [15]      :AndIf 0&lt;noOf←{(≢⍵)-¯1+(⌽⍵)⍳1},b1</code>
<code> [16]          (b1 buff)←noOf↑¨b1 buff</code>
<code> [17]          b2←0=≢¨buff~¨' '                                               ⍝ Between any [parm]: lines there might be single blank lines</code>
<code> [18]          b3←'⍝'=⊃¨buff                                                  ⍝ Between any [parm]: lines there might be comment lines</code>
<code> [19]      :AndIf 0&lt;noOf←+/b1∨b2∨b3</code>
<code> [20]          buff←noOf↑buff</code>
<code> [21]          ns.markdown[(IsLeanPubEncodingLine⊃buff)↓⍳noOf]←⊂''            ⍝ Convert the [parm] definitions in the markdown to blank lines</code>
<code> [22]          bool←'[parm]:'∘{⍺≡(≢⍺)↑⍵}¨buff                                 ⍝ Otherwise we are not interested</code>
<code> [23]          :If ~ignoreEmbeddedParms</code>
<code> [24]              (⍸bool)ProcessEmbeddedParms_¨bool/buff                         ⍝ Process the rows one by one</code>
<code> [25]              :If ∨/bool←~ns.embeddedParms[;1]∊CreateHelpParms.∆List[;1]     ⍝ Report any invalid keys</code>
<code> [26]                  ns.report,←⊂'Invalid embbed parameter',((1&lt;+/bool)/'s'),': ',⊃{⍺,',',⍵}/'"',¨'"',⍨¨bool/ns.embeddedParms[;1]</code>
<code> [27]              :EndIf</code>
<code> [28]          :EndIf</code>
<code> [29]      :EndIf</code>
<code> [30]  :EndIf</code>
</div>
<code class="header" id="listing_171">#.MarkAPL.MarkAPL.ProcessFootnoteDefs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessFootnoteDefs ns</code>
<code> [1]   r←0</code>
<code> [2]   :If 0≠≢'^\[\^[A-Za-z0-9_⍙∆]*\]:'⎕S 0⊣⊃ns.markdown       ⍝ Find identifiers</code>
<code> [3]       noOf←ScanForPara ns</code>
<code> [4]       noOf←1⍳⍨'[^'∘≡¨2↑¨(noOf-1)↑1↓ns.markdown</code>
<code> [5]       b1←'  '∘≡¨2↑¨noOf↓ns.markdown</code>
<code> [6]       b2←noOf↓ns.emptyLines</code>
<code> [7]       ns.noOf←noOf+(+/∧\b1)⌊1⍳⍨1 1⍷b2</code>
<code> [8]       def←A.DLB{(⊂{'  ',A.DLB ⍵↓⍨⍵⍳':'}⊃⍵),1↓⍵}ns.noOf↑ns.markdown</code>
<code> [9]   :AndIf ':'=1↑{⍵↓⍨⍵⍳']'}⊃ns.markdown</code>
<code> [10]      id←{⍵↑⍨¯1+⍵⍳']'}2↓⊃ns.markdown</code>
<code> [11]  :AndIf ∧/~AllWhiteSpaceChars∊id</code>
<code> [12]  :AndIf 0≠≢def←(-+/∧\0=⌽≢¨def)↓def</code>
<code> [13]  :AndIf 0≠≢def←{1↓¨(' '=⊃¨⍵)⊂⍵}' ',def</code>
<code> [14]  :AndIf 0≠≢def←CompilePara¨def</code>
<code> [15]  :AndIf 0≠≢def←⊃¨ns ProcessInlineMarkUp¨def</code>
<code> [16]      ns.footnoteDefs⍪←id def</code>
<code> [17]      ns←Drop ns</code>
<code> [18]      r←1</code>
<code> [19]  :EndIf</code>
</div>
<code class="header" id="listing_172">#.MarkAPL.MarkAPL.ProcessFunctionCalls &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  (html isHtmlBlock)←ns ProcessFunctionCalls html</code>
<code> [1]   mask←~GetMaskForCodeTags html</code>
<code> [2]   isHtmlBlock←0</code>
<code> [3]   :If 0≠≢ind←'[^⍎]⍎⍎[^⍎]'⎕S 0⊣' ',(mask/html),' '  ⍝ Two blanks for the ≠ to fit start and end. The first one also fixes ⎕io</code>
<code> [4]   :AndIf 0≠≢ind←(2×⌊0.5×≢ind)↑ind</code>
<code> [5]       :Repeat</code>
<code> [6]           html←(⊃ind)⌽html</code>
<code> [7]           noOf←-/ind[2 1]</code>
<code> [8]           call←A.DLB A.DTB 1↓(noOf-1)↑1↓html</code>
<code> [9]           html←(2+noOf)↓html</code>
<code> [10]          result←ns ExecExternalFns call</code>
<code> [11]          :If 0≠≢result</code>
<code> [12]              isEmpty←0=≢¨result~¨' '</code>
<code> [13]              result←(0⌈¯1++/∧\isEmpty)↓(-0⌈¯1++/∧\⌽isEmpty)↓result ⍝ Allow max 1 leading/trailing blank line</code>
<code> [14]              flag←⊃ns.parms.syntaxSugar</code>
<code> [15]              isHtmlBlock←CheckForHtmlBlock(⊆result)(0=≢¨' '~¨⍨⊆result)ns.topOfDocument</code>
<code> [16]              :If 1=≡result</code>
<code> [17]                  :If flag∧~isHtmlBlock</code>
<code> [18]                      result←⊃ns ProcessInlineMarkUp result</code>
<code> [19]                  :EndIf</code>
<code> [20]              :Else</code>
<code> [21]                  'Embeded function returned invalid result'⎕SIGNAL 11/⍨(,1)≢∪≡¨,¨result</code>
<code> [22]                  :If flag∧~isHtmlBlock</code>
<code> [23]                      result←,⊆result</code>
<code> [24]                      result←,⊃¨ns ProcessInlineMarkUp¨A.DMB result</code>
<code> [25]                  :EndIf</code>
<code> [26]              :EndIf</code>
<code> [27]              'Called function returned an HTML block but does not stand on its own'⎕SIGNAL 11/⍨isHtmlBlock∧0≠≢html</code>
<code> [28]              :If 0=≢html</code>
<code> [29]                  html←(-ind[1])⌽result,html</code>
<code> [30]              :Else</code>
<code> [31]                  html←(-ind[1])⌽(⊃⍣(1&lt;≡html)⊣result),html</code>
<code> [32]              :EndIf</code>
<code> [33]          :EndIf</code>
<code> [34]      :Until 0=≢ind←2↓ind</code>
<code> [35]  :EndIf</code>
</div>
<code class="header" id="listing_173">#.MarkAPL.MarkAPL.ProcessHeaders &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ProcessHeaders←{</code>
<code> [1]      ns←⍵</code>
<code> [2]      '#'=1⍴⊃ns.leadingChars:ProcessATX_Header ns</code>
<code> [3]      ProcessSetextHeader ns</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_174">#.MarkAPL.MarkAPL.ProcessHorizontalRulers &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ProcessHorizontalRulers←{</code>
<code> [1]       ns←⍵</code>
<code> [2]       3&lt;+/∧\' '=⊃ns.markdown:0              ⍝ Zero to a maximum of three leading white space characters are allowed.</code>
<code> [3]       sa←GetSpecialAttributes⊃ns.markdown</code>
<code> [4]       line←A.DLB⊃ns.markdown</code>
<code> [5]       line←sa DropSpecialAttributes line</code>
<code> [6]       0=+/∧/¨(⊂line~⎕UCS 9 10 11 12 13 32 133 160)='*-_':0</code>
<code> [7]       3&gt;line+.=⊃line:0</code>
<code> [8]       0≠≢line~' ',⊃line:0</code>
<code> [9]       ns.html,←⊂'&lt;hr',sa,'&gt;'</code>
<code> [10]      ns←Drop ns</code>
<code> [11]      1</code>
<code> [12]  }</code>
</div>
<code class="header" id="listing_175">#.MarkAPL.MarkAPL.ProcessHtmlBlockType_CDATA &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessHtmlBlockType_CDATA ns</code>
<code> [1]  ⍝ &lt;![CDATA[ and ]]</code>
<code> [2]  ⍝ ← is 0 when found and processed, otherwise 1.</code>
<code> [3]   r←1</code>
<code> [4]   :If 2&lt;≢ns.markdown</code>
<code> [5]   :AndIf 0=≢⊃ns.markdown</code>
<code> [6]   :AndIf '&lt;![CDATA['{⍺≡(≢⍺)↑⍵}2⊃ns.leadingChars</code>
<code> [7]   :AndIf 0&lt;ns.noOf←DetectClosingTagBeforeEmptyLine ns.markdown']]&gt;'</code>
<code> [8]       ns.html,←']]&gt;'DropTailAfterClosingTag 1↓ns.noOf↑ns.markdown</code>
<code> [9]       ns←Drop ns</code>
<code> [10]      r←0</code>
<code> [11]  :EndIf</code>
</div>
<code class="header" id="listing_176">#.MarkAPL.MarkAPL.ProcessHtmlBlockType_Tags &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessHtmlBlockType_Tags ns</code>
<code> [1]  ⍝ Check for all HTML5 tags as well as self-defined tags.</code>
<code> [2]  ⍝ Note that self-defined tags must contain a hyphen by definition</code>
<code> [3]  ⍝ Note also that an HTML block MUST START with a &lt; in the first column, and will</code>
<code> [4]  ⍝ end at the first empty line to be found</code>
<code> [5]  ⍝ ← is 1 when found and processed, otherwise 0.</code>
<code> [6]   r←1</code>
<code> [7]   :If ns.topOfDocument∨∆LastLineWasEmpty∨⊃ns.emptyLines</code>
<code> [8]       :If 0&lt;ns.noOf←+/∧\ns.emptyLines           ⍝ Let's get rid...</code>
<code> [9]           ns←Drop ns                            ⍝ ...of any empty lines first.</code>
<code> [10]      :EndIf</code>
<code> [11]      ns.noOf←1</code>
<code> [12]      tag←'/'~⍨{⍵↑⍨¯1+⌊/⍵⍳'&gt; '}1↓⊃ns.markdownLC ⍝ Just the tag name, no matter whether closing or opening</code>
<code> [13]      :If (⊂tag)∊HtmlTags</code>
<code> [14]      :OrIf IsSelfDefinedHtmlTag tag</code>
<code> [15]          ns.noOf←(≢ns.markdown)⌊ns.emptyLines⍳1</code>
<code> [16]          ns.html,←ns.noOf↑ns.markdown</code>
<code> [17]          ns←Drop ns</code>
<code> [18]          ∆LastLineWasEmpty←1</code>
<code> [19]          r←0</code>
<code> [20]      :ElseIf '@'∊∊tag</code>
<code> [21]          r←1</code>
<code> [22]      :EndIf</code>
<code> [23]  :EndIf</code>
</div>
<code class="header" id="listing_177">#.MarkAPL.MarkAPL.ProcessHtmlBlock_HtmlComments &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessHtmlBlock_HtmlComments ns</code>
<code> [1]  ⍝ &lt;!-- and --&gt;</code>
<code> [2]  ⍝ ← is 0 when found and processed, otherwise 1.</code>
<code> [3]   r←1</code>
<code> [4]   :If 2&lt;≢ns.markdown</code>
<code> [5]   :AndIf 1∊(1↓ns.emptyLines),1</code>
<code> [6]   :AndIf '&lt;!--'{⍺≡(≢⍺)↑⍵}⊃1↓ns.markdown</code>
<code> [7]   :AndIf 0&lt;+/bool←(~∨/¨'--&gt;'∘⍷¨ns.markdown)</code>
<code> [8]       ns.noOf←1++/∧\bool</code>
<code> [9]       md←1↓ns.noOf↑ns.markdown</code>
<code> [10]      ns.html,←'--&gt;'DropTailAfterClosingTag md</code>
<code> [11]      ns←Drop ns</code>
<code> [12]      r←0</code>
<code> [13]  :EndIf</code>
</div>
<code class="header" id="listing_178">#.MarkAPL.MarkAPL.ProcessHtmlBlock_ScriptStylePre &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessHtmlBlock_ScriptStylePre ns</code>
<code> [1]  ⍝ &lt;script&gt;, &lt;style&gt; or &lt;pre&gt;.</code>
<code> [2]  ⍝ These are special because the first two can never be nested while the last one</code>
<code> [3]  ⍝ preserves white space by definition.</code>
<code> [4]  ⍝ ← is 0 when found and processed, otherwise 1.</code>
<code> [5]   r←0</code>
<code> [6]   :If '^&lt;script\b[^&gt;]*&gt;'DetectOpeningTag(⊃ns.emptyLines)↓ns.markdown</code>
<code> [7]       ns←Drop⍣(⊃ns.emptyLines)⊣ns</code>
<code> [8]       ns.noOf←DetectClosingTag ns.markdownLC'&lt;/script&gt;'</code>
<code> [9]       ns.html,←'&lt;/script&gt;'DropTailAfterClosingTag ns.noOf↑ns.markdown</code>
<code> [10]      ns←Drop ns</code>
<code> [11]  :ElseIf '^&lt;pre\b[^&gt;]*&gt;'DetectOpeningTag(⊃ns.emptyLines)↓ns.markdown</code>
<code> [12]      ns←Drop⍣(⊃ns.emptyLines)⊣ns</code>
<code> [13]      ns.noOf←DetectClosingTag ns.markdownLC'&lt;/pre&gt;'</code>
<code> [14]      ns.html,←Process_PRE ns.noOf↑ns.markdown</code>
<code> [15]      ns←Drop ns</code>
<code> [16]  :ElseIf '^&lt;style&gt;'DetectOpeningTag(⊃ns.emptyLines)↓ns.markdown</code>
<code> [17]      ns←Drop⍣(⊃ns.emptyLines)⊣ns</code>
<code> [18]      ns.noOf←DetectClosingTag ns.markdownLC'&lt;/style&gt;'</code>
<code> [19]      ns.html,←'&lt;/style&gt;'DropTailAfterClosingTag ns.noOf↑ns.markdown</code>
<code> [20]      ns←Drop ns</code>
<code> [21]  :Else</code>
<code> [22]      r←1</code>
<code> [23]  :EndIf</code>
</div>
<code class="header" id="listing_179">#.MarkAPL.MarkAPL.ProcessImageUrl &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ProcessImageUrl←{</code>
<code> [1]      base←⍵</code>
<code> [2]      0=≢base:⍺</code>
<code> [3]      url←⍺</code>
<code> [4]      base,(('/'≠¯1↑base)/'/'),url</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_180">#.MarkAPL.MarkAPL.ProcessImages &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ProcessImages←{</code>
<code> [1]       txt←⍵</code>
<code> [2]       mask←~GetMaskForCode txt</code>
<code> [3]       0=≢i1←¯1+⍸mask∧'!['⍷txt:txt</code>
<code> [4]       i1←⊃i1</code>
<code> [5]       '![CDATA['{⍺≡(≢⍺)↑⍵}i1↓txt:txt        ⍝ Invalid &lt;![CDATA[ section (probably missing empty lines)</code>
<code> [6]       txt←i1⌽txt</code>
<code> [7]       alt←2↓¯1↓{⍵↑⍨⍵⍳']'}txt</code>
<code> [8]       txt←{⍵↓⍨⍵⍳']'}txt</code>
<code> [9]       buff←1↓¯1↓txt↑⍨0⍳⍨(+\'('=txt)&gt;+\')'=txt</code>
<code> [10]      specialAttributes←GetSpecialAttributes'.*\(' '\).*'⎕R'' ''⍠('Greedy' 0)⊣buff</code>
<code> [11]      buff2←specialAttributes DropSpecialImageAttributes buff</code>
<code> [12]      title←{A.DLB ¯1↓A.DTB{⍵↑⍨⍵⍳'"'}⍵↓⍨⍵⍳'"'}buff2</code>
<code> [13]      url←{A.DLB A.DTB ⍵↑⍨¯1+⌊/⍵⍳'"{'}buff2</code>
<code> [14]      ((url='\')/url)←'/'</code>
<code> [15]      url←url ProcessImageUrl ns.parms.imageURL</code>
<code> [16]      insert←'&lt;img src="',url,'"'</code>
<code> [17]      insert,←specialAttributes</code>
<code> [18]      (('"'=alt)/alt)←''''</code>
<code> [19]      (title alt)←title{0=≢⍺:⊂⍵ ⋄ 0=≢⍵:⊂⍺ ⋄ ⍺ ⍵}alt</code>
<code> [20]      insert,←' alt="',alt,'"'</code>
<code> [21]      insert,←(0≠≢title)/' title="',title,'"'</code>
<code> [22]      insert,←'&gt;'</code>
<code> [23]      txt←(-i1)⌽insert,(2+≢buff)↓txt</code>
<code> [24]      ∇ txt</code>
<code> [25]  }</code>
</div>
<code class="header" id="listing_181">#.MarkAPL.MarkAPL.ProcessInlineMarkUp &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> (r isHtmlBlock)←ns ProcessInlineMarkUp tx</code>
<code> [1] ⍝ Note: sequence matters! Think thrice before changing, and run test cases immediately if you do anyway.</code>
<code> [2]  r←1 ProcessInlineMarkUp_ tx ns.parms</code>
<code> [3]  (r isHtmlBlock)←ns ProcessFunctionCalls r</code>
<code> [4] ⍝Done</code>
</div>
<code class="header" id="listing_182">#.MarkAPL.MarkAPL.ProcessInlineMarkUp_ &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←escapeFlag ProcessInlineMarkUp_(tx parms)</code>
<code> [1]  ⍝ Note: sequence matters! Think thrice before changing, and run test cases immediately if you do anyway.</code>
<code> [2]   r←tx</code>
<code> [3]   r←Process_BR r</code>
<code> [4]   r←ProcessAutomaticLinks r</code>
<code> [5]   r←ProcessSpecialHTML_Chars⍣escapeFlag⊣r</code>
<code> [6]   r←parms SmartStuff⍣(⊃parms.syntaxSugar)⊣r</code>
<code> [7]   r←ConvertEscapedAmpersand r</code>
<code> [8]   r←ProcessImages r</code>
<code> [9]   r←parms.bookmarkMayStartWithDigit ProcessLinks r</code>
<code> [10]  r←ProcessDoubleAsterisks r</code>
<code> [11]  r←ProcessAsterisks r</code>
<code> [12]  r←ProcessDoubleUnderscores r</code>
<code> [13]  r←1 ProcessUnderscores r</code>
<code> [14]  r←ProcessDoubleTildes r</code>
<code> [15]  r←MarkUpInlineCode r</code>
<code> [16]  r←RemoveEscapeChars r</code>
<code> [17]  r←InjectBR r</code>
<code> [18]  r←InjectPointyBrackets r</code>
<code> [19] ⍝Done</code>
</div>
<code class="header" id="listing_183">#.MarkAPL.MarkAPL.ProcessInlineMarkupInLinkText &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ProcessInlineMarkupInLinkText←{</code>
<code> [1]      r←ProcessDoubleAsterisks ⍵</code>
<code> [2]      r←ProcessAsterisks r</code>
<code> [3]      r←ProcessDoubleUnderscores r</code>
<code> [4]      r←0 ProcessUnderscores r</code>
<code> [5]      r←ProcessDoubleTildes r</code>
<code> [6]      ns.parms SmartStuff⍣(⊃ns.parms.syntaxSugar)⊣r</code>
<code> [7]  }</code>
</div>
<code class="header" id="listing_184">#.MarkAPL.MarkAPL.ProcessLeanPubCodeEmphasizing &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html←ProcessLeanPubCodeEmphasizing html</code>
<code> [1]  ⍝ Replaces `leanpub-start-insert` by an opening &lt;span&gt; and `leanpub-start-end` by a closing &lt;/span&gt;.</code>
<code> [2]  ⍝ Used to emphasize changes in the code with CSS.</code>
<code> [3]  ⍝ html←'leanpub-start-insert' 'leanpub-end-insert'⎕R'&lt;span class="leanpub_code"&gt;' '&lt;/span&gt;'⍠('Greedy' 0)('IC' 1)⊣html</code>
<code> [4]   patterns←'^\\leanpub-start-insert' '^\\leanpub-end-insert' '^leanpub-start-insert' '^leanpub-end-insert'</code>
<code> [5]   replaceBy←'leanpub-start-insert' 'leanpub-end-insert' '&lt;span class="leanpub_code"&gt;' '&lt;/span&gt;'</code>
<code> [6]   html←patterns ⎕R replaceBy⍠('Greedy' 0)('IC' 1)('Mode' 'L')⊣html</code>
<code> [7]   html←1↓∊(⎕UCS 13),¨html</code>
<code> [8]   hits←↑'&lt;span class="leanpub_code"&gt;' '&lt;/span&gt;'⎕S 0 1 3⍠('Greedy' 0)('IC' 1)('Mode' 'M')⊣html</code>
<code> [9]   :If 0≠≢hits</code>
<code> [10]           ⍝ Here we remove the CR between `leanpup-*-insert` and the following line</code>
<code> [11]      bool←(≢html)⍴1</code>
<code> [12]      bool[1++/hits[;1 2]]←0</code>
<code> [13]      bool←(~bool)⍲(~bool)\(⎕UCS 13)=(~bool)/html  ⍝ Only when it's a CR: the last one does not have one!</code>
<code> [14]      html←bool/html</code>
<code> [15]  :EndIf</code>
<code> [16]  html←(⎕UCS 13)A.Split html</code>
<code> [17] ⍝Done</code>
</div>
<code class="header" id="listing_185">#.MarkAPL.MarkAPL.ProcessLeanPubExtensions &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←parms ProcessLeanPubExtensions ns</code>
<code> [1]  ⍝ Replaces `A&gt; ` and alikes against a &lt;div&gt; that is used to give it an outlook similar to what LeanPub is doing.</code>
<code> [2]  ⍝ When this functions runs we have not yet established all embedded parameters from the Markdown, and we can't</code>
<code> [3]  ⍝ at this stage - too early. But we cannot process the LeanPub extensions later either, so we have to look up for</code>
<code> [4]  ⍝ any embedded parameter `leanpubExtensions` ourself.</code>
<code> [5]   :If 0=flag←parms.leanpubExtensions</code>
<code> [6]       :If 0=parms.ignoreEmbeddedParms</code>
<code> [7]           flag←(,1)≡,'leanpubExtensions'LookForEmbeddedParm RemoveLeanpubEncoding ns.markdown</code>
<code> [8]       :EndIf</code>
<code> [9]   :EndIf</code>
<code> [10]  :If flag</code>
<code> [11]      ns←parms ProcessLeanPubExtensions_ ns</code>
<code> [12]  :EndIf</code>
</div>
<code class="header" id="listing_186">#.MarkAPL.MarkAPL.ProcessLeanPubExtensions_ &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←parms ProcessLeanPubExtensions_ ns</code>
<code> [1]   leanPubExtensions←'AWTEIQDX'</code>
<code> [2]   :For extension :In leanPubExtensions</code>
<code> [3]       isNotCodeBlock←~WhereAreCodeBlocks ns.markdown</code>
<code> [4]       :If 0&lt;+/bool←isNotCodeBlock\(3↑¨isNotCodeBlock/ns.markdown)≡¨⊂extension,'&gt; '</code>
<code> [5]       :AndIf 0≠≢start←⍸0 1⍷bool</code>
<code> [6]           lengths←,+/¨bool{⎕ML←3 ⋄ ⍺⊂⍵}bool</code>
<code> [7]           :For i :In ⍳≢start</code>
<code> [8]               ind←i⊃start</code>
<code> [9]               :If 0=≢ind⊃ns.markdown            ⍝ The line before must be empty</code>
<code> [10]                  noOf←i⊃lengths</code>
<code> [11]                  after←1+ind+noOf</code>
<code> [12]                  :If 0=≢after⊃ns.markdown      ⍝ The line after must be empty</code>
<code> [13]                      openDiv←⊂'&lt;div class="leanpub',((extension≡'A')/'_A'),'"&gt;'</code>
<code> [14]                      body←3↓¨ns.markdown[ind+⍳lengths[i]]</code>
<code> [15]                      (html report)←ConvertMarkdown2HTML body</code>
<code> [16]                      :If extension≠'A'</code>
<code> [17]                          img←'&lt;img src="',(parms LeanPubImageFor extension),'" alt="',(LeanPubAltTextFor extension),'"&gt;'</code>
<code> [18]                          html←img'&lt;div&gt;',html,⊂'&lt;/div&gt;'</code>
<code> [19]                      :EndIf</code>
<code> [20]                      html←{0=+/b←0=≢¨⍵:⍵ ⋄ w←⍵ ⋄ (b/w)←⊂'&amp;nbsp;' ⋄ w}html  ⍝ Important: only this way "html" is later recognized as a single HTML block.</code>
<code> [21]                      html←openDiv,html,⊂'&lt;/div&gt;'</code>
<code> [22]                      ns.markdown←(ind↑ns.markdown),html,(ind+noOf)↓ns.markdown</code>
<code> [23]                      ns.lineNumbers←(ind↑ns.lineNumbers),((≢html)⍴⊂(1+ind),ind+noOf),(ind+noOf)↓ns.lineNumbers</code>
<code> [24]                      :If 0≠≢report</code>
<code> [25]                          :For this :In report</code>
<code> [26]                              :If ∨/'(line'⍷this</code>
<code> [27]                                  ns.report,←((ind+1)⊃ns.lineNumbers)∘{i←-(⌽⍵)⍳' ' ⋄ (i↓⍵),' ',({1=≢⍵:⍕⍵ ⋄ ⊃{⍺,'-',⍵}/⍕¨⍵}⍺),')'}¨report</code>
<code> [28]                              :Else</code>
<code> [29]                                  ns.report,←((ind+1)⊃ns.lineNumbers)∘{i←-(⌽⍵)⍳' ' ⋄ ⍵,' (lines ',({1=≢⍵:⍕⍵ ⋄ ⊃{⍺,'-',⍵}/⍕¨⍵}⍺),')'}¨report</code>
<code> [30]                              :EndIf</code>
<code> [31]                          :EndFor</code>
<code> [32]                      :EndIf</code>
<code> [33]                      (i↓start)←(i↓start)+(≢html)-noOf</code>
<code> [34]                  :EndIf</code>
<code> [35]              :EndIf</code>
<code> [36]          :EndFor</code>
<code> [37]      :EndIf</code>
<code> [38]  :EndFor</code>
</div>
<code class="header" id="listing_187">#.MarkAPL.MarkAPL.ProcessLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ProcessLinks←{</code>
<code> [1]       ⍺←1</code>
<code> [2]       bookmarkMayStartWithDigit←⍺</code>
<code> [3]       txt←⍵</code>
<code> [4]       mask←~GetMaskForCode txt</code>
<code> [5]       ⍬≡on←mask IsolateLink txt:txt</code>
<code> [6]       txt←on⌽txt</code>
<code> [7]       mask←on⌽mask</code>
<code> [8]       closeBracket←(']('⍷(mask\mask/txt))⍳1</code>
<code> [9]       mask←(closeBracket⍴1),{(+\⍵='(')-+\⍵=')'}closeBracket↓txt  ⍝ Careful: a caption might contain ")" when just ⍳')' would not suffice</code>
<code> [10]      off←1++/∧\1=(∧\0=mask)∨mask&gt;0</code>
<code> [11]      linkDef←off↑txt</code>
<code> [12]      linkDef←A.DMB ReplaceQTC_byBlank linkDef</code>
<code> [13]      mask←~GetMaskForCode linkDef</code>
<code> [14]      linkDef←ReplaceDoubleSmartQuotes linkDef mask</code>
<code> [15]      sa←GetSpecialAttributes⌽{'{'∊⍵:{⍵↑⍨⍵⍳'{'}{⍵↓⍨¯1+⍵⍳'}'}⍵ ⋄ ''}⌽mask/linkDef   ⍝ Because special attributes for a link follow straight after the link</code>
<code> [16]      txt←off↓txt</code>
<code> [17]      mask←⌽~GetMaskForCode linkDef</code>
<code> [18]      linkDef←⌽mask{'{'∊⍺/⍵:')',(⍵↓⍨(⍺\⍺/⍵)⍳'{') ⋄ ⍵}⌽linkDef                ⍝ Drop the special attribute but leave any code alone</code>
<code> [19]      (url title)←GetUrlAndTitleFromLink linkDef</code>
<code> [20]      poundFlag←⊃'#'=1⍴url</code>
<code> [21]      mask←~GetMaskForCode linkDef</code>
<code> [22]      linkText←1↓A.DTB mask{⍵↑⍨¯1+1⍳⍨⍺\']('⍷⍺/⍵}linkDef</code>
<code> [23]      url←linkText(bookmarkMayStartWithDigit∘CompileBookMarkName{(1&lt;≢⍵)∧'#'=1↑⍵:'#',⍺⍺ ⍵'' ⋄ (,'#')≡,⍵:'#',⍺⍺ ⍺'' ⋄ ⍵})url</code>
<code> [24]      linkText{0=≢⍵:⍺ ⋄ ⍵}←(1+poundFlag)⊃linkText title</code>
<code> [25]      linkText←ProcessInlineMarkupInLinkText linkText</code>
<code> [26]      linkText{0=≢⍺~' ':⍵ ⋄ ⍺}←poundFlag↓url</code>
<code> [27]      tag←'a href="',({'#'=1⍴⍵:LowercaseID ⍵ ⋄ ⍵}url),'"'  ⍝ Make internal (bookmark) links lowercase unless supressed</code>
<code> [28]      tag,←(~poundFlag)/' class="',((1+'mailto'{⍺≡(≢⍺)↑⍵}url)⊃'external_link' 'mailto_link'),'"'</code>
<code> [29]      tag,←AddBookmarkClassName⍣poundFlag⊣sa</code>
<code> [30]      tag,←((~poundFlag)∧0≠≢title)/' title="',title,'"'</code>
<code> [31]      insert←tag Tag linkText</code>
<code> [32]      txt←(-on)⌽insert,txt</code>
<code> [33]      ∇ txt</code>
<code> [34]  }</code>
</div>
<code class="header" id="listing_188">#.MarkAPL.MarkAPL.ProcessLists &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←ProcessLists ns</code>
<code> [1]  r←0</code>
<code> [2]  :If 0=ns.parms.markdownStrict</code>
<code> [3]  :OrIf ∆LastLineWasEmpty</code>
<code> [4]      :If 3 IsHtmlList⊃ns.markdown</code>
<code> [5]          r←ProcessList ns</code>
<code> [6]      :EndIf</code>
<code> [7]  :EndIf</code>
<code> [8] ⍝Done</code>
</div>
<code class="header" id="listing_189">#.MarkAPL.MarkAPL.ProcessParagraph &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←∆LastLineWasEmpty ProcessParagraph ns</code>
<code> [1]   r←⍬</code>
<code> [2]   ns.noOf←ScanForPara ns</code>
<code> [3]   ns.noOf←1⌈ns.noOf</code>
<code> [4]   para←CompilePara ns.noOf↑ns.markdown</code>
<code> [5]   :If '&lt;'=1⍴para</code>
<code> [6]   :AndIf {{0=+/'://'⍷⍵}⍵↑⍨⍵⍳'&gt;'}para ⍝ Not a auto-link?</code>
<code> [7]       pattern←{('&lt;[a-zA-Z',(⍵/'0-9'),'][0-9a-zA-Z]*&gt;')('&lt;/[a-zA-Z',(⍵/'0-9'),'][0-9a-zA-Z]*&gt;')}ns.parms.bookmarkMayStartWithDigit</code>
<code> [8]   :AndIf 0&lt;≢pattern ⎕S 0⊣para</code>
<code> [9]       ns.html,←⊂(para⍳'&gt;')↑para</code>
<code> [10]      para←(para⍳'&gt;')↓para</code>
<code> [11]      para←(' '=⊃para)↓para</code>
<code> [12]      :If 0&lt;≢para</code>
<code> [13]          ns ProcessParagraph_ para</code>
<code> [14]      :EndIf</code>
<code> [15]  :Else</code>
<code> [16]      ns ProcessParagraph_ para</code>
<code> [17]  :EndIf</code>
<code> [18]  ns←Drop ns</code>
</div>
<code class="header" id="listing_190">#.MarkAPL.MarkAPL.ProcessReferenceLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessReferenceLinks ns</code>
<code> [1]   r←0</code>
<code> [2]   :If '['=⊃⊃ns.leadingChars</code>
<code> [3]   :AndIf 0≠≢'\[[A-Za-z0-9_-]*\]:'⎕S 0⊣⊃ns.markdown      ⍝ Find identifiers</code>
<code> [4]       id←{1↓⍵↑⍨¯2+⍵⍳':'}⊃ns.markdown</code>
<code> [5]       url←A.DLB A.DTB{⍵↓⍨⍵⍳':'}⊃ns.markdown</code>
<code> [6]   :AndIf {~'='∊⍵↑⍨⌊/⍵⍳'?{'}url   ⍝ `?` parts URL parameter, `{` parts special attributes. Both may carry `=`!</code>
<code> [7]       sa←GetSpecialAttributes url</code>
<code> [8]       url←A.DTB sa DropSpecialAttributes url</code>
<code> [9]       :If 2=+/'"'=url</code>
<code> [10]          alt←{¯1↓⍵↓⍨⍵⍳'"'}url</code>
<code> [11]          url←A.DTB{⍵↑⍨¯1+⍵⍳'"'}url</code>
<code> [12]      :Else</code>
<code> [13]          alt←''</code>
<code> [14]      :EndIf</code>
<code> [15]      ns.linkRefs,←⊂id url alt sa</code>
<code> [16]      ns←Drop ns</code>
<code> [17]      r←1</code>
<code> [18]  :EndIf</code>
</div>
<code class="header" id="listing_191">#.MarkAPL.MarkAPL.ProcessSetextHeader &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  flag←ProcessSetextHeader ns</code>
<code> [1]   flag←0</code>
<code> [2]   noOf←ScanForPara ns                           ⍝ Because only what qualifies as paragraph can be an ATX header</code>
<code> [3]   :If noOf≠0</code>
<code> [4]   :AndIf noOf&lt;≢ns.markdown</code>
<code> [5]   :AndIf 0&lt;≢∊(1+noOf)⌷ns.withoutBlanks          ⍝ Must not be empty of course</code>
<code> [6]       ind←noOf+⍸∊'-='IotaSetextHeader¨⊂(1+noOf)⌷¨ns.(withoutBlanks markdown emptyLines)</code>
<code> [7]   :AndIf 0≠≢ind                             ⍝ It's not a Setext header</code>
<code> [8]       ind←⊃ind</code>
<code> [9]       sa←GetSpecialAttributes(ind-1)⊃ns.markdown</code>
<code> [10]      l←1+'-'=⊃ind⊃ns.leadingChars</code>
<code> [11]      c←CompilePara noOf↑ns.markdown</code>
<code> [12]      c←sa DropSpecialAttributes c</code>
<code> [13]      ns.noOf←1+noOf</code>
<code> [14]      c2←⊃ns ProcessInlineMarkUp c</code>
<code> [15]      c←ns CheckOddNumberOfDoubleQuotes c'header'</code>
<code> [16]      bookmarkName←ns GetBookMarkNameFromCaption c2((l≤ns.parms.bookmarkLink)/sa)</code>
<code> [17]      bookmarkName_←LowercaseID bookmarkName</code>
<code> [18]      anchor←AddBookmarkLink l ns bookmarkName_</code>
<code> [19]      ns.html,←ns.parms.div_h_tag/⊂'&lt;div class="h_tag"&gt;'</code>
<code> [20]      ns.html,←{⊂⍣(0≠≢⍵)⊣⍵}anchor</code>
<code> [21]      ns.html,←⊂A.DMB'&lt;h',(⍕l),({0=≢⍵:⍵ ⋄ ' data-id="',⍵,'"'}bookmarkName),({0=≢⍵:⍵ ⋄ ' ',⍵}RemoveIdFromSpecialAttributes⍣(0≠≢anchor)⊣sa),'&gt;',c2,'&lt;/h',(⍕l),'&gt;'</code>
<code> [22]      ns.html,←(0&lt;≢anchor)/⊂'&lt;/a&gt;'</code>
<code> [23]      ns.html,←ns.parms.div_h_tag/⊂'&lt;/div&gt;'</code>
<code> [24]      ns.headers⍪←l bookmarkName_ c2''</code>
<code> [25]      ns.headerLineNos,←⊃ns.lineNumbers</code>
<code> [26]      ns←Drop ns</code>
<code> [27]      flag←1</code>
<code> [28]  :EndIf</code>
<code> [29] ⍝Done</code>
</div>
<code class="header" id="listing_192">#.MarkAPL.MarkAPL.ProcessSpecialHTML_Chars &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ProcessSpecialHTML_Chars←{</code>
<code> [1]      tx←⍵</code>
<code> [2]      0=+/tx∊'&amp;&lt;&gt;':tx</code>
<code> [3]      EscapeSpecialChars tx</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_193">#.MarkAPL.MarkAPL.ProcessSubTOC &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessSubTOC ns</code>
<code> [1]   r←0</code>
<code> [2]   :If 0&lt;≢subToc←GetRegExPatternForSubToc ⎕S{⍵.Match}⍠('Greedy' 0)('IC' 1)⊣⊃ns.markdown</code>
<code> [3]       :If (,0)≢,ns.parms.toc</code>
<code> [4]       :AndIf ns.parms.subTocs</code>
<code> [5]           subToc←⊃subToc</code>
<code> [6]           :If 0&lt;≢ns.html</code>
<code> [7]           :AndIf 0&lt;≢nextHeader←{⍵⊃⍨1⍳⍨'&lt;h'∘≡¨(≢'&lt;h')↑¨⍵}⌽ns.html</code>
<code> [8]               header←{⍵↑⍨¯1+⍵⍳'&lt;'}{⍵↓⍨⍵⍳'&gt;'}nextHeader</code>
<code> [9]               level←{⊃(//)⎕VFI ⍵↑⍨¯1+⌊/⍵⍳' &gt;'}2↓nextHeader</code>
<code> [10]              specialAttrs←GetSpecialAttributes(∧/'{}'∊subToc)/{⍵↑⍨⍵⍳'}'}{⍵↓⍨¯1+⍵⍳'{'}subToc</code>
<code> [11]              depth←0</code>
<code> [12]              :If '-'∊subToc</code>
<code> [13]                  depth←⊃(//)⎕VFI{⊃⍵↓⍨⍵⍳'-'}subToc</code>
<code> [14]              :EndIf</code>
<code> [15]              ns.subToc,←⊂level header depth specialAttrs</code>
<code> [16]              ns.html,←⎕C 1↑ns.markdown</code>
<code> [17]          :EndIf</code>
<code> [18]      :EndIf</code>
<code> [19]      ns←Drop ns</code>
<code> [20]      r←1</code>
<code> [21]  :EndIf</code>
</div>
<code class="header" id="listing_194">#.MarkAPL.MarkAPL.ProcessTable &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←ProcessTable ns</code>
<code> [1]   r←0</code>
<code> [2]   :If IsTableRow⊃ns.markdown</code>
<code> [3]       max←+/∧\∨/'|'=↑ns.withoutBlanks</code>
<code> [4]       ns.noOf←+/∧\IsTableRow¨max↑ns.markdown</code>
<code> [5]       :If 1&lt;ns.noOf</code>
<code> [6]       :AndIf ∨/{∧/'-'='|: '~⍨⍵}¨{⍵↑⍨¯1+⍵⍳'{'}¨2↑ns.markdown</code>
<code> [7]           r←ProcessTable_ ns</code>
<code> [8]       :Else</code>
<code> [9]           r←ProcessTableWithoutColTitles ns</code>
<code> [10]      :EndIf</code>
<code> [11]  :EndIf</code>
<code> [12] ⍝Done</code>
</div>
<code class="header" id="listing_195">#.MarkAPL.MarkAPL.ProcessUnderscores &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  txt←{ignoreURLs}ProcessUnderscores txt_</code>
<code> [1]  ⍝ Takes a string and marks up everything between _ and _ as &lt;strong&gt;</code>
<code> [2]  ⍝ except when it occurs ...</code>
<code> [3]  ⍝ * within a word</code>
<code> [4]  ⍝ * within APL code</code>
<code> [5]  ⍝ * as part of a function call</code>
<code> [6]  ⍝ * between &amp;amp;pointybracket_open; and &amp;amp;pointybracket_close;</code>
<code> [7]  ⍝ * within the URL</code>
<code> [8]   ignoreURLs←{0&lt;⎕NC ⍵:⍎⍵ ⋄ 0}'ignoreURLs'</code>
<code> [9]   txt2←txt←'  ',txt_,'  '</code>
<code> [10]  txt2←'\\_' '__'⎕R'⌹⌹' 'aa'⍠('Mode' 'D')⊣txt2</code>
<code> [11]  :If 0&lt;+/bool←'_'=txt2</code>
<code> [12]  :AndIf 1&lt;+/bool</code>
<code> [13]  :AndIf 0&lt;+/bool∧bool\~∧/⍉txt2[¯1 1∘.+⍸bool]∊AllWhiteSpaceChars</code>
<code> [14]      bool∧←~GetMaskForCode txt</code>
<code> [15]      :If ignoreURLs</code>
<code> [16]      :AndIf 0≠≢buff←'&lt;a .*&gt;*.&lt;/a&gt;'⎕S 0 1⍠('Greedy' 0)⊣(~bool){⍺\⍺/⍵}txt</code>
<code> [17]          bool[{⊃,/{⍵[1]+⍳⍵[2]}¨⍵}buff]←0</code>
<code> [18]      :EndIf</code>
<code> [19]      bool∧←~MaskTagAttrs txt</code>
<code> [20]      bool∧←~MaskFunctionCall txt</code>
<code> [21]  :AndIf 0≠≢ind←⍸bool</code>
<code> [22]  :AndIf 0≠≢ind←(txt 1∘NotWithinWord¨ind)/ind</code>
<code> [23]      ind←{⍵↑⍨(≢⍵)-2|≢⍵}ind</code>
<code> [24]      start←((≢ind)⍴1 0)/ind</code>
<code> [25]      end←((≢ind)⍴0 1)/ind</code>
<code> [26]      txt[start]←⊂'&lt;em&gt;'</code>
<code> [27]      txt[end]←⊂'&lt;/em&gt;'</code>
<code> [28]      txt←⊃,/txt</code>
<code> [29]  :EndIf</code>
<code> [30]  txt←2↓¯2↓txt</code>
<code> [31] ⍝Done</code>
</div>
<code class="header" id="listing_196">#.MarkAPL.MarkAPL.Process_BR &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Process_BR←{</code>
<code> [1] ⍝ The extended syntax of MarkAPL allows `&lt;&lt;br&gt;&gt;` in the code which will be</code>
<code> [2] ⍝ converted to &lt;br&gt; in two stages: here we replace this by a ⎕UCS 13 (CR).</code>
<code> [3]      txt←⍵</code>
<code> [4]      '`.*&lt;&lt;br&gt;&gt;.*`' '&lt;&lt;br&gt;&gt;'⎕R'\0' '\r'⍠('IC' 1)⊣txt</code>
<code> [5]  }</code>
</div>
<code class="header" id="listing_197">#.MarkAPL.MarkAPL.Process_PRE &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  md←Process_PRE md</code>
<code> [1]   md←,md</code>
<code> [2]   :If 1=≢md</code>
<code> [3]       :If 0=≢'&lt;code\b[^&gt;]*&gt;'⎕S 0⊣⊃md   ⍝ &lt;code&gt; missing?!</code>
<code> [4]           (⊃md)←'(&lt;pre\b[^&gt;]*&gt;)'⎕R'\1&lt;code&gt;'⊣⊃md</code>
<code> [5]       :EndIf</code>
<code> [6]       :If 0=≢'&lt;/code&gt;'⎕S 0⊣⊃md   ⍝ &lt;/code&gt; missing?!</code>
<code> [7]           ((≢md)⊃md)←'(&lt;/pre&gt;)'⎕R'&lt;/code&gt;\1'⊣(≢md)⊃md</code>
<code> [8]       :EndIf</code>
<code> [9]   :Else</code>
<code> [10]      (first last)←md[1,≢md]</code>
<code> [11]      :If 0=≢'&lt;code\b[^&gt;]*&gt;'⎕S 0⊣first</code>
<code> [12]      :AndIf 0=≢'&lt;code\b[^&gt;]*&gt;'⎕S 0⊣⊃1↓md</code>
<code> [13]          first,←'&lt;code&gt;'</code>
<code> [14]      :EndIf</code>
<code> [15]      :If 0=+/'&lt;/code'⍷last</code>
<code> [16]      :AndIf '&lt;/code'{⍺≢(≢⍺)↑⍵}⊃¯2↑md</code>
<code> [17]          :If 0=≢{⍵↓⍨⍵⍳'&gt;'}last</code>
<code> [18]              last,⍨←'&lt;/code&gt;'</code>
<code> [19]          :Else</code>
<code> [20]              last←'&lt;/code&gt;',last</code>
<code> [21]          :EndIf</code>
<code> [22]      :EndIf</code>
<code> [23]      md[1]←⊂first</code>
<code> [24]      md[≢md]←⊂last</code>
<code> [25]      :If 0=≢'&lt;code&gt;'{⍵↓⍨(¯1+≢⍺)+1⍳⍨⍺⍷⍵}1⊃md        ⍝ Do &lt;pre&gt; and &lt;code&gt; stand on their own?</code>
<code> [26]          md←(,/2↑md),2↓md                          ⍝ Then connect the HTML with the first line of code</code>
<code> [27]      :EndIf</code>
<code> [28]      :If ≢'^&lt;/code&gt;&lt;/pre&gt;$'⎕S 0⊣{⍵↓⍨-+/∧\' '=⌽⍵}{⍵/⍨~∨\⍵='⍝'}(≢md)⊃md  ⍝ Do &lt;/pre&gt; and &lt;/code&gt; stand on their own? (Comments are ignored)</code>
<code> [29]          md←(¯2↓md),,/¯2↑md                        ⍝ Then connect the HTML with the last line of code</code>
<code> [30]      :EndIf</code>
<code> [31]  :EndIf</code>
<code> [32]  md←'&lt;/pre&gt;'DropTailAfterClosingTag md</code>
</div>
<code class="header" id="listing_198">#.MarkAPL.MarkAPL.RemoveAllComments &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  RemoveAllComments←{</code>
<code> [1]       ns←⍵</code>
<code> [2]       markdown←ns.markdown</code>
<code> [3]       markdown←1↓∊(⎕UCS 10),¨markdown</code>
<code> [4]       ind←1+'^\s{0,3}[~`]{3,}\s{0,}({.*?})?\s{0,}$'⎕S 0⍠('Mode' 'M')('DotAll' 1)('EOL' 'LF')⊣markdown</code>
<code> [5]       ind,←1+'&lt;pre\b' '&lt;/pre&gt;'⎕S 0⍠('Mode' 'M')('DotAll' 1)⊣markdown</code>
<code> [6]       ind←ind[⍋ind]</code>
<code> [7]       b←(≢markdown)⍴0</code>
<code> [8]       b[ind]←1</code>
<code> [9]       b←Between b</code>
<code> [10]      b∧←markdown≠⎕UCS 10</code>
<code> [11]      markdown[⍸b]←' '</code>
<code> [12]      b2←'⍝'≠⊃¨(⎕UCS 10)A.Split markdown</code>
<code> [13]      ns.markdown←b2/ns.markdown</code>
<code> [14]      ns.lineNumbers←(+\~b2/b2)+b2/ns.lineNumbers</code>
<code> [15]      ns</code>
<code> [16]  }</code>
</div>
<code class="header" id="listing_199">#.MarkAPL.MarkAPL.RemoveDoubleSlashes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> RemoveDoubleSlashes←{'//'{⍵/⍨~⍺⍷⍵}'\\'{⍵/⍨~⍺⍷⍵}⍵}</code>
</div>
<code class="header" id="listing_200">#.MarkAPL.MarkAPL.RemoveEscapeChars &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  r←RemoveEscapeChars tx</code>
<code> [1]  ⍝ Remove the "\" (Escape character) from ⍵ except when ...</code>
<code> [2]  ⍝ * they are part of code (survives untouched)</code>
<code> [3]  ⍝ * there are two of them in succession (one survives)</code>
<code> [4]  ⍝ * it appears within an attribute definition like &lt;a title="\3"&gt;</code>
<code> [5]  ⍝ * any character to the right of the `\` is not one of `_*|~{}(&amp;&lt;&gt;`</code>
<code> [6]  ⍝ This does not work on, say, "\\\\\\\\\\\\\\\; that why this is not legal.</code>
<code> [7]   mask←~GetMaskForCodeTags tx</code>
<code> [8]   mask←mask\{~Between ⍵∊'&lt;&gt;'}mask/tx</code>
<code> [9]   b←'\'=(mask/tx),' '</code>
<code> [10]     ⍝ We try to be smart: those are to be escaped anyway, so nothing else is touched</code>
<code> [11]  specialChars←'_*|~`{}(&amp;\'</code>
<code> [12]  b∧←b\((mask/tx),' ')[1+⍸b]∊specialChars</code>
<code> [13]  b←¯1↓b∧b\'\'≠((mask/tx),' ')[1+⍸b]</code>
<code> [14]  r←((~mask)∨mask\~b)/tx</code>
<code> [15]  mask←~GetMaskForCodeTags r</code>
<code> [16]  b←~mask\'\\'⍷mask/r</code>
<code> [17]  r←b/r</code>
<code> [18] ⍝Done</code>
</div>
<code class="header" id="listing_201">#.MarkAPL.MarkAPL.RemoveHTML &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> RemoveHTML←{</code>
<code> [1] ⍝ 'This contains a tag'←∇ 'This contains a &lt;span&gt;tag'&lt;/span&gt;</code>
<code> [2]      txt←⍵</code>
<code> [3]      '&lt;&gt;'{⍵/⍨~Between ⍵∊⍺}txt</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_202">#.MarkAPL.MarkAPL.RemoveIdFromSpecialAttributes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> RemoveIdFromSpecialAttributes←{</code>
<code> [1] ⍝ 'class="qwe" style="color:red;"' ←→ RemoveIdFromSpecialAttributes 'class="qwe" id="foo" style="color:red;"'</code>
<code> [2]      '\sid="[^"]*."'⎕R''⊣⍵</code>
<code> [3]  }</code>
</div>
<code class="header" id="listing_203">#.MarkAPL.MarkAPL.RemoveLampLines &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←RemoveLampLines ns</code>
<code> [1]  r←0</code>
<code> [2]  :If '⍝'=⊃⊃ns.markdown</code>
<code> [3]      ns←Drop ns</code>
<code> [4]      r←1</code>
<code> [5]  :EndIf</code>
</div>
<code class="header" id="listing_204">#.MarkAPL.MarkAPL.ReplaceDoubleSmartQuotes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ReplaceDoubleSmartQuotes←{</code>
<code> [1] ⍝ In case ⍵ carries special attributes at this point ordinary double quotes(") will be replaced</code>
<code> [2] ⍝ by smart one like (“” and „“). We need to being them back</code>
<code> [3]      (txt mask)←⍵</code>
<code> [4]      txt2←mask\mask/txt</code>
<code> [5]      0=+/b←txt2∊'“”„“':txt</code>
<code> [6]      (b/txt)←'"'</code>
<code> [7]      txt</code>
<code> [8]  }</code>
</div>
<code class="header" id="listing_205">#.MarkAPL.MarkAPL.ReplaceFootnoteReferences &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←ReplaceFootnoteReferences(ns hits)</code>
<code> [1]  ⍝ Replaces the original footnote references (which have arbitrary names)</code>
<code> [2]  ⍝ against ones which are strictly numbered from 1 to whatever.</code>
<code> [3]   :For i :In ⍳≢hits</code>
<code> [4]       (id row ind)←hits[i;1 3 4]</code>
<code> [5]       newID←'&lt;a href="#fnref',(⍕id),'" class="footnote_link"&gt;&lt;sup&gt;',(⍕id),'&lt;/sup&gt;&lt;/a&gt;]'</code>
<code> [6]       (row⊃ns.html)←(-ind)⌽newID,{⍵↓⍨⍵⍳']'}ind⌽row⊃ns.html</code>
<code> [7]   :EndFor</code>
<code> [8]   :For this :In (~ns.footnoteDefs[;1]∊hits[;2])⌿ns.footnoteDefs[;1]</code>
<code> [9]       ns.report,←⊂'Warning: footnote "',this,'" not referenced anywhere'</code>
<code> [10]  :EndFor</code>
</div>
<code class="header" id="listing_206">#.MarkAPL.MarkAPL.ReplaceLinkID &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  {r}←ns ReplaceLinkID(linkText id searchFor)</code>
<code> [1]   r←⍬</code>
<code> [2]   ind←(⊃¨ns.linkRefs)⍳⊂id</code>
<code> [3]   :If ind≤≢ns.linkRefs</code>
<code> [4]       (url title sa)←1↓ind⊃ns.linkRefs</code>
<code> [5]       :If 0=≢title</code>
<code> [6]           :If 0=≢linkText</code>
<code> [7]               linkText←((ind,3)⊃ns.linkRefs)←url</code>
<code> [8]           :Else</code>
<code> [9]               ((ind,3)⊃ns.linkRefs)←linkText</code>
<code> [10]          :EndIf</code>
<code> [11]      :EndIf</code>
<code> [12]      :If 0=≢linkText</code>
<code> [13]          linkText←title</code>
<code> [14]      :EndIf</code>
<code> [15]      new←'&lt;a href="',url,'" class="external_link"',((0≠≢title)/' title="',title,'"'),sa,'&gt;',linkText,'&lt;/a&gt;'</code>
<code> [16]      ns.html←'&lt;code&gt;.*?&lt;/code&gt;'(MakeLiteralForRegex searchFor)⎕R'\0'new⍠('Mode' 'D')('DotAll' 1)⊣ns.html</code>
<code> [17]  :EndIf</code>
</div>
<code class="header" id="listing_207">#.MarkAPL.MarkAPL.ReplaceLinkIDs &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ns←ReplaceLinkIDs ns</code>
<code> [1] ⍝ Replace the [{any link text}][link id] references in the HTML against the real thing: &lt;a href="...</code>
<code> [2]  :If 0≠≢ns.linkRefs</code>
<code> [3]  :AndIf 0&lt;+/mask←∨/¨~GetMaskForCodeTags¨ns.html</code>
<code> [4]  :AndIf 0≠≢∊linkRefs←GetAllLinkRefs mask/ns.html</code>
<code> [5]      ns ReplaceLinkID¨linkRefs</code>
<code> [6]  :EndIf</code>
</div>
<code class="header" id="listing_208">#.MarkAPL.MarkAPL.ReportLinks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ReportLinks←{</code>
<code> [1]  ⍝ Injects a list with all external references together with a remark.</code>
<code> [2]  ⍝ The resulting table is assigned the class "print_only" for obvious reasons.</code>
<code> [3]       ns←⍵</code>
<code> [4]       1≠ns.parms.reportLinks:ns</code>
<code> [5]       html←FlattenHTML ns.html</code>
<code> [6]       hits←'&lt;a[^&gt;]+class="external_link".*&lt;/a&gt;'⎕S 0 1⍠('Greedy' 0)('Mode' 'D')⊣html</code>
<code> [7]       0=≢hits:ns</code>
<code> [8]       anchors←(-≢'&lt;/a&gt;')↓¨hits{⍺[2]↑⍺[1]⌽⍵}¨⊂html</code>
<code> [9]       urls←'href="'∘{{⍵↑⍨¯1+⍵⍳'"'}⍵↓⍨(¯1+≢⍺)+1⍳⍨⍺⍷⍵}¨anchors</code>
<code> [10]      b←(urls⍳urls)=⍳≢urls  ⍝ For dropping doubles</code>
<code> [11]      (anchors urls)←b∘/¨anchors urls</code>
<code> [12]      linkTexts←{⍵↓⍨⍵⍳'&gt;'}¨anchors</code>
<code> [13]      linkTexts←(,¨'&lt;&gt;')⎕R'\&amp;amp;pointybracket_open;' '\&amp;amp;pointybracket_close;'⊣linkTexts</code>
<code> [14]      linkTexts←ns.parms{0 ProcessInlineMarkUp_ ⍵ ⍺}¨linkTexts</code>
<code> [15]      md←CreateMarkdownFromUrlAndLinkText urls linkTexts</code>
<code> [16]      md←'' '---' ''('**',ns.parms.reportLinksCaption,'**')'',md,''</code>
<code> [17]      ns2←Init''md</code>
<code> [18]      ns2←Process ns2</code>
<code> [19]      html2←InjectLinkTextIntoReportLink ns2.html linkTexts</code>
<code> [20]      ns.html,←(⊂'&lt;div id="external_link_report" class="print_only"&gt;'),html2,(⊂'&lt;/div&gt;')</code>
<code> [21]      ns</code>
<code> [22]  }</code>
</div>
<code class="header" id="listing_209">#.MarkAPL.MarkAPL.ScanForPara &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  noOf←{dontCheckForBlockQuote}ScanForPara ns</code>
<code> [1]  ⍝ `noOf` : Number of lines, if any), the next paragraph will comprise.</code>
<code> [2]   dontCheckForBlockQuote←{0&lt;⎕NC ⍵:⍎⍵ ⋄ 0}'dontCheckForBlockQuote'</code>
<code> [3]   :If 1≠noOf←+/∧\0=ns.emptyLines                                                          ⍝ How many lines until next empty line?</code>
<code> [4]   :AndIf 1≠noOf←noOf⌊¯1+⊃'='IotaSetextHeader noOf↑¨ns.(withoutBlanks markdown emptyLines) ⍝ Header (= syntax)</code>
<code> [5]   :AndIf 1≠noOf←noOf⌊¯1+⊃'-'IotaSetextHeader noOf↑¨ns.(withoutBlanks markdown emptyLines) ⍝ Header (- syntax)</code>
<code> [6]   :AndIf 1≠noOf←+/∧\~(noOf↑⊃¨ns.leadingChars)∊'|#='                                       ⍝ header, tables?</code>
<code> [7]   :AndIf 1≠noOf←+/∧\~(noOf↑⊃¨ns.leadingChars)∊'|#='                                       ⍝ HTML header, tables?</code>
<code> [8]   :AndIf 1≠noOf←+/∧\~{⊃⍴'^\s{0,3}[-+\*]\s'⎕S 0⊣⍵}¨noOf↑ns.markdown                        ⍝ bulleted list</code>
<code> [9]   :AndIf 1≠noOf←+/∧\~{⊃⍴'^\s{0,3}[0-9]{1,9}[.)] '⎕S 0⊣⍵}¨noOf↑ns.markdown                 ⍝ Ordered lists?</code>
<code> [10]  :AndIf 1≠noOf←+/∧\~{∨/({⍵⍴⍨3⌊≢⍵}⍵~' ')∘≡¨'***' '---' '___'}¨noOf↑ns.markdown            ⍝ Horizontal rulers?</code>
<code> [11]  :AndIf 1≠noOf←+/∧\~'```'∘{⍺≡(≢⍺)↑⍵}¨noOf↑ns.markdown                                    ⍝ Code block (``` syntax)</code>
<code> [12]  :AndIf 1≠noOf←+/∧\~'~~~'∘{⍺≡(≢⍺)↑⍵}¨noOf↑ns.markdown                                    ⍝ Code block (~~~ syntax)</code>
<code> [13]  :AndIf 1≠noOf←+/∧\'&lt;&lt;subtoc&gt;&gt;'∘≢¨⎕C noOf↑ns.markdown                                    ⍝ Sub TOCs</code>
<code> [14]  :AndIf 1≠noOf←+/∧\{0=≢'&lt;pre\b[^&gt;]*&gt;' '&lt;style\b[^&gt;]*&gt;' '&lt;script\b[^&gt;]*&gt;'⎕S 0⊣⍵}¨noOf↑ns.leadingChars               ⍝</code>
<code> [15]  :AndIf ~dontCheckForBlockQuote</code>
<code> [16]      noOf←+/∧\~(noOf↑⊃¨ns.leadingChars)∊'|&gt;#='                                           ⍝ Blockquote (&gt;) MUST be the last check!</code>
<code> [17]  :EndIf</code>
</div>
<code class="header" id="listing_210">#.MarkAPL.MarkAPL.ScanMarkdown &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  ns←ScanMarkdown ns</code>
<code> [1]   ∆LastLineWasEmpty←0</code>
<code> [2]   ns.topOfDocument←1</code>
<code> [3]   :Repeat</code>
<code> [4]       :If 0≠≢'^⍎⍎[#_A-Za-z∆⍙].*⍎⍎$'⎕S 0⍠('Greedy' 0)⊣⊃ns.markdown ⍝  Does the line call an embedded function but nothing else?</code>
<code> [5]       :AndIf 3=⎕NC{⍵↑⍨¯1+⌊/⍵⍳'⍎ '''}2↓⊃ns.markdown</code>
<code> [6]           (html isHtmlBlock)←ns ProcessFunctionCalls⊃ns.markdown</code>
<code> [7]       :AndIf 0≠≢html</code>
<code> [8]           :If 0=isHtmlBlock</code>
<code> [9]               :If {~'&lt;'∊⍵:1 ⋄ (⊂'&gt; '~⍨⍵↑⍨⌊/⍵⍳'&gt; ')∊¯1↓¨HtmlBlockTags}html</code>
<code> [10]                  html←'&lt;p&gt;'∘,¨(,⊆html),¨⊂'&lt;/p&gt;'</code>
<code> [11]              :EndIf</code>
<code> [12]          :EndIf</code>
<code> [13]          ns.html,←,⊆html</code>
<code> [14]          ns←Drop ns</code>
<code> [15]      :Else</code>
<code> [16]          :If ProcessEmeddedHTML ns</code>
<code> [17]              :If ⊃ns.emptyLines</code>
<code> [18]                   ⍝ ns.noOf←+/∧\ns.emptyLines  ⍝ No! Don't do this: it breaks the logic</code>
<code> [19]                  ns←Drop ns</code>
<code> [20]                  ∆LastLineWasEmpty←1</code>
<code> [21]              :Else</code>
<code> [22]                  :If 0=ProcessSubTOC ns</code>
<code> [23]                  :AndIf 0=ProcessFootnoteDefs ns</code>
<code> [24]                  :AndIf 0=ProcessAbbreviationDefs ns</code>
<code> [25]                  :AndIf 0=ProcessDataDefs ns</code>
<code> [26]                  :AndIf 0=ProcessReferenceLinks ns</code>
<code> [27]                  :AndIf 0=ProcessCodeBlock ns</code>
<code> [28]                  :AndIf 0=ProcessHeaders ns</code>
<code> [29]                  :AndIf 0=RemoveLampLines ns</code>
<code> [30]                  :AndIf 0=ProcessBlockQuotes ns</code>
<code> [31]                  :AndIf 0=ProcessTable ns</code>
<code> [32]                  :AndIf 0=ProcessHorizontalRulers ns</code>
<code> [33]                  :AndIf 0=ProcessLists ns</code>
<code> [34]                  :AndIf 0=ProcessDefinitionLists ns</code>
<code> [35]                  :AndIf 0=ProcessCheckBoxes ns</code>
<code> [36]                  :AndIf 0=ProcessMarkAPLExtensions ns</code>
<code> [37]                      ∆LastLineWasEmpty ProcessParagraph ns      ⍝ This must be the last one!</code>
<code> [38]                      ∆LastLineWasEmpty←0</code>
<code> [39]                  :EndIf</code>
<code> [40]              :EndIf</code>
<code> [41]          :Else</code>
<code> [42]              :If ⊃ns.emptyLines</code>
<code> [43]                  ns.noOf←1</code>
<code> [44]                  ns←Drop ns</code>
<code> [45]                  ∆LastLineWasEmpty←1</code>
<code> [46]              :EndIf</code>
<code> [47]          :EndIf</code>
<code> [48]      :EndIf</code>
<code> [49]      ns.topOfDocument←0</code>
<code> [50]  :Until 0=≢ns.leadingChars</code>
<code> [51]  :If 0≠≢ns.html</code>
<code> [52]      ns.html←{'&amp;#96;'⎕R'`'⊣⍵}⊣,¨ns.html</code>
<code> [53]  :EndIf</code>
<code> [54]  ns.html[⍸ns.html∧.=¨' ']←⊂''</code>
<code> [55] ⍝Done</code>
</div>
<code class="header" id="listing_211">#.MarkAPL.MarkAPL.SmartQuotes &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  SmartQuotes←{</code>
<code> [1]  ⍝ Exchange pairs of double quotes ←→ “„ but in DE, AT and CH ←→ „“.</code>
<code> [2]  ⍝ See also SmartTypography for similar stuff.</code>
<code> [3]  ⍝ This function does not check ns.syntaxSugar: that's up to the caller.</code>
<code> [4]       ⍺←'en'                             ⍝ Default language is English.</code>
<code> [5]       lang←⍺</code>
<code> [6]       html←⍵</code>
<code> [7]       bbt←'`[^`].*?`'                    ⍝ Between back-ticks (= code)</code>
<code> [8]       cdq←'"".+?""'                      ⍝ Catch what is enclosed between two pairs (that is four of them!) of double quotes</code>
<code> [9]       cim←'!\[[^\)].*?\){.*?}'           ⍝ Catch image with special attributes</code>
<code> [10]      cl1←'\[\]\([^)]*.?\)'              ⍝ Catch simple link</code>
<code> [11]      cl2←'\[[^]]*.?\]\([^)]*.?\)'       ⍝ Catch simple link</code>
<code> [12]      ced←'\\"'                          ⍝ Catch escaped double quote</code>
<code> [13]      ctag←'&lt;[^&gt;]*?&gt;'                    ⍝ Catch opening HTML tag</code>
<code> [14]      cpb←'&amp;amp;pointybracket_open([^&amp;]*.?)&amp;amp;pointybracket_close' ⍝ Catch pointy brackets</code>
<code> [15]      me←'\0'</code>
<code> [16]      quotes1←'"(.*?)"'</code>
<code> [17]      quotes2←(1+(⊂lang)∊'de' 'at' 'ch')⊃'“\1”' '„\1“'</code>
<code> [18]      cpb cl1 cl2 cim bbt cdq ctag ced quotes1 ⎕R((7⍴⊂me),'"'quotes2)⍠('Mode' 'D')('DotAll' 1)⊣html</code>
<code> [19]  }</code>
</div>
<code class="header" id="listing_212">#.MarkAPL.MarkAPL.SmartStuff &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> SmartStuff←{</code>
<code> [1]      parms←⍺</code>
<code> [2]      buff←SmartTypography ⍵</code>
<code> [3]      parms.lang SmartQuotes buff</code>
<code> [4]  }</code>
</div>
<code class="header" id="listing_213">#.MarkAPL.MarkAPL.SmartTypography &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  html_←SmartTypography html</code>
<code> [1]  ⍝ Does all the smart stuff except double + single quote handling; see `SmartQuotes` for that.</code>
<code> [2]  ⍝ This function does not check ns.syntaxSugar: that's up to the caller.</code>
<code> [3]   cb←'(^ {0,3}[~`]{3,}).*\1'                                                         ⍝ Code blocks (anything between `~~~` and three back ticks.</code>
<code> [4]   bbt←'`[^`].*?`'                                                                    ⍝ Between back-ticks (= code)</code>
<code> [5]   ignore←'&lt;!--[^-]+--&gt;'cb bbt</code>
<code> [6]   html_←(ignore,⊂'---')⎕R(,¨((≢ignore)⍴⊂'\0'),'—')⍠('Mode' 'D')('DotAll' 1)⊣html     ⍝ em dash</code>
<code> [7]   html_←(ignore,⊂'--')⎕R(,¨((≢ignore)⍴⊂'\0'),'–')⍠('Mode' 'D')('DotAll' 1)⊣html_     ⍝ en dash</code>
<code> [8]   html_←(ignore,⊂'\.\.\.')⎕R(,¨((≢ignore)⍴'&amp;'),'…')⍠('Mode' 'D')('DotAll' 1)⊣html_   ⍝ Ellipses</code>
<code> [9]   html_←(ignore,⊂'&lt;&lt;')⎕R(,¨((≢ignore)⍴'&amp;'),'«')⍠('Mode' 'D')('DotAll' 1)⊣html_       ⍝ Chevron</code>
<code> [10]  html_←(ignore,⊂'&gt;&gt;')⎕R(,¨((≢ignore)⍴'&amp;'),'»')⍠('Mode' 'D')('DotAll' 1)⊣html_       ⍝ Chevron</code>
<code> [11]  html_←(ignore,'\B\(c\)\B' '\B\(tm\)\B' '\B\(C\)\B' '\B\(TM\)\B')⎕R(,¨((≢ignore)⍴'&amp;'),'©' '™' '©' '™')⊣html_ ⍝ Copyright and Trademark</code>
<code> [12]  html_←(ignore,⊂'\B\&amp;lt;==&amp;gt;\B')⎕R(,¨((≢ignore)⍴'&amp;'),'↔')⊣html_                   ⍝ Left-and-right arrow</code>
<code> [13]  html_←(ignore,⊂'\B\&amp;lt;==\B')⎕R(,¨((≢ignore)⍴'&amp;'),'←')⊣html_                       ⍝ Left arrow</code>
<code> [14]  html_←(ignore,⊂'\B\==&amp;gt;\B')⎕R(,¨((≢ignore)⍴'&amp;'),'→')⊣html_                       ⍝ Right arrow</code>
<code> [15] ⍝Done</code>
</div>
<code class="header" id="listing_214">#.MarkAPL.MarkAPL.SplitTableRowButMaskCode &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  SplitTableRowButMaskCode←{</code>
<code> [1]   ⍝  'First' 'Second' ←→ SplitTableRowButMaskCode 'First',(⎕UCS 13 10),'Second'</code>
<code> [2]   ⍝ (,¨'1' '2' '3') ←→ '.' SplitTableRowButMaskCode '1.2.3'</code>
<code> [3]   ⍝ But:</code>
<code> [4]   ⍝ 'Code' '`{{⍵/⍨2=+⌿0=⍵∘.|⍵}⍳⍵}`' '' ←→ '|' SplitTableRowButMaskCode '|Code | `{{⍵/⍨2=+⌿0=⍵∘.|⍵}⍳⍵}` |</code>
<code> [5]       ⎕ML←⎕IO←1</code>
<code> [6]       txt←A.DLB A.DTB ⍵</code>
<code> [7]       txt←(('|'≠⊃txt)/'|'),txt</code>
<code> [8]       txt,←{'|'/⍨('|'≠1↑1↓⍵)∧'\|'≢⊃⍵}¯2⌽txt</code>
<code> [9]       txt←{⍵,'`|'}⍣(1=2|+/txt='`')⊣txt           ⍝ Add trailing tick and pipe in case of odd number of ticks</code>
<code> [10]      mask←~GetMaskForCode txt</code>
<code> [11]      bool←mask\'|'=mask/txt</code>
<code> [12]      bool[1~⍨⍸bool]←'\'≠txt[¯1+1~⍨⍸bool]</code>
<code> [13]      r←1↓¨¯1↓bool⊂txt</code>
<code> [14]      {0=+/b←'\|'⍷w←⍵:w ⋄ (~b)/w}¨r</code>
<code> [15]  }</code>
</div>
<code class="header" id="listing_215">#.MarkAPL.MarkAPL.Tag &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Tag←{</code>
<code> [1]      ⍺←'p'</code>
<code> [2]      '&lt;',⍺,'&gt;',⍵,'&lt;/',({⍵↑⍨¯1+⍵⍳' '},⍺),'&gt;'</code>
<code> [3]  }</code>
</div>
<code class="header" id="listing_216">#.MarkAPL.MarkAPL.TagMustStartWith &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←TagMustStartWith</code>
<code> [1]  r←⎕A,'abcdefghijklmnopqrstuvwxyz'</code>
</div>
<code class="header" id="listing_217">#.MarkAPL.MarkAPL.Version &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> r←Version</code>
<code> [1] ⍝ See also `History`</code>
<code> [2]  r←'MarkAPL' '12.0.0+246' '2022-11-29'</code>
</div>
<code class="header" id="listing_218">#.MarkAPL.MarkAPL.WhereAreCodeBlocks &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code>  bool←WhereAreCodeBlocks md</code>
<code> [1]   md←{⍵↓⍨3⌊+/∧\' '=⍵}¨md</code>
<code> [2]   b1←'~'IsFence¨md</code>
<code> [3]   b2←'`'IsFence¨md</code>
<code> [4]   :If 0=+/b1+b2                     ⍝ No code blocks at all: done!</code>
<code> [5]       bool←(≢md)⍴0</code>
<code> [6]   :Else</code>
<code> [7]       :If &gt;/b1 b2⍳¨1</code>
<code> [8]           (b2 b1)←b1 b2</code>
<code> [9]       :EndIf</code>
<code> [10]      b1←Between b1</code>
<code> [11]      (b1/b2)←0</code>
<code> [12]      b2←Between b2</code>
<code> [13]      bool←b1∨b2</code>
<code> [14]  :EndIf</code>
</div>
<code class="header" id="listing_219">#.MarkAPL.MarkAPL.API.CompressCSS &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompressCSS←{##.CompressCSS ⍵}</code>
</div>
<code class="header" id="listing_220">#.MarkAPL.MarkAPL.API.ConvertMarkdownFile &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ConvertMarkdownFile←{⍺←⊢ ⋄ 1:shy←⍺ ##.ConvertMarkdownFile ⍵}</code>
</div>
<code class="header" id="listing_221">#.MarkAPL.MarkAPL.API.Execute &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Execute←{##.Execute ⍵}</code>
</div>
<code class="header" id="listing_222">#.MarkAPL.MarkAPL.API.Help &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Help←{⍺←⊢ ⋄ 1:shy←⍺ ##.Help ⍵}</code>
</div>
<code class="header" id="listing_223">#.MarkAPL.MarkAPL.API.Init &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Init←{##.Init ⍵}</code>
</div>
<code class="header" id="listing_224">#.MarkAPL.MarkAPL.API.MakeHTML_Doc &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MakeHTML_Doc←{⍺←⊢ ⋄ ⍺ ##.MakeHTML_Doc ⍵}</code>
</div>
<code class="header" id="listing_225">#.MarkAPL.MarkAPL.API.Markdown2HTML &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Markdown2HTML←{⍺←⊢ ⋄ 1:shy←⍺ ##.Markdown2HTML ⍵}</code>
</div>
<code class="header" id="listing_226">#.MarkAPL.MarkAPL.API.Matrix2MarkdownList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Matrix2MarkdownList←{##.Matrix2MarkdownList ⍵}</code>
</div>
<code class="header" id="listing_227">#.MarkAPL.MarkAPL.API.Matrix2MarkdownTable &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Matrix2MarkdownTable←{⍺←⊢ ⋄ ⍺ ##.Matrix2MarkdownTable ⍵}</code>
</div>
<code class="header" id="listing_228">#.MarkAPL.MarkAPL.API.Process &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Process←{##.Process ⍵}</code>
</div>
<code class="header" id="listing_229">#.MarkAPL.MarkAPL.API.Reference &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Reference←{⍺←⊢ ⋄ 1:shy←⍺ ##.Reference ⍵}</code>
</div>
<code class="header" id="listing_230">#.MarkAPL.MarkAPL.MarkAPL.CompressCSS &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> CompressCSS←{##.CompressCSS ⍵}</code>
</div>
<code class="header" id="listing_231">#.MarkAPL.MarkAPL.MarkAPL.ConvertMarkdownFile &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> ConvertMarkdownFile←{⍺←⊢ ⋄ 1:shy←⍺ ##.ConvertMarkdownFile ⍵}</code>
</div>
<code class="header" id="listing_232">#.MarkAPL.MarkAPL.MarkAPL.Execute &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Execute←{##.Execute ⍵}</code>
</div>
<code class="header" id="listing_233">#.MarkAPL.MarkAPL.MarkAPL.Help &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Help←{⍺←⊢ ⋄ 1:shy←⍺ ##.Help ⍵}</code>
</div>
<code class="header" id="listing_234">#.MarkAPL.MarkAPL.MarkAPL.Init &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Init←{##.Init ⍵}</code>
</div>
<code class="header" id="listing_235">#.MarkAPL.MarkAPL.MarkAPL.MakeHTML_Doc &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> MakeHTML_Doc←{⍺←⊢ ⋄ ⍺ ##.MakeHTML_Doc ⍵}</code>
</div>
<code class="header" id="listing_236">#.MarkAPL.MarkAPL.MarkAPL.Markdown2HTML &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Markdown2HTML←{⍺←⊢ ⋄ 1:shy←⍺ ##.Markdown2HTML ⍵}</code>
</div>
<code class="header" id="listing_237">#.MarkAPL.MarkAPL.MarkAPL.Matrix2MarkdownList &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Matrix2MarkdownList←{##.Matrix2MarkdownList ⍵}</code>
</div>
<code class="header" id="listing_238">#.MarkAPL.MarkAPL.MarkAPL.Matrix2MarkdownTable &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Matrix2MarkdownTable←{⍺←⊢ ⋄ ⍺ ##.Matrix2MarkdownTable ⍵}</code>
</div>
<code class="header" id="listing_239">#.MarkAPL.MarkAPL.MarkAPL.Process &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Process←{##.Process ⍵}</code>
</div>
<code class="header" id="listing_240">#.MarkAPL.MarkAPL.MarkAPL.Reference &mdash; 100%<a class="float-right no-print no-underline top-links" href="#top" title="Go to the top of the document">&#8607;</a><a  class="float-right no-print no-underline top-links" href="#partly-covered" title="Go to the beginning of 'Partly-covered'">↑</a></code>
<div class="code-block"><code> Reference←{⍺←⊢ ⋄ 1:shy←⍺ ##.Reference ⍵}</code>
</div>
<div id="footer">
<hr>
<p>Created by "CodeCoverage" version 0.10.3+52 from 2023-06-23</p>
</div>

</body>
</html>
